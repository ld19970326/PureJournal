<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <meta name="theme-color" content="#fdf6ec"> 
    <title>Pure Journal</title>

<link rel="apple-touch-icon" href="icon.png"> 

<link rel="icon" type="image/png" href="icon.png">



<script src="react.production.min.js"></script>
<script src="react-dom.production.min.js"></script>
<script src="babel.min.js"></script>
<script src="tailwindcss.js"></script>
<script src="lucide.js"></script>



    <script id="app-data">
        // åˆå§‹æ¼”ç¤ºæ•°æ®
        window.APP_DATA = [
            {"id":1,"title":"Summer Vibe","style":"c-beach","date":"2023","images":[], "stickers": [], "layout": {}},
            {"id":2,"title":"My Cat","style":"c-paws","date":"2024","images":[], "stickers": [], "layout": {}}
        ];
    </script>

    <style>
    
            /* === ğŸŸ¢ OFFLINE FONTS SETUP (ç¦»çº¿å­—ä½“é…ç½®) === */
    
    /* 1. UI ä¸»å­—ä½“ (Nunito) */
    @font-face {
        font-family: 'Nunito';
        src: url('./fonts/Nunito-Bold.ttf') format('truetype');
        font-weight: normal; /* å¼ºåˆ¶è®¾ä¸º normalï¼Œç®€åŒ–å¼•ç”¨ */
        font-style: normal;
    }

    /* 2. è´´çº¸å­—ä½“: é»˜è®¤å¯çˆ± (Caveat) */
    @font-face {
        font-family: 'Caveat';
        src: url('./fonts/Caveat-Bold.ttf') format('truetype');
        font-weight: normal; 
    }

    /* 3. è´´çº¸å­—ä½“: ä¸­æ–‡å¿«ä¹ä½“ (ZCOOL KuaiLe) */
    @font-face {
        font-family: 'ZCOOL KuaiLe';
        src: url('./fonts/ZCOOLKuaiLe-Regular.ttf') format('truetype');
        font-weight: normal;
    }

    /* 4. è´´çº¸å­—ä½“: é©¬å…‹ç¬” (Patrick Hand) */
    @font-face {
        font-family: 'Patrick Hand';
        src: url('./fonts/PatrickHand-Regular.ttf') format('truetype');
        font-weight: normal;
    }

    /* 5. è´´çº¸å­—ä½“: ä¼˜é›…è¿ç¬” (Dancing Script) */
    @font-face {
        font-family: 'Dancing Script';
        src: url('./fonts/DancingScript-Bold.ttf') format('truetype');
        font-weight: normal;
    }

    /* 6. è´´çº¸å­—ä½“: éšæ„æ¶‚é¸¦ (Indie Flower) */
    @font-face {
        font-family: 'Indie Flower';
        src: url('./fonts/IndieFlower-Regular.ttf') format('truetype');
        font-weight: normal;
    }

    /* 7. è´´çº¸å­—ä½“: ç²—ä½“æµ·æŠ¥ (Permanent Marker) */
    @font-face {
        font-family: 'Permanent Marker';
        src: url('./fonts/PermanentMarker-Regular.ttf') format('truetype');
        font-weight: normal;
    }

    /* 8. è´´çº¸å­—ä½“: ä¸­æ–‡æ¯›ç¬” (Ma Shan Zheng) */
    @font-face {
        font-family: 'Ma Shan Zheng';
        src: url('./fonts/MaShanZheng-Regular.ttf') format('truetype');
        font-weight: normal;
    }

    /* 9. è´´çº¸å­—ä½“: ä¸­æ–‡è¡Œè‰ (Long Cang) */
    @font-face {
        font-family: 'Long Cang';
        src: url('./fonts/LongCang-Regular.ttf') format('truetype');
        font-weight: normal;
    }
    
        /* === Global Settings === */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden;
            background-color: #fdf6ec; touch-action: none; font-family: 'Nunito', sans-serif;
            color: #5d5550; -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }
        input, textarea { -webkit-user-select: auto; user-select: auto; }
        #root { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* 3D Flip Book Core */
        .perspective-container { perspective: 2000px; }
        .transform-style-3d { transform-style: preserve-3d; transform-origin: center center; will-change: transform; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .smooth-flip { transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); } 
        .hidden-input { display: none; }

        /* Animation */
        .animate-float-gentle { animation: float-gentle 4s ease-in-out infinite; }
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes float-up { 0% { transform: translateY(0) scale(1) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) scale(0) rotate(20deg); opacity: 0; } }
        .floating-heart { position: absolute; animation: float-up 1s ease-out forwards; pointer-events: none; z-index: 50; }

        /* Shelf & Styles */
        .shelf-row { border-bottom: 12px solid #e6d0b3; box-shadow: 0 8px 6px -4px rgba(0, 0, 0, 0.1); position: relative; }
        .shelf-row::after { content: ''; position: absolute; bottom: -12px; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.4); pointer-events: none; }
        .gold-text { font-family: "Georgia", serif; font-style: italic; font-weight: bold; background: linear-gradient(45deg, #c5a059 0%, #e6c888 25%, #fcf6ba 50%, #b38728 75%, #aa771c 100%); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0px 1px 1px rgba(0,0,0,0.1); }
        .poem-text { font-family: "Georgia", serif; font-style: italic; line-height: 2.2; text-align: center; }
        /* ä½¿ç”¨æ›´åœ†æ¶¦å¯çˆ±çš„ 'ZCOOL KuaiLe' */
        .font-cute { font-family: 'Caveat', 'ZCOOL KuaiLe', cursive; line-height: 1.5; }
        /* åŸæ¥æ˜¯ url("https://...") */
/* ç°åœ¨æ¢æˆï¼š */
.cover-texture-bg { 
    background-image: url("cream-paper.png"); 
    background-blend-mode: multiply; 
    pointer-events: none; 
}
        .cute-pattern-bg { background-color: #fdf6ec; background-image: radial-gradient(#ffcfd2 2px, transparent 2px), radial-gradient(#bde0fe 2px, transparent 2px); background-size: 30px 30px; background-position: 0 0, 15px 15px; }
        .book-suspension-shadow { filter: drop-shadow(0 25px 25px rgba(50, 50, 93, 0.15)) drop-shadow(0 8px 10px rgba(0, 0, 0, 0.1)); }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .cursor-pen { cursor: crosshair; } .cursor-move-all { cursor: move; }
        
/* =========================================
   ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šCSS æ ·å¼æ›´æ–° (åˆ é™¤æ—§çš„ï¼Œæ·»åŠ æ–°çš„)
   ========================================= */

/* --- âœ‚ï¸ æ›´æ–°å½¢çŠ¶ (Shapes) --- */

/* [ä¿æŒä¸å˜] æ’•è£‚èƒ¶å¸¦ - å·¦æ’•è£‚ */
.shape-tape-l { clip-path: polygon(100% 0, 100% 100%, 5% 100%, 0 92%, 5% 84%, 0 76%, 5% 68%, 0 60%, 5% 52%, 0 44%, 5% 36%, 0 28%, 5% 20%, 0 12%, 5% 4%, 0 0); padding-left: 10px; }
/* [ä¿æŒä¸å˜] æ’•è£‚èƒ¶å¸¦ - å³æ’•è£‚ */
.shape-tape-r { clip-path: polygon(0 0, 95% 0, 100% 8%, 95% 16%, 100% 24%, 95% 32%, 100% 40%, 95% 48%, 100% 56%, 95% 64%, 100% 72%, 95% 80%, 100% 88%, 95% 96%, 100% 100%, 0 100%); padding-right: 10px; }
/* [ä¿æŒä¸å˜] æ˜Ÿæ˜Ÿ */
.shape-star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); display: flex; align-items: center; justify-content: center; }
/* [ä¿æŒä¸å˜] å¿ƒå½¢ */
.shape-heart { clip-path: polygon(50% 88%, 36% 77%, 20% 63%, 10% 49%, 6% 36%, 10% 21%, 23% 11%, 38% 11%, 50% 22%, 62% 11%, 77% 11%, 90% 21%, 94% 36%, 90% 49%, 80% 63%, 64% 77%); display: flex; align-items: center; justify-content: center; }
/* [ä¿æŒä¸å˜] å¯¹è¯æ°”æ³¡ */
.shape-bubble { border-radius: 20px; clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 75% 85%, 75% 100%, 50% 85%, 0% 85%); padding-bottom: 25px; }

/* âœ¨ [æ–°å¢] èŠ±ç“£å½¢çŠ¶ (Petal) - æ¨¡æ‹Ÿä¸€ç‰‡å•ç‹¬çš„èŠ±ç“£ */
.shape-petal {
    clip-path: polygon(50% 0%, 85% 25%, 100% 60%, 80% 90%, 50% 100%, 20% 90%, 0% 60%, 15% 25%);
    display: flex; align-items: center; justify-content: center;
}

/* --- ğŸ—‘ï¸ å·²åˆ é™¤ Cloud --- */

/* --- ğŸ¨ æ›´æ–°å›¾æ¡ˆ (Patterns) --- */

/* [ä¿æŒä¸å˜] è‹æ ¼å…°æ ¼çº¹ */
.pattern-plaid { background-color: transparent; background-image: repeating-linear-gradient(45deg, rgba(200, 0, 0, 0.15) 25px, transparent 25px, transparent 27px, rgba(200, 0, 0, 0.15) 27px, rgba(200, 0, 0, 0.15) 29px), repeating-linear-gradient(135deg, rgba(200, 0, 0, 0.15) 25px, transparent 25px, transparent 27px, rgba(200, 0, 0, 0.15) 27px, rgba(200, 0, 0, 0.15) 29px); }
/* [ä¿æŒä¸å˜] ç«–æ¡çº¹ */
.pattern-v-stripe { background-image: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.08) 10px, rgba(0,0,0,0.08) 11px); }
/* [ä¿æŒä¸å˜] æ¨ªæ¡çº¹ */
.pattern-h-stripe { background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(0,0,0,0.1) 19px, rgba(0,0,0,0.1) 20px); background-size: 100% 20px; }
/* [ä¿æŒä¸å˜] To-Do List */
.pattern-todo { background-image: radial-gradient(circle at 15px 12px, transparent 3px, rgba(0,0,0,0.3) 4px, transparent 5px), linear-gradient(to right, transparent 30px, rgba(0,0,0,0.1) 30px, rgba(0,0,0,0.1) 100%); background-size: 100% 24px; background-position: 0 0; }

/* ğŸ—‘ï¸ å·²åˆ é™¤ Timeline */

/* âœ¨ [æ–°å¢] æ—¥å¼ä¿¡çº¸ (Japanese Letter) - ä¼ ç»Ÿçš„ç«–æ’çº¢çº¿ */
.pattern-japanese {
    /* ä½¿ç”¨ä»å³å‘å·¦çš„çº¢è‰²ç»†ç«–çº¿ */
    background-image: repeating-linear-gradient(to left, transparent, transparent 29px, rgba(220, 20, 60, 0.15) 29px, rgba(220, 20, 60, 0.15) 30px);
    border-right: 2px solid rgba(220, 20, 60, 0.2); /* å³ä¾§åŠ ç²—è¾¹æ¡† */
}





        /* --- 30 Cover Patterns (CSS Gradients) --- */
        /* Solids & Basics */
        .c-blush { background-color: #ffcfd2; } .c-sky { background-color: #bde0fe; } .c-mint { background-color: #d8e2dc; } .c-lilac { background-color: #e0c3fc; } .c-cream { background-color: #ffecb3; } .c-peach { background-color: #ffdab9; }
        /* Dots & Spots */
        .c-dot-pink { background-color: #ffcfd2; background-image: radial-gradient(rgba(255,255,255,0.6) 20%, transparent 20%); background-size: 20px 20px; }
        .c-dot-blue { background-color: #bde0fe; background-image: radial-gradient(#a2d2ff 15%, transparent 15%); background-size: 15px 15px; }
        .c-dot-mint { background-color: #d8e2dc; background-image: radial-gradient(#b8c2bc 15%, transparent 15%), radial-gradient(rgba(255,255,255,0.5) 15%, transparent 15%); background-size: 20px 20px; background-position: 0 0, 10px 10px; }
        .c-confetti { background-color: #fffadd; background-image: radial-gradient(#ff6b6b 10%, transparent 10%), radial-gradient(#feca57 10%, transparent 10%), radial-gradient(#48dbfb 10%, transparent 10%); background-size: 30px 30px; background-position: 0 0, 10px 10px, 20px 20px; }
        .c-bubbles { background-color: #e0c3fc; background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.4) 10%, transparent 20%), radial-gradient(circle at 0% 0%, rgba(255,255,255,0.4) 10%, transparent 20%); background-size: 40px 40px; }
        .c-speckle { background-color: #ffecb3; background-image: radial-gradient(#e5c07b 1px, transparent 1px), radial-gradient(#e5c07b 1px, transparent 1px); background-size: 10px 10px; background-position: 0 0, 5px 5px; }
        /* Stripes & Lines */
        .c-stripe-blue { background-color: #bde0fe; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.4) 10px, rgba(255,255,255,0.4) 20px); }
        .c-stripe-pink { background-color: #ffcfd2; background-image: repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(255,255,255,0.5) 10px, rgba(255,255,255,0.5) 15px); }
        .c-gingham-green { background-color: #d8e2dc; background-image: linear-gradient(90deg, rgba(255,255,255,0.3) 50%, transparent 50%), linear-gradient(rgba(255,255,255,0.3) 50%, transparent 50%); background-size: 40px 40px; }
        .c-plaid-warm { background-color: #ffdab9; background-image: repeating-linear-gradient(0deg, rgba(255,183,178,0.3) 0px, rgba(255,183,178,0.3) 2px, transparent 2px, transparent 20px), repeating-linear-gradient(90deg, rgba(255,183,178,0.3) 0px, rgba(255,183,178,0.3) 2px, transparent 2px, transparent 20px); }
        .c-waves { background-color: #a2d2ff; opacity: 0.8; background-image: repeating-radial-gradient( circle at 0 0, transparent 0, #a2d2ff 10px ), repeating-linear-gradient( #bde0fe, #bde0fe ); }
        .c-rays { background-color: #fff5d7; background-image: repeating-conic-gradient(from 0deg, #fff5d7 0deg 15deg, #ffe082 15deg 30deg); opacity: 0.8; }
        /* Cute Shapes */
        .c-paws { background-color: #f8c8c0; background-image: radial-gradient(circle at 50% 60%, #fff 8%, transparent 8%), radial-gradient(circle at 35% 45%, #fff 4%, transparent 4%), radial-gradient(circle at 50% 40%, #fff 4%, transparent 4%), radial-gradient(circle at 65% 45%, #fff 4%, transparent 4%); background-size: 60px 60px; }
        .c-clouds { background-color: #a2d2ff; background-image: radial-gradient(circle at 50% 50%, #ffffff 15%, transparent 20%), radial-gradient(circle at 60% 60%, #ffffff 15%, transparent 20%); background-size: 80px 60px; }
        .c-stars { background-color: #2c2c54; background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 5px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 3px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 4px); background-size: 35px 35px, 20px 20px, 15px 15px; background-position: 0 0, 10px 10px, 5px 5px; }
        .c-hearts { background-color: #ffebf0; background-image: radial-gradient(circle at 60% 60%, #ff9aa2 10%, transparent 10%), radial-gradient(circle at 40% 60%, #ff9aa2 10%, transparent 10%); background-size: 30px 30px; background-position: 0 0, 15px 15px; }
        .c-bows { background-color: #e0b0ff; background-image: linear-gradient(45deg, transparent 45%, #d0a3fc 45%, #d0a3fc 55%, transparent 55%), linear-gradient(-45deg, transparent 45%, #d0a3fc 45%, #d0a3fc 55%, transparent 55%); background-size: 30px 30px; }
        .c-flowers { background-color: #d4f0f0; background-image: radial-gradient(circle at center, #ffecb3 20%, transparent 20%), radial-gradient(circle at 50% 30%, #ffffff 15%, transparent 15%), radial-gradient(circle at 70% 50%, #ffffff 15%, transparent 15%), radial-gradient(circle at 50% 70%, #ffffff 15%, transparent 15%), radial-gradient(circle at 30% 50%, #ffffff 15%, transparent 15%); background-size: 40px 40px; }
        /* Textures & Vibes */
        .c-watercolor { background: linear-gradient(135deg, #ffcfd2 0%, #bde0fe 50%, #e0c3fc 100%); opacity: 0.9; }
        .c-terrazzo { background-color: #fffaf0; background-image: radial-gradient(#ff9aa2 10%, transparent 10%), radial-gradient(#a2d2ff 10%, transparent 10%), radial-gradient(#e0c3fc 10%, transparent 10%); background-size: 40px 40px; background-position: 0 0, 20px 10px, 10px 30px; }
        .c-grid-milk { background-color: #fffdf9; background-image: linear-gradient(rgba(200,200,200,0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(200,200,200,0.2) 1px, transparent 1px); background-size: 20px 20px; }
        .c-picnic { background-color: #ffcccb; background-image: repeating-linear-gradient(45deg, transparent 0, transparent 10px, rgba(255,255,255,0.4) 10px, rgba(255,255,255,0.4) 20px), repeating-linear-gradient(-45deg, transparent 0, transparent 10px, rgba(255,255,255,0.4) 10px, rgba(255,255,255,0.4) 20px); }
        .c-beach { background: linear-gradient(to bottom, #bde0fe 0%, #fff 50%, #ffe082 100%); }
        .c-night-sky { background: linear-gradient(to bottom, #2c3e50, #3498db); position: relative; overflow: hidden; }
        .c-night-sky::before { content: ''; position: absolute; width: 2px; height: 2px; background: white; box-shadow: 10px 10px 0 white, 30px 50px 0 white, 70px 20px 0 white, 100px 80px 0 white; border-radius: 50%; }

        /* Patterns (for Stickers) */
      /* --- æ–°å¢ï¼šSticker Textures (æè´¨) --- */
        /* 1. å¹³æ»‘ (é»˜è®¤) */
        .t-plain { } 
        
        /* 3. çš±çº¸ (Crumpled) - å¼ºçƒˆçš„ç«‹ä½“æŠ˜ç—• */
        .t-crumpled {
            /* ä½¿ç”¨é«˜å¯¹æ¯”åº¦çš„æ¹æµæ»¤é•œæ¨¡æ‹ŸæŠ˜ç—• */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='crumple'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.03' numOctaves='5' result='noise'/%3E%3CfeDiffuseLighting in='noise' lighting-color='white' surfaceScale='2'%3E%3CfeDistantLight azimuth='45' elevation='60'/%3E%3C/feDiffuseLighting%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23crumple)' opacity='0.4'/%3E%3C/svg%3E");
            background-blend-mode: multiply;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.1); /* å¢åŠ ä¸€ç‚¹å¤–éƒ¨é˜´å½±å¢åŠ åšåº¦æ„Ÿ */
        }

        /* 4. ç²—å†ç”Ÿçº¸ (Kraft) - æ˜æ˜¾çš„æ·±è‰²çº¤ç»´é¢—ç²’ */
        .t-kraft {
            /* å™ªç‚¹é¢‘ç‡è°ƒé«˜ï¼Œä¸é€æ˜åº¦è°ƒé«˜ï¼Œå½¢æˆç²—ç³™æ„Ÿ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.35'/%3E%3C/svg%3E");
            background-blend-mode: overlay; /* ä½¿ç”¨ overlay è®©é¢œè‰²æ›´æ·±é‚ƒ */
            border: 1px dashed rgba(0,0,0,0.1); /* åŠ ä¸ªè™šçº¿è¾¹æ¡†å¢å¼ºåšæ—§æ„Ÿ */
        }

        /* 5. ç²—çº¹æ°´å½©çº¸ (Watercolor) - æ›¿ä»£ Holo */
        .t-watercolor {
            /* ä½¿ç”¨ä½é¢‘æ¹æµ + æ¼«åå°„å…‰ç…§ï¼Œæ¨¡æ‹Ÿçº¸å¼ è¡¨é¢çš„å‡¹å‡¸èµ·ä¼ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='waterpaper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.05' numOctaves='5' result='noise'/%3E%3CfeDiffuseLighting in='noise' lighting-color='white' surfaceScale='1.5'%3E%3CfeDistantLight azimuth='45' elevation='50'/%3E%3C/feDiffuseLighting%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23waterpaper)' opacity='0.5'/%3E%3C/svg%3E");
            background-blend-mode: multiply;
            /* å¢åŠ ä¸€ç‚¹å†…é˜´å½±ï¼Œè®©çº¸å¼ çœ‹èµ·æ¥æ›´æœ‰åšåº¦ */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); 
        }
/* âœ¨ [æ–°å¢] åŠé€æ˜æè´¨ (Translucent) */
/* æ³¨æ„ï¼šè¿™ä¸ªç±»åä¸»è¦ç”¨äº JS åˆ¤æ–­ï¼Œå®é™…æ ·å¼åœ¨ JS ä¸­åŠ¨æ€åº”ç”¨ */
.t-translucent { 
    /* è¿™é‡Œä¸éœ€è¦å†™ opacityï¼Œå› ä¸ºæˆ‘ä»¬è¦æŠŠå®ƒåº”ç”¨åœ¨çˆ¶å®¹å™¨ä¸Šï¼Œè€Œä¸æ˜¯è¦†ç›–å±‚ä¸Š */
}
        /* 3. å…‰é¢/èƒ¶å¸¦ (Glossy/Tape) - æ¨¡æ‹Ÿåå…‰å’Œé€æ˜æ„Ÿ */
        .t-glossy { 
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6), inset 0 -1px 0 rgba(0,0,0,0.05);
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.02) 100%);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .bg-blush { background-color: #ffcfd2; } .bg-sky { background-color: #bde0fe; } .bg-mint { background-color: #d8e2dc; } .bg-lilac { background-color: #e0c3fc; } .bg-cream { background-color: #ffecb3; }
        .sticker-pattern-stripe { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.3) 0, rgba(255,255,255,0.3) 5px, transparent 5px, transparent 10px); }
        .sticker-pattern-dot { background-image: radial-gradient(rgba(255,255,255,0.5) 20%, transparent 20%); background-size: 10px 10px; }
        .sticker-pattern-grid { background-image: linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px); background-size: 15px 15px; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #5d5550; cursor: pointer; margin-top: -6px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e6d0b3; border-radius: 3px; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    // --- å†…ç½®æ•°æ®åº“å·¥å…· ---
        // --- ğŸŸ¢ æ–°ä»£ç  (è¯·å¤åˆ¶ç²˜è´´è¿™ä¸€æ•´å—) ---
    const DB_NAME = 'pure-journal-db';
    const STORE_ALBUMS = 'albums';
    const STORE_IMAGES = 'images'; // æ–°å¢ï¼šä¸“é—¨å­˜å›¾ç‰‡çš„ä»“åº“
    // --- ğŸŸ¢ dbUtils (åŒ…å«è´´çº¸å¤„ç†çš„ç»ˆæç‰ˆ) ---
    const dbUtils = {
        // ... (å‰é¢çš„ openDB, get, set, saveAllAlbums, getAllAlbums, saveImage, getImage ä¿æŒä¸å˜ï¼Œä¸ç”¨åŠ¨) ...
        // å¦‚æœä½ ä¸ºäº†çœäº‹ï¼Œå¯ä»¥ç›´æ¥ä¿ç•™å‰é¢çš„ä»£ç ï¼ŒåªæŠŠä¸‹é¢ä¸¤ä¸ªå‡½æ•°è¦†ç›–æ‰æ—§çš„
        
        openDB: () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_ALBUMS)) { db.createObjectStore(STORE_ALBUMS); }
                    if (!db.objectStoreNames.contains(STORE_IMAGES)) { db.createObjectStore(STORE_IMAGES); }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },
        get: async (key) => { if (key === 'main-data') return dbUtils.getAllAlbums(); return []; },
        set: async (key, value) => { if (key === 'main-data') return dbUtils.saveAllAlbums(value); },
        saveAllAlbums: async (albums) => {
            const db = await dbUtils.openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_ALBUMS, 'readwrite');
                tx.objectStore(STORE_ALBUMS).put(albums, 'main-data');
                tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error);
            });
        },
        getAllAlbums: async () => {
            const db = await dbUtils.openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_ALBUMS, 'readonly');
                const req = tx.objectStore(STORE_ALBUMS).get('main-data');
                req.onsuccess = () => resolve(req.result || []); req.onerror = () => reject(req.error);
            });
        },
        saveImage: async (blob) => {
            const db = await dbUtils.openDB();
            const id = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_IMAGES, 'readwrite');
                tx.objectStore(STORE_IMAGES).put(blob, id);
                tx.oncomplete = () => resolve(id); tx.onerror = () => reject(tx.error);
            });
        },
        getImage: async (id) => {
            const db = await dbUtils.openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_IMAGES, 'readonly');
                const req = tx.objectStore(STORE_IMAGES).get(id);
                req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error);
            });
        },

        // --- âœ¨ é‡ç‚¹ä¿®æ”¹åŒºåŸŸï¼šå¯¼å‡ºé€»è¾‘ (å¤„ç† images + stickers) ---
        createBackupData: async () => {
            const albums = await dbUtils.getAllAlbums();
            if (!albums || albums.length === 0) return [];

            // è¾…åŠ©å‡½æ•°ï¼šæŠŠå•ä¸ª ID è¿˜åŸæˆ Base64
            const resolveIdToBase64 = async (val) => {
                if (typeof val === 'string' && val.startsWith('img_')) {
                    try {
                        const blob = await dbUtils.getImage(val);
                        if (!blob) return val;
                        return await new Promise((r) => {
                            const reader = new FileReader();
                            reader.onloadend = () => r(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) { return val; }
                }
                return val;
            };

            const fullAlbums = await Promise.all(albums.map(async (album) => {
                // 1. å¤„ç†ç›¸å†Œä¸»å›¾
                const resolvedImages = await Promise.all((album.images || []).map(resolveIdToBase64));
                
                // 2. âœ¨ å¤„ç†è´´çº¸ (æ‰¾å‡ºé‡Œé¢çš„è‡ªå®šä¹‰ç…§ç‰‡è´´çº¸)
                const resolvedStickers = await Promise.all((album.stickers || []).map(async (sticker) => {
                    // å¦‚æœè´´çº¸æœ‰ src å±æ€§ (è¯´æ˜æ˜¯ç…§ç‰‡è´´çº¸)ï¼Œå°è¯•è¿˜åŸ
                    if (sticker.src) {
                        const newSrc = await resolveIdToBase64(sticker.src);
                        return { ...sticker, src: newSrc };
                    }
                    return sticker; // æ™®é€šæ–‡å­—/å›¾æ ‡è´´çº¸ç›´æ¥è¿”å›
                }));

                return { ...album, images: resolvedImages, stickers: resolvedStickers };
            }));
            return fullAlbums;
        },

        // --- âœ¨ é‡ç‚¹ä¿®æ”¹åŒºåŸŸï¼šå¯¼å…¥é€»è¾‘ (å¤„ç† images + stickers) ---
        restoreBackupData: async (jsonAlbums) => {
            // è¾…åŠ©å‡½æ•°ï¼šæŠŠ Base64 å­˜æˆ Blob å¹¶è¿”å› ID
            const restoreBase64ToId = async (val) => {
                if (typeof val === 'string' && val.startsWith('data:image')) {
                    try {
                        const res = await fetch(val);
                        const blob = await res.blob();
                        return await dbUtils.saveImage(blob);
                    } catch (e) { return val; }
                }
                return val;
            };

            const processedAlbums = [];
            for (const album of jsonAlbums) {
                // 1. å¤„ç†ç›¸å†Œä¸»å›¾
                const newImageIds = [];
                for (const img of (album.images || [])) {
                    newImageIds.push(await restoreBase64ToId(img));
                }

                // 2. âœ¨ å¤„ç†è´´çº¸
                const newStickers = [];
                for (const sticker of (album.stickers || [])) {
                    if (sticker.src) {
                        const newSrc = await restoreBase64ToId(sticker.src);
                        newStickers.push({ ...sticker, src: newSrc });
                    } else {
                        newStickers.push(sticker);
                    }
                }

                processedAlbums.push({ ...album, images: newImageIds, stickers: newStickers });
            }
            
            await dbUtils.saveAllAlbums(processedAlbums);
            return processedAlbums;
        }
    };

// --- ğŸŸ¢ ä¿®å¤åçš„å›¾ç‰‡å‹ç¼©å·¥å…·å‡½æ•° ---
const compressImage = (file, quality = 0.7, maxWidth = 1024) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                // è®¡ç®—æ–°çš„å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                let w = img.width;
                let h = img.height;
                if (w > maxWidth) {
                    h = Math.round((h * maxWidth) / w);
                    w = maxWidth;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                
                // âœ¨ å…³é”®ä¿®å¤ç‚¹ï¼šåˆ¤æ–­åŸå›¾æ˜¯å¦æ˜¯ PNG
                const isPNG = file.type === 'image/png';

                // å¦‚æœæ˜¯ PNGï¼Œä¸ç”¨å¡«åº•è‰²ï¼Œç›´æ¥ç”»ï¼ˆä¿ç•™é€æ˜ï¼‰
                // å¦‚æœä¸æ˜¯ PNG (æ¯”å¦‚ JPG)ï¼Œå¯ä»¥é“ºä¸€å±‚ç™½è‰²åº•ï¼Œé˜²æ­¢æŸäº›å¥‡æ€ªçš„é€æ˜å›¾å˜é»‘
                if (!isPNG) {
                     ctx.fillStyle = '#ffffff'; 
                     ctx.fillRect(0, 0, w, h);
                }

                ctx.drawImage(img, 0, 0, w, h);
                
                // âœ¨ å…³é”®ä¿®å¤ç‚¹ï¼šè¾“å‡ºæ ¼å¼åŠ¨æ€åŒ–
                // PNG æ ¼å¼ä¸æ”¯æŒ quality å‚æ•°ï¼ˆå®ƒæ˜¯æ— æŸçš„ï¼‰ï¼Œä½†èƒ½ä¿ç•™é€æ˜åº¦
                // JPEG æ ¼å¼æ”¯æŒ quality å‚æ•°ï¼Œä½†ä¼šä¸¢å¤±é€æ˜åº¦
                const outputType = isPNG ? 'image/png' : 'image/jpeg';
                
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, outputType, quality);
            };
        };
    });
};



    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€è¯·æŠŠ performCrop ç²˜è´´åœ¨è¿™é‡Œã€‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡
    
    // --- âœ‚ï¸ æ ¸å¿ƒè£åˆ‡ç®—æ³• (æ”¯æŒçŸ©å½¢å’Œè‡ªç”±è·¯å¾„) ---
    const performCrop = async (sourceUrl, cropData) => {
        // cropData ç»“æ„: { type: 'rect' | 'lasso', points: [{x,y}, ...] } 
        // æ³¨æ„ï¼špoints é‡Œçš„ x, y å¿…é¡»æ˜¯ 0-1 ä¹‹é—´çš„ç™¾åˆ†æ¯”åæ ‡
        
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = sourceUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const w = img.naturalWidth;
                const h = img.naturalHeight;
                
                // 1. è®¡ç®—è£åˆ‡åŒºåŸŸçš„åŒ…å›´ç›’ (Bounding Box)
                let minX = w, minY = h, maxX = 0, maxY = 0;
                const pixelPoints = cropData.points.map(p => ({ x: p.x * w, y: p.y * h }));

                if (cropData.type === 'rect') {
                    const p1 = pixelPoints[0];
                    const p2 = pixelPoints[pixelPoints.length - 1]; 
                    minX = Math.min(p1.x, p2.x);
                    maxX = Math.max(p1.x, p2.x);
                    minY = Math.min(p1.y, p2.y);
                    maxY = Math.max(p1.y, p2.y);
                } else {
                    pixelPoints.forEach(p => {
                        if (p.x < minX) minX = p.x;
                        if (p.x > maxX) maxX = p.x;
                        if (p.y < minY) minY = p.y;
                        if (p.y > maxY) maxY = p.y;
                    });
                }

                const width = maxX - minX;
                const height = maxY - minY;
                
                if (width <= 0 || height <= 0) {
                    resolve(null); return; 
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // 2. ç»˜åˆ¶è£åˆ‡è·¯å¾„
                ctx.beginPath();
                if (cropData.type === 'rect') {
                    ctx.rect(0, 0, width, height);
                } else {
                    ctx.moveTo(pixelPoints[0].x - minX, pixelPoints[0].y - minY);
                    for (let i = 1; i < pixelPoints.length; i++) {
                        ctx.lineTo(pixelPoints[i].x - minX, pixelPoints[i].y - minY);
                    }
                    ctx.closePath();
                }
                
                // 3. Clip + Draw
                ctx.clip(); 
                ctx.drawImage(img, -minX, -minY);

                // 4. å¯¼å‡º
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/png'); 
            };
            img.onerror = reject;
        });
    };

    // ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘† ã€ç²˜è´´ç»“æŸã€‘ ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†




    // Icons
    const Icons = {
        ImagePlus: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/><line x1="21" x2="21" y1="2" y2="8"/><line x1="18" x2="24" y1="5" y2="5"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
        Plus: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        Trash2: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
        Book: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
        ArrowLeft: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
        Save: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        Maximize: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>,
        Minimize: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>,
        Check: ({size=24, className, strokeWidth=2.5}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
        Library: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></svg>,
    Sun: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>,
    
    CloudRain: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>,
    
    Smile: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>,
        Feather: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="15"/></svg>,
        Pen: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
        X: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        Eraser: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>,
        StickyNote: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/></svg>,
        // æ›¿æ¢ä¸ºæ›´æ¸…æ™°çš„ Highlighter å›¾æ ‡
        Highlighter: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>,
        Sparkles: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>,
        RotateCw: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 12"/><path d="M21 3v9h-9"/></svg>,
        Ban: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m4.93 4.93 14.14 14.14"/></svg>,
        Move: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></svg>,
        Refresh: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>,
        Focus: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg>,
        CornerRightDown: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="10 15 15 20 20 15"/><path d="M4 4h7a4 4 0 0 1 4 4v12"/></svg>,
        Settings: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            // ... åŸæœ‰çš„å›¾æ ‡ (Bookmark, Flag ç­‰) ...
    
    // âœ¨âœ¨âœ¨ åœ¨è¿™é‡Œæ’å…¥ 10 ä¸ªæ–°å›¾æ ‡ âœ¨âœ¨âœ¨
    
    // 1. ç›¸æœº (è®°å½•ç¬é—´)
    Camera: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
    
    // 2. éŸ³ä¹ (BGM/å¿ƒæƒ…)
    Music: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
    
    // 3. é£æœº (æ—…è¡Œ/å‡ºå‘)
    Plane: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12h20"/><path d="M13 2l9 10-9 10"/><path d="M13 2v20"/></svg>, // è¿™é‡Œç”¨ç®€å•çš„çº¸é£æœºæ ·å¼æ›´é€‚åˆæ‰‹è´¦
    PaperPlane: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,

    // 4. æˆ¿å­ (å®…å®¶/æ¸©é¦¨)
    Home: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,

    // 5. ç¤¼ç‰© (æƒŠå–œ/çºªå¿µæ—¥)
    Gift: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,

    // 6. æœˆäº® (æ™šå®‰/æ·±å¤œ)
    Moon: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,



    // 8. ç¯æ³¡ (çµæ„Ÿ/æƒ³æ³•)
    Lightbulb: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.7-5.7-6-5.7s-6 2.5-6 5.7c0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,



    // 10. æ ‘å¶ (è‡ªç„¶/é€æ°”)
    Leaf: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>,


    // 2. è›‹ç³• (Cake) - ç”Ÿæ—¥/çºªå¿µæ—¥å¿…å¤‡
    Cake: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v2"/><path d="M12 8v2"/><path d="M17 8v2"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg>,


    // 5. çš‡å†  (Crown) - ä»Šå¤©æ˜¯å°å…¬ä¸»/ä¸»è§’
    Crown: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,



        Coffee: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></svg>,
        Heart: ({size=24, className, fill}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill || "none"} stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
        Copy: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
        StarFull: ({size=24, className, fill="currentColor"}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            // ... åŸæœ‰çš„å›¾æ ‡ ...
    Bookmark: ({size=24, className, fill="none"}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>,
    Flag: ({size=24, className, fill="none"}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
        // ... åœ¨ Icons å¯¹è±¡ä¸­æ·»åŠ  ...
    Scissors: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>,
    SquareDashed: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 3a2 2 0 0 0-2 2"/><path d="M19 3a2 2 0 0 1 2 2"/><path d="M21 19a2 2 0 0 1-2 2"/><path d="M5 21a2 2 0 0 1-2-2"/><path d="M9 3h1"/><path d="M14 3h1"/><path d="M3 9v1"/><path d="M3 14v1"/><path d="M21 9v1"/><path d="M21 14v1"/><path d="M9 21h1"/><path d="M14 21h1"/></svg>,
    Lasso: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 22a5 5 0 0 1-2-4"/><path d="M3.3 14A5 5 0 0 1 9 6h6a5 5 0 0 1 5 5v5a5 5 0 0 1-5 5h-1"/><path d="M5 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
    Undo: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
    };
    
        // --- ğŸŸ¢ æ–°å¢ç»„ä»¶ï¼šAsyncImage (ç”¨äºè‡ªåŠ¨åŠ è½½æ•°æ®åº“å›¾ç‰‡) ---
    function AsyncImage({ src, className, style, alt, ...props }) {
        const [imageUrl, setImageUrl] = useState(null);
        
        useEffect(() => {
            let objectUrl = null;
            let isActive = true;

            const loadImage = async () => {
                if (!src) { if (isActive) setImageUrl(null); return; }

                // å…¼å®¹æ—§ Base64 æˆ–ç½‘ç»œå›¾
                if (src.startsWith('data:') || src.startsWith('http') || src.startsWith('blob:')) {
                    if (isActive) setImageUrl(src);
                    return;
                }

                // è¯»æ•°æ®åº“
                try {
                    const blob = await dbUtils.getImage(src);
                    if (blob && isActive) {
                        objectUrl = URL.createObjectURL(blob);
                        setImageUrl(objectUrl);
                    } else {
                        // è¯»ä¸åˆ°å›¾ï¼Œä¿æŒ nullï¼Œä¸æ˜¾ç¤ºè£‚å¼€å›¾æ ‡
                        if (isActive) setImageUrl(null);
                    }
                } catch (e) {
                    if (isActive) setImageUrl(null);
                }
            };

            loadImage();

            return () => {
                isActive = false;
                if (objectUrl) URL.revokeObjectURL(objectUrl);
            };
        }, [src]);

        // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šå¦‚æœ imageUrl æ˜¯ç©ºçš„ï¼Œç»å¯¹ä¸æ¸²æŸ“ img æ ‡ç­¾
        // è¿™æ ·å°±æ°¸è¿œä¸ä¼šå‡ºç°é‚£ä¸ªä¸‘é™‹çš„è£‚å¼€å›¾æ ‡äº†
        if (!imageUrl) {
            return <div className={`bg-gray-50/20 ${className}`} style={style} />;
        }

        return <img src={imageUrl} className={className} style={style} alt={alt} {...props} />;
    }



    
     // ğŸŸ¢ ä¿®æ”¹ï¼š17è‰²è‰²ç¯æ•°ç»„ (çº¢->ç´«->ç²‰ å¾ªç¯)
    const BOOKMARK_COLORS = [
        '#ff7675', // 1. Coral Red
        '#d63031', // 2. Brick Red
        '#e17055', // 3. Burnt Orange
        '#fab1a0', // 4. Light Orange
        '#fdcb6e', // 5. Mustard
        '#ffeaa7', // 6. Cream Yellow
        '#badc58', // 7. Lime Green
        '#55efc4', // 8. Mint Green
        '#00b894', // 9. Teal
        '#81ecec', // 10. Cyan
        '#74b9ff', // 11. Sky Blue
        '#0984e3', // 12. Deep Blue
        '#6c5ce7', // 13. Purple
        '#a29bfe', // 14. Lilac
        '#fd79a8', // 15. Pink
        '#e84393', // 16. Deep Pink
        '#636e72', // 17. Greyish Blue (End tone)
    ];

// ğŸŸ¢ æ–°å¢ï¼šå­—ä½“é€‰é¡¹é…ç½®
    const FONT_OPTIONS = [
        { id: 'default', name: 'Default', family: "'Caveat', 'ZCOOL KuaiLe', cursive" }, // é»˜è®¤å¯çˆ±ä½“
        { id: 'marker', name: 'Marker', family: "'Patrick Hand', cursive" }, // è®°å·ç¬”
        { id: 'elegant', name: 'Elegant', family: "'Dancing Script', cursive" }, // ä¼˜é›…è¿ç¬”
        { id: 'messy', name: 'Messy', family: "'Indie Flower', cursive" }, // éšæ„æ¶‚é¸¦
        { id: 'bold', name: 'Bold', family: "'Permanent Marker', cursive" }, // ç²—ä½“æµ·æŠ¥
        { id: 'brush', name: 'Brush', family: "'Ma Shan Zheng', cursive" }, // ä¸­æ–‡æ¯›ç¬”
        { id: 'cursive', name: 'Flow', family: "'Long Cang', cursive" }, // ä¸­æ–‡è¡Œè‰
    ];
    // Config & Helpers
    // ğŸŸ¢ 1. æ–‡å­—é¢œè‰²ï¼šç™½/é»‘/ç° -> çº¢æ©™é»„ç»¿è“ç´« -> æ£•
    const TEXT_COLORS = [
        '#ffffff', // çº¯ç™½
        '#2D3436', // ç‚­é»‘
        '#7f8c8d', // ç°è‰²
        '#b12a22', // æ·±çº¢
        '#4e020f', // å‹ƒè‰®ç¬¬çº¢
        '#FFD1DC', // ç²‰çº¢
        '#ed6d2b', // æ©˜è‰²
        '#db9a6a', // æè‰²
        '#f1c40f', // æ˜é»„
        '#F8EFBA', // å¥¶æ²¹é»„
        '#c3d94e', // å«©ç»¿
        '#617240', // æ©„æ¦„ç»¿
        '#27ae60', // ç¿ ç»¿
        '#E0F7FA', // æ·¡é’
        '#00b9e7', // å¤©è“
        '#304d68', // æ·±è“
        '#8e44ad', // ç´«è‰²
        '#8f6d55', // å’–å•¡è‰²
    ];

    // ğŸŸ¢ 2. è´´çº¸èƒŒæ™¯è‰²ï¼šé€æ˜/ç™½/ç±³ -> çº¢ç²‰ -> é»„ -> ç»¿ -> è“ -> ç´« -> ç°/æ£•
    const STICKER_BG_COLORS = [
        'transparent', // é€æ˜
        '#FFFFFF', // çº¯ç™½
        '#fdf6ec', // ç±³ç™½
        '#e94830', // æœ±çº¢
        '#b25348', // ç –çº¢
        '#FF9AA2', // æµ…ç²‰
        '#f7c9dd', // æ¨±èŠ±ç²‰
        '#fac03d', // å§œé»„
        '#d8b569', // èŠ¥æœ«é»„
        '#F6EAC2', // è›‹å£³é»„
        '#e5e757', // æŸ æª¬é»„
        '#e2f0cb', // æµ…ç»¿
        '#c2d95c', // é’æŸ 
        '#769d41', // è‰ç»¿
        '#6b7453', // å†›ç»¿
        '#53a8a2', // è“ç»¿
        '#8dd0d6', // æ¹–è“
        '#4c5a68', // ç°è“
        '#E0BBE4', // é¦™èŠ‹ç´«
        '#995d94', // è‘¡è„ç´«
        '#8E8892', // ç°ç´«
        '#dfe6e9', // é“¶ç°
        '#d7c9a5', // å¡å…¶
        '#746155', // æ·±è¤
    ];

    // ğŸŸ¢ 3. æ¶‚é¸¦ç¬”é¢œè‰²ï¼šç™½/ç°/é»‘ -> çº¢æ©™é»„ç»¿è“ç´« -> æ£•
    const DOODLE_COLORS = [
        '#ffffff', // çº¯ç™½
        '#2D3436', // ç‚­é»‘
        '#7f8c8d', // ç°è‰²
        '#b12a22', // æ·±çº¢
        '#4e020f', // å‹ƒè‰®ç¬¬çº¢
        '#FFD1DC', // ç²‰çº¢
        '#ed6d2b', // æ©˜è‰²
        '#db9a6a', // æè‰²
        '#f1c40f', // æ˜é»„
        '#F8EFBA', // å¥¶æ²¹é»„
        '#c3d94e', // å«©ç»¿
        '#617240', // æ©„æ¦„ç»¿
        '#27ae60', // ç¿ ç»¿
        '#E0F7FA', // æ·¡é’
        '#00b9e7', // å¤©è“
        '#304d68', // æ·±è“
        '#8e44ad', // ç´«è‰²
        '#8f6d55', // å’–å•¡è‰²
    ];

        // ğŸŸ¢ æ›´æ–°åçš„å½¢çŠ¶åˆ—è¡¨
    // =========================================
    // ğŸŸ¢ ç¬¬äºŒæ­¥ï¼šJavaScript æ•°æ®é…ç½®æ›´æ–°
    // =========================================

    // æ›´æ–°åçš„å½¢çŠ¶åˆ—è¡¨ (åˆ é™¤ Cloud, å¢åŠ  Petal)
    const SHAPE_OPTIONS = [
        {id:'rect', name:'Rect', cssClass:'rounded-sm'},
        {id:'circle', name:'Circle', cssClass:'rounded-full aspect-square flex items-center justify-center'},
        {id:'tape-l', name:'Tape L', cssClass:'shape-tape-l'},
        {id:'tape-r', name:'Tape R', cssClass:'shape-tape-r'},
        {id:'star', name:'Star', cssClass:'shape-star aspect-square flex items-center justify-center'},
        {id:'bubble', name:'Bubble', cssClass:'shape-bubble'},   ];

    // æ›´æ–°åçš„å›¾æ¡ˆåˆ—è¡¨ (åˆ é™¤ Timeline, å¢åŠ  Japanese)
    const PATTERN_OPTIONS = [
        {id:'none', name:'Solid'},
        {id:'plaid', name:'Plaid', cssClass:'pattern-plaid'},
        {id:'v-stripe', name:'V-Line', cssClass:'pattern-v-stripe'},
        {id:'h-stripe', name:'Line', cssClass:'pattern-h-stripe'},
        // âœ¨ æ–°å¢æ—¥å¼ä¿¡çº¸ï¼Œåˆ é™¤æ—¶é—´è½´
        {id:'japanese', name:'J-Letter', cssClass:'pattern-japanese'}, 
        {id:'todo', name:'To-Do', cssClass:'pattern-todo'},
        {id:'dot', name:'Dot', cssClass:'sticker-pattern-dot'},
        {id:'grid', name:'Grid', cssClass:'sticker-pattern-grid'},
        {id:'stripe', name:'Diag', cssClass:'sticker-pattern-stripe'},
    ];

    // æ›´æ–°åçš„æè´¨åˆ—è¡¨ (å¢åŠ  Translucent)
    const TEXTURE_OPTIONS = [
        { id: 'plain', name: 'Plain', cssClass: 't-plain' },
        { id: 'glossy', name: 'Glossy', cssClass: 't-glossy' },
        { id: 'crumpled', name: 'Crinkle', cssClass: 't-crumpled' },
        { id: 'kraft', name: 'Kraft', cssClass: 't-kraft' },
        { id: 'watercolor', name: 'Paper', cssClass: 't-watercolor' },
        // âœ¨ æ–°å¢åŠé€æ˜
        { id: 'translucent', name: 'Sheer', cssClass: 't-translucent' } 
    ];

  // --- æ–°å¢ï¼šå°ç« æ¨¡æ¿ ---
// --- æ–°å¢ï¼šå°ç« æ¨¡æ¿ (å·²ä¿®å¤å­—æ®µååŒ¹é…é—®é¢˜) ---
const STAMP_TEMPLATES = [
    // 1. æ—¥æœŸæˆ³ (è‡ªåŠ¨è·å–ä»Šæ—¥)
    { 
        id: 'stamp-date', 
        name: 'Date', 
        type: 'stamp',
        color: '#d63031', 
        // ğŸ”§ ä¿®å¤1ï¼šå°† content æ”¹ä¸º text
        text: () => new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase(), 
        // ğŸ”§ ä¿®å¤2ï¼šå°† subText æ”¹ä¸º sub
        sub: 'CHECKED',
        shape: 'rect-double' 
    },
    // 2. å¤å¤é‚®æˆ³
    { 
        id: 'stamp-post', 
        name: 'Post', 
        type: 'stamp', 
        color: '#2d3436', 
        // ğŸ”§ ä¿®å¤1ï¼šå°† content æ”¹ä¸º text
        text: 'POST OFFICE', 
        // ğŸ”§ ä¿®å¤2ï¼šå°† subText æ”¹ä¸º sub
        sub: new Date().getFullYear(),
        shape: 'circle-wave' 
    },
    // --- ğŸ”’ æ–°å¢ 4ï¼šç»å¯†æ¡£æ¡ˆ (Top Secret) ---
    { 
        id: 'stamp-secret', 
        name: 'Secret', 
        type: 'stamp', 
        color: '#c0392b', 
        text: 'TOP SECRET', 
        sub: 'EYES ONLY',
        shape: 'rect-solid' 
    },


    // 2. è›‹ç³• (Birthday) - åº†ç¥æ—¶åˆ»
    { 
        id: 'stamp-cake', 
        name: 'B-Day', 
        type: 'stamp', 
        color: '#fd79a8', // ç³–æœç²‰
        icon: 'Cake', 
        shape: 'rect-double' 
    },



    // 4. çš‡å†  (Princess) - ä¸»è§’å…‰ç¯
    { 
        id: 'stamp-crown', 
        name: 'Queen', 
        type: 'stamp', 
        color: '#fab1a0', // èœœæ¡ƒè‰²
        icon: 'Crown', 
        shape: 'circle-wave' 
    },

  // --- ğŸŒŸ æ–°å¢ 1ï¼šè¯„åˆ†/æœ€ä½³ (Top Pick) ---
    { 
        id: 'stamp-star', 
        name: 'Best', 
        type: 'stamp', 
        color: '#f39c12', // å§œé»„è‰²
        icon: 'StarFull', 
        shape: 'circle-double' // æ³¨æ„ï¼šä¸‹é¢éœ€è¦å¾®è°ƒ renderStampContent æ”¯æŒåŒçº¿åœ†
    },
    // 1. ğŸ“· Snapshot (å½±åƒ)
    { 
        id: 'stamp-camera', 
        name: 'Snap', 
        type: 'stamp', 
        color: '#2d3436', 
        icon: 'Camera', 
        shape: 'rect-double' // ç›¸æœºé€‚åˆæ–¹å½¢æ¡†
    },

    // 2. âœˆï¸ Travel (æ—…è¡Œ)
    { 
        id: 'stamp-travel', 
        name: 'Trip', 
        type: 'stamp', 
        color: '#0984e3', // èˆªç©ºè“
        icon: 'PaperPlane', 
        shape: 'circle-dashed' // è™šçº¿åœ†æ¨¡æ‹Ÿèˆªçº¿
    },

    // 3. ğŸµ Mood/BGM (éŸ³ä¹)
    { 
        id: 'stamp-music', 
        name: 'Vibe', 
        type: 'stamp', 
        color: '#6c5ce7', // æ¢¦å¹»ç´«
        icon: 'Music', 
        shape: 'circle-wave' // æ³¢æµªåœ†æ¨¡æ‹Ÿå£°æ³¢
    },

    // 4. ğŸ  Stay Home (å®…å®¶)
    { 
        id: 'stamp-home', 
        name: 'Home', 
        type: 'stamp', 
        color: '#e17055', // æ¸©æš–ç –çº¢
        icon: 'Home', 
        shape: 'circle-simple' 
    },

    // 5. ğŸ Celebrate (åº†ç¥)
    { 
        id: 'stamp-gift', 
        name: 'Gift', 
        type: 'stamp', 
        color: '#e84393', // ç¤¼ç‰©ç²‰
        icon: 'Gift', 
        shape: 'rect-double' 
    },

    // 6. ğŸŒ™ Good Night (æ™šå®‰)
    { 
        id: 'stamp-moon', 
        name: 'Night', 
        type: 'stamp', 
        color: '#2c3e50', // æ·±å¤œè“
        icon: 'Moon', 
        shape: 'circle-simple' 
    },



    // 8. ğŸ’¡ Idea (çµæ„Ÿ)
    { 
        id: 'stamp-idea', 
        name: 'Idea', 
        type: 'stamp', 
        color: '#fdcb6e', // ç¯æ³¡äº®é»„
        icon: 'Lightbulb', 
        shape: 'circle-dashed' 
    },



    // 10. ğŸƒ Relax (è‡ªç„¶/æ”¾æ¾)
    { 
        id: 'stamp-leaf', 
        name: 'Chill', 
        type: 'stamp', 
        color: '#27ae60', // æ¤ç‰©ç»¿
        icon: 'Leaf', 
        shape: 'circle-wave' 
    },
    // --- âœ… æ–°å¢ 2ï¼šå®Œæˆ/å·²é˜… (Done) ---
    { 
        id: 'stamp-check', 
        name: 'Done', 
        type: 'stamp', 
        color: '#27ae60', // å¤å¤ç»¿
        icon: 'Check', 
        shape: 'rect-double' 
    },


    // 3. å¿ƒæƒ…æˆ³ (æ— éœ€ä¿®æ”¹ï¼Œå®ƒä»¬ä½¿ç”¨ icon)
    { id: 'stamp-mood-happy', name: 'Happy', type: 'stamp', color: '#e17055', icon: 'Smile', shape: 'circle-simple' },
    { id: 'stamp-mood-chill', name: 'Chill', type: 'stamp', color: '#0984e3', icon: 'Coffee', shape: 'circle-simple' },
    { id: 'stamp-mood-love', name: 'Love', type: 'stamp', color: '#fd79a8', icon: 'Heart', shape: 'circle-simple' },
    
    // 4. å¤©æ°”æˆ³
    { id: 'stamp-weather-sun', name: 'Sunny', type: 'stamp', color: '#fdcb6e', icon: 'Sun', shape: 'circle-dashed' },
    { id: 'stamp-weather-rain', name: 'Rainy', type: 'stamp', color: '#74b9ff', icon: 'CloudRain', shape: 'circle-dashed' },
];
    
    // --- 30 Cover Styles (All CSS-based, no external images) ---
    const COVER_STYLES = [
        // Basics
        {id:'c-blush',name:'Blush Pink',bgClass:'c-blush',border:'border-[#ffb7b2]'},
        {id:'c-sky',name:'Cloud Blue',bgClass:'c-sky',border:'border-[#a2d2ff]'},
        {id:'c-mint',name:'Mint Fresh',bgClass:'c-mint',border:'border-[#b8c2bc]'},
        {id:'c-lilac',name:'Soft Lilac',bgClass:'c-lilac',border:'border-[#d0a3fc]'},
        {id:'c-cream',name:'Butter Cream',bgClass:'c-cream',border:'border-[#ffe082]'},
        {id:'c-peach',name:'Sweet Peach',bgClass:'c-peach',border:'border-[#ffdab9]'},
        // Dots & Spots
        {id:'c-dot-pink',name:'Pink Dots',bgClass:'c-dot-pink',border:'border-[#ffb7b2]'},
        {id:'c-dot-blue',name:'Blue Polka',bgClass:'c-dot-blue',border:'border-[#a2d2ff]'},
        {id:'c-dot-mint',name:'Mint Speckle',bgClass:'c-dot-mint',border:'border-[#b8c2bc]'},
        {id:'c-confetti',name:'Party Confetti',bgClass:'c-confetti',border:'border-[#ffe082]'},
        {id:'c-bubbles',name:'Lavender Bubbles',bgClass:'c-bubbles',border:'border-[#d0a3fc]'},
        {id:'c-speckle',name:'Gold Dust',bgClass:'c-speckle',border:'border-[#ffe082]'},
        // Stripes & Lines
        {id:'c-stripe-blue',name:'Retro Stripe Blue',bgClass:'c-stripe-blue',border:'border-[#a2d2ff]'},
        {id:'c-stripe-pink',name:'Candy Stripe',bgClass:'c-stripe-pink',border:'border-[#ffb7b2]'},
        {id:'c-gingham-green',name:'Picnic Grid',bgClass:'c-gingham-green',border:'border-[#b8c2bc]'},
        {id:'c-plaid-warm',name:'Warm Plaid',bgClass:'c-plaid-warm',border:'border-[#ffdab9]'},
        {id:'c-waves',name:'Ocean Waves',bgClass:'c-waves',border:'border-[#a2d2ff]'},
        {id:'c-rays',name:'Sunshine Rays',bgClass:'c-rays',border:'border-[#ffe082]'},
        // Cute Shapes
        {id:'c-paws',name:'Kitty Paws',bgClass:'c-paws',border:'border-[#ffb7b2]'},
        {id:'c-clouds',name:'Fluffy Clouds',bgClass:'c-clouds',border:'border-[#a2d2ff]'},
        {id:'c-stars',name:'Little Stars',bgClass:'c-stars',border:'border-[#d0a3fc]'},
        {id:'c-hearts',name:'Sweet Hearts',bgClass:'c-hearts',border:'border-[#ffb7b2]'},
        {id:'c-bows',name:'Lilac Bows',bgClass:'c-bows',border:'border-[#d0a3fc]'},
        {id:'c-flowers',name:'Daisy Garden',bgClass:'c-flowers',border:'border-[#b8c2bc]'},
        // Textures & Vibes
        {id:'c-watercolor',name:'Dreamy Watercolor',bgClass:'c-watercolor',border:'border-[#d0a3fc]'},
        {id:'c-terrazzo',name:'Pastel Terrazzo',bgClass:'c-terrazzo',border:'border-[#a2d2ff]'},
        {id:'c-grid-milk',name:'Milk Grid Paper',bgClass:'c-grid-milk',border:'border-[#b8c2bc]'},
        {id:'c-picnic',name:'Red Check',bgClass:'c-picnic',border:'border-[#ffb7b2]'},
        {id:'c-beach',name:'Summer Beach',bgClass:'c-beach',border:'border-[#ffe082]'},
        {id:'c-night-sky',name:'Starry Night',bgClass:'c-night-sky',border:'border-[#a2d2ff]'},
    ];

    const BACK_COVER_POEMS = ["Memories are timeless\ntreasures of the heart.", "Collect moments,\nnot things.", "Life is a collection\nof moments.", "The best thing about memories\nis making them.", "Every picture has\na story to tell.", "Little moments,\nbig memories.", "Hold on to the\ngood times.", "Cherish every\nmoment."];
    const convertFileToBase64 = (file) => new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result); reader.onerror = j; });

    // --- Components ---

        function ConfirmationModal({ isOpen, title, message, onConfirm, onSecondary, onCancel, confirmText = "Confirm", secondaryText, cancelText = "Cancel", isAlert = false }) {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/20 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white p-6 rounded-[32px] shadow-2xl max-w-xs w-[85%] mx-4 text-center border-4 border-[#fff1f2] transform transition-all scale-100 relative">
                    {/* å¦‚æœæ˜¯ Alert æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºå³ä¸Šè§’å…³é—­ X */}
                    {!isAlert && <button onClick={onCancel} className="absolute top-2 right-2 p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100"><Icons.X size={18} /></button>}
                    
                    <h3 className="text-xl font-bold text-gray-700 mb-3 font-serif mt-2">{title}</h3>
                    <p className="text-gray-500 mb-6 text-sm leading-relaxed font-medium">{message}</p>
                    
                    <div className="flex flex-col gap-2">
                        <button onClick={onConfirm} className="w-full py-3 rounded-2xl bg-[#ffcfd2] text-white font-bold shadow-lg shadow-pink-100 hover:brightness-95 transition-transform active:scale-95 text-sm">{confirmText}</button>
                        
                        {secondaryText && !isAlert && <button onClick={onSecondary} className="w-full py-3 rounded-2xl bg-white border-2 border-gray-100 text-gray-500 font-bold hover:bg-gray-50 transition-colors text-sm">{secondaryText}</button>}
                        
                        {/* å¦‚æœæ˜¯ Alert æ¨¡å¼ï¼Œä¸æ˜¾ç¤º Cancel æŒ‰é’® */}
                        {!isAlert && <button onClick={onCancel} className="w-full py-3 rounded-2xl bg-white border-2 border-gray-100 text-gray-500 font-bold hover:bg-gray-50 transition-colors text-sm">{cancelText}</button>}
                    </div>
                </div>
            </div>
        );
    }

    function AboutModal({ isOpen, onClose }) {
        if (!isOpen) return null;
        const [likes, setLikes] = useState(0);
        const [hearts, setHearts] = useState([]);
        const [copied, setCopied] = useState(false);
        const handleLike = (e) => {
            setLikes(p => p + 1);
            const rect = e.target.getBoundingClientRect();
            const newHearts = Array.from({ length: 8 }).map((_, i) => ({ id: Date.now() + i, x: rect.width/2 + (Math.random() - 0.5) * 60, y: rect.height/2 + (Math.random() - 0.5) * 40, color: ['#FFB7B2', '#FF9AA2', '#FFDAC1', '#E0BBE4'][Math.floor(Math.random() * 4)] }));
            setHearts(p => [...p, ...newHearts]); setTimeout(() => setHearts(p => p.filter(h => !newHearts.find(nh => nh.id === h.id))), 1000);
        };
        const copyID = () => { const t = document.createElement("textarea"); t.value = "272774332"; document.body.appendChild(t); t.select(); document.execCommand("copy"); document.body.removeChild(t); setCopied(true); setTimeout(() => setCopied(false), 2000); };
        
        return (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/30 backdrop-blur-sm animate-in fade-in duration-300 p-4">
                
                {/* ğŸŸ¢ ä¿®æ”¹ï¼šå®½åº¦é™åˆ¶ä¸º 280px (å¤§å¹…ç¼©å°)ï¼Œé«˜åº¦è‡ªé€‚åº”ä½†æœ‰ä¸Šé™ */}
                <div className="bg-[#fff0f3] w-full max-w-[280px] rounded-[24px] border-4 border-white shadow-2xl relative overflow-hidden c-dot-pink animate-pop flex flex-col max-h-[85dvh]">
                    
                    <button onClick={onClose} className="absolute top-2 right-2 p-1.5 bg-white/50 rounded-full hover:bg-white text-gray-400 hover:text-gray-600 transition-colors z-20"><Icons.X size={16} /></button>
                    
                    {/* ğŸŸ¢ ä¿®æ”¹ï¼špadding ç¼©å°è‡³ p-3ï¼Œå¼€å¯æ»šåŠ¨æ¡ä»¥å®¹çº³å®Œæ•´æ–‡å­— */}
                    <div className="bg-white/90 backdrop-blur-sm p-3 pb-6 flex flex-col items-center text-center relative z-10 m-3 rounded-[16px] shadow-sm flex-1 overflow-y-auto no-scrollbar">
                        
                        <div className="w-10 h-10 bg-gradient-to-tr from-yellow-100 to-orange-100 rounded-full flex items-center justify-center text-orange-400 mb-2 shadow-inner border-2 border-white shrink-0"><Icons.Coffee size={20} /></div>
                        
                        {/* ğŸŸ¢ æ¢å¤åŸç‰ˆæ–‡å­—ï¼Œä»…ç¼©å°å­—å· */}
                        <h3 className="font-cute text-lg font-bold text-gray-700 mb-1 shrink-0">Hello Friend!</h3>
                        <p className="font-cute text-xs text-gray-500 leading-relaxed mb-3 shrink-0">
                            ï¼ŠÂ°ËšğŸ¦à´¯ ï¼ŠğŸªÂ° <br/>
                            æ¬¢è¿æ¥åˆ°ä½ çš„ Pure Journalã€‚<br/>
                            è¿™æ¬¾æ‰‹è´¦åº”ç”¨ç½‘ç«™<br/>
                            å…¨éƒ¨ä½¿ç”¨ <span className="text-purple-500 font-bold">Gemini Pro Ai</span> åˆ¶ä½œã€‚<br/>
                            è®©æˆ‘ä»¬ä¸€èµ·æ¥è¯´Geminiä¸‡å² â‰§â–½â‰¦
                        </p>

                        <div className="my-2 text-yellow-400 opacity-80 shrink-0"><Icons.StarFull size={14} fill="currentColor" /></div>

                        <div className="bg-blue-50/80 p-2.5 rounded-xl border border-blue-100 shadow-sm mb-2 w-full text-left shrink-0">
                            <h4 className="font-cute text-xs font-bold text-blue-600 mb-1.5 flex items-center gap-1">
                                <Icons.Save size={14} /> å…³äºå­˜å‚¨çš„é­”æ³•
                            </h4>
                            {/* ğŸŸ¢ æ¢å¤åŸç‰ˆåˆ—è¡¨å†…å®¹ï¼Œä½¿ç”¨ text-[10px] æ’ç‰ˆ */}
                            <ul className="font-cute text-gray-600 space-y-1.5 text-[10px] leading-snug">
                                <li className="flex items-start gap-1">
                                    <span className="shrink-0">ğŸ„</span>
                                    <span><b>æœ¬åœ°å­˜å‚¨ï¼š</b>æ•°æ®å®‰å…¨å­˜æ”¾åœ¨ä½ è®¾å¤‡çš„æœ¬åœ°æ•°æ®åº“é‡Œï¼Œç©ºé—´æ— é™å¤§ï¼ˆçœ‹ä½ è®¾å¤‡å­˜å‚¨ä½“ç§¯ï¼‰ï¼Œæ¯«ç§’çº§è‡ªåŠ¨ä¿å­˜ã€‚</span>
                                </li>
                                <li className="flex items-start gap-1">
                                    <span className="shrink-0">ğŸ</span>
                                    <span><b>å¤‡ä»½æŒ‰é’®ï¼š</b>å¹³æ—¶ä¸ç”¨ç‚¹å®ƒï¼Œé‚£æ˜¯æ›´æ¢è®¾å¤‡â€œæ¬å®¶â€æ—¶å¯¼å‡ºæ•°æ®ç”¨çš„ã€‚</span>
                                </li>
                                 <li className="flex items-start gap-1">
                                    <span className="shrink-0">ğŸ‰</span>
                                    <span><b>ç”¨å®Œå³èµ°ï¼š</b>Appé‡Œåˆ é™¤ç›¸å†Œ=å½»åº•åº”ç”¨é‡Šæ”¾ç©ºé—´ï¼Œä¸ä¼šå½±å“ç³»ç»Ÿç›¸å†Œçš„åŸå›¾ã€‚</span>
                                </li>
                            </ul>
                        </div>

                         <div className="bg-red-50/80 p-2.5 rounded-xl border border-red-100 shadow-sm mb-4 w-full text-left shrink-0">
                             <h4 className="font-cute text-xs font-bold text-red-500 mb-1.5 flex items-center gap-1">
                                <Icons.Ban size={14} /> è¿™é‡Œçš„è§„åˆ™...
                            </h4>
                             <ul className="font-cute text-red-400 space-y-1 text-[10px] font-bold leading-snug">
                                 <li className="flex items-start gap-1"><span className="shrink-0">ğŸŒŸ</span><span>åƒä¸‡<b>ä¸è¦æ‰‹æ»‘ã€Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€</b>ï¼Œä¸ç„¶æ—¥è®°å°±éƒ½æ²¡å•¦ï¼</span></li>
                                 <li className="flex items-start gap-1"><span className="shrink-0">ğŸ’</span><span>é‡è¦å›å¿†è®°å¾—å¶å°”ç‚¹ã€Œå¤‡ä»½ã€å­˜ä¸ªæ¡£ã€‚</span></li>
                                 <li className="flex items-start gap-1"><span className="shrink-0">ğŸ’Œ</span><span>ä¸åŒè®¾å¤‡å’Œä¸åŒæµè§ˆå™¨é—´ï¼Œæ•°æ®ä¸äº’é€šã€‚</span></li>
                            </ul>
                         </div>
                        
                        <div className="mb-2 text-pink-300 opacity-80 shrink-0"><Icons.Heart size={16} fill="currentColor" /></div>

                        <div className="bg-[#ff2442]/10 p-2.5 rounded-xl border border-[#ff2442]/20 mb-4 w-full text-center relative overflow-hidden group shrink-0">
                             <div className="absolute -right-4 -top-4 text-[#ff2442]/10 rotate-12 pointer-events-none"><Icons.Heart size={60} fill="currentColor"/></div>
                             
                             <h4 className="font-cute text-sm font-bold text-[#ff2442] mb-1 relative z-10 flex items-center justify-center gap-1">
                                 âœ¨ å…³äºä½œè€… âœ¨
                             </h4>
                             <p className="font-cute text-gray-600 text-[10px] mb-2 relative z-10 leading-relaxed font-bold">
                                 è¯¥Appå®Œå…¨ç”¨çˆ±å‘ç”µ<br/>ğŸ€æ‰¿è¯ºæ°¸ä¹…å…è´¹ä½¿ç”¨ğŸ€<br/>
                                 å¦‚æœå–œæ¬¢ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å°çº¢ä¹¦ä¸»é¡µ ğŸ§¸<br/>
                                 ä½ ä»¬çš„æ”¯æŒå¯¹æˆ‘å¾ˆé‡è¦à¹ â€¢ v â€¢ à¹
                             </p>
                             
                             <div className="bg-white rounded-lg p-2 flex items-center justify-between border border-[#ff2442]/30 shadow-sm relative z-10">
                                  <div className="flex flex-col items-start pl-1">
                                      <span className="text-[8px] text-gray-400 font-bold uppercase tracking-wider">Little Red Book ID</span>
                                      <span className="font-cute text-base font-black text-[#ff2442] tracking-widest select-all">272774332</span>
                                  </div>
                                  <button onClick={copyID} className={`px-2 py-1.5 rounded-md font-bold transition-all flex items-center gap-1 ${copied ? 'bg-green-500 text-white' : 'bg-[#ff2442] text-white hover:bg-[#d91f3a] shadow-md active:scale-95'}`}>
                                      {copied ? <Icons.Check size={12}/> : <Icons.Copy size={12}/>}
                                      <span className="text-[10px]">{copied ? 'Copied!' : 'Copy'}</span>
                                  </button>
                             </div>
                        </div>

                        <button onClick={handleLike} className="relative w-full py-2.5 bg-gradient-to-r from-pink-300 to-rose-300 text-white rounded-xl font-bold shadow-lg shadow-pink-200 active:scale-95 transition-transform flex items-center justify-center gap-2 overflow-hidden group mt-1 shrink-0 text-xs"><Icons.Heart className={`transition-transform duration-300 ${likes > 0 ? 'fill-current' : ''}`} size={16} /><span>ç»™ä¸ªå°å¿ƒå¿ƒ ({likes})</span>{hearts.map(h => (<div key={h.id} className="floating-heart" style={{ left: h.x, top: h.y }}><Icons.Heart size={14} fill={h.color} className="text-transparent" /></div>))}</button>
                    </div>
                </div>
            </div>
        );
    }



function DraggableSticker({ sticker, isSelected, onSelect, onUpdate, onDelete, onCrop, isEditable }) {
    if (!sticker) return null;

    const [dragState, setDragState] = useState(null); 
    const elementRef = useRef(null);
    const dragInfo = useRef(null);

    // --- 1. æ‹–æ‹½é€»è¾‘ (ä¿æŒä¸å˜) ---
    const handlePointerDown = (e, type = 'move') => {
        if (!isEditable) return; 
        e.stopPropagation(); 
        if(e.button !== 0 && e.type === 'mousedown') return;
        onSelect(sticker.id);
        if (!elementRef.current) return;
        const parent = elementRef.current.offsetParent; 
        if(!parent) return;
        const parentRect = parent.getBoundingClientRect(); 
        const elRect = elementRef.current.getBoundingClientRect();
        dragInfo.current = { startX: e.clientX, startY: e.clientY, origX: sticker.x, origY: sticker.y, origW: sticker.width || 120, origH: sticker.height || 120, origRot: sticker.rotation || 0, parentRect, centerX: elRect.left + elRect.width / 2, centerY: elRect.top + elRect.height / 2 };
        setDragState(type); e.target.setPointerCapture(e.pointerId);
    };
    const handlePointerMove = (e) => {
        if (!dragInfo.current || !dragState) return; 
        e.stopPropagation(); e.preventDefault();
        const { startX, startY, origX, origY, origW, origH, origRot, parentRect, centerX, centerY } = dragInfo.current;
        if (dragState === 'move') { 
            const dx = e.clientX - startX; const dy = e.clientY - startY; 
            onUpdate(sticker.id, { x: origX + (dx / parentRect.width) * 100, y: origY + (dy / parentRect.height) * 100 }); 
        } else if (dragState === 'rotate') { 
            const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI); 
            onUpdate(sticker.id, { rotation: angle + 90 }); 
        } else if (dragState === 'resize') { 
            const dx = e.clientX - startX; const dy = e.clientY - startY; 
            const rad = -origRot * (Math.PI / 180); 
            const localDx = dx * Math.cos(rad) - dy * Math.sin(rad); 
            const localDy = dx * Math.sin(rad) + dy * Math.cos(rad); 
            onUpdate(sticker.id, { width: Math.max(40, origW + localDx * 2), height: Math.max(40, origH + localDy * 2) }); 
        }
    };
    const handlePointerUp = (e) => { if (!dragInfo.current) return; e.stopPropagation(); e.target.releasePointerCapture(e.pointerId); dragInfo.current = null; setDragState(null); };

    // --- æ¸²æŸ“é€»è¾‘ ---
    const shape = SHAPE_OPTIONS.find(s => s.id === (sticker.shape || 'rect')) || SHAPE_OPTIONS[0];
    const pattern = PATTERN_OPTIONS.find(p => p.id === (sticker.pattern || 'none'));
    const patternClass = pattern?.cssClass || '';
    const texture = TEXTURE_OPTIONS.find(t => t.id === (sticker.texture || 'plain'));
    const textureClass = texture?.cssClass || 't-plain';
    const isTranslucent = sticker.texture === 'translucent';
    const isCustomImage = !!sticker.src;
    const isStamp = sticker.type === 'stamp'; 

    // å°ç« æ¸²æŸ“å™¨ (ä¿æŒä¸å˜)
    const renderStampContent = () => {
        const IconComp = sticker.icon && Icons[sticker.icon] ? Icons[sticker.icon] : null;
        const isCircle = sticker.stampShape && sticker.stampShape.startsWith('circle');
        const isDouble = sticker.stampShape === 'circle-double' || sticker.stampShape === 'rect-double';
        return (
            <div className="w-full h-full flex items-center justify-center relative overflow-hidden" style={{ color: sticker.color, mixBlendMode: 'multiply', opacity: 0.85, filter: 'url(#ink-grunge)' }}>
                <div className="absolute flex items-center justify-center" style={{ inset: isCircle ? 'auto' : '4px', width: isCircle ? '90%' : 'auto', height: isCircle ? 'auto' : 'auto', aspectRatio: isCircle ? '1 / 1' : 'auto', borderRadius: isCircle ? '50%' : '8px', border: isDouble ? `3px solid ${sticker.color}` : `4px ${sticker.stampShape === 'circle-dashed' ? 'dashed' : 'solid'} ${sticker.color}`, boxShadow: isDouble ? `inset 0 0 0 4px transparent, inset 0 0 0 7px ${sticker.color}` : 'none' }}></div>
                <div className="flex flex-col items-center justify-center relative z-10 p-2 text-center transform -rotate-12">
                    {IconComp && <IconComp size={sticker.width * 0.35} strokeWidth={3} />}
                    {sticker.text && (<span className="font-serif font-bold leading-none mt-1" style={{ fontSize: `${sticker.width * 0.15}px` }}>{sticker.text}</span>)}
                    {sticker.subText && (<span className="font-sans font-bold opacity-70 tracking-widest mt-1" style={{ fontSize: `${sticker.width * 0.08}px` }}>{sticker.subText}</span>)}
                </div>
            </div>
        );
    };

    return (
        <div ref={elementRef} 
             onPointerDown={(e) => handlePointerDown(e, 'move')}
             onPointerMove={handlePointerMove} 
             onPointerUp={handlePointerUp} 
             onClick={(e) => { if(isEditable) e.stopPropagation(); }} 
             onDoubleClick={(e) => {
                e.stopPropagation(); 
                if (isEditable && !isCustomImage && !isStamp) onUpdate(sticker.id, { isEditing: true });
             }} 
             className={`absolute ${isEditable ? 'cursor-move' : 'cursor-default'} select-none group font-cute ${isSelected ? 'z-50' : 'z-10'}`} 
             style={{ left: `${sticker.x}%`, top: `${sticker.y}%`, width: `${sticker.width||120}px`, height: `${sticker.height||120}px`, transform: `translate(-50%, -50%) rotate(${sticker.rotation}deg)`, touchAction: 'none' }}>
        
            {isStamp ? renderStampContent() : isCustomImage ? (
                <AsyncImage src={sticker.src} className="w-full h-full object-contain pointer-events-none drop-shadow-md" alt="sticker" />
            ) : (
                <div className={`w-full h-full flex items-center justify-center overflow-hidden relative ${shape.cssClass}`} style={{ backgroundColor: sticker.bgColor, opacity: isTranslucent ? 0.65 : 1, backdropFilter: isTranslucent ? 'blur(3px)' : 'none', WebkitBackdropFilter: isTranslucent ? 'blur(3px)' : 'none', border: isTranslucent ? '1px solid rgba(255,255,255,0.3)' : 'none', filter: (sticker.texture === 'glossy' || isTranslucent) ? 'drop-shadow(1px 2px 3px rgba(0,0,0,0.15))' : (sticker.bgColor !== 'transparent' ? 'drop-shadow(2px 4px 6px rgba(0,0,0,0.2))' : 'none') }}>
                    <div className={`absolute inset-0 w-full h-full pointer-events-none ${isTranslucent ? 'opacity-40' : 'opacity-60'} ${patternClass}`} style={{ backgroundSize: sticker.pattern === 'grid' ? '15px 15px' : undefined }}></div>
                    {!isTranslucent && (<div className={`absolute inset-0 w-full h-full pointer-events-none ${textureClass}`} style={{ mixBlendMode: 'multiply' }}></div>)}
                    {sticker.texture === 'glossy' && !isTranslucent && (<div className="absolute inset-0 w-full h-full pointer-events-none t-glossy"></div>)}
                    <div className="whitespace-pre-wrap text-center leading-snug break-words font-semibold w-full h-full flex items-center justify-center relative z-10 pointer-events-none" style={{ color: isTranslucent && sticker.color !== '#ffffff' ? `${sticker.color}DD` : sticker.color, fontSize: `${sticker.fontSize}px`, textShadow: sticker.isGlow ? `0 0 5px #fff, 0 0 10px ${sticker.color}` : 'none', fontFamily: sticker.fontFamily || "'Caveat', 'ZCOOL KuaiLe', cursive", padding: '8px' }}>{sticker.text}</div>
                </div>
            )}

            {isSelected && isEditable && (
                <>
                    <div className="absolute inset-0 border-2 border-blue-400 rounded-lg pointer-events-none" style={{ margin: '-4px' }}></div>
                    
                    {/* æ—‹è½¬æ‰‹æŸ„ (ä¸Š) */}
                    <div className="absolute -top-10 left-1/2 -translate-x-1/2 w-8 h-8 bg-white rounded-full shadow-md border border-gray-200 flex items-center justify-center cursor-pointer hover:bg-blue-50 text-blue-500 z-50 pointer-events-auto" onPointerDown={(e) => handlePointerDown(e, 'rotate')}>
                         <Icons.RotateCw size={16} />
                         <div className="absolute top-full left-1/2 -translate-x-1/2 w-0.5 h-2 bg-blue-400"></div>
                    </div>
                    
                    {/* ç¼©æ”¾æ‰‹æŸ„ (å³ä¸‹) */}
                    <div className="absolute -bottom-3 -right-3 w-8 h-8 bg-white rounded-full shadow-md border border-gray-200 flex items-center justify-center cursor-sw-resize hover:bg-blue-50 text-blue-500 z-50 pointer-events-auto" onPointerDown={(e) => handlePointerDown(e, 'resize')}>
                         <Icons.CornerRightDown size={16} />
                    </div>

                    {/* ğŸŸ¢ æ–°å¢ï¼šè£åˆ‡æ‰‹æŸ„ (å·¦ä¸Šï¼Œä»…å¯¹è‡ªå®šä¹‰ç…§ç‰‡æ˜¾ç¤º) */}
                    {isCustomImage && (
                        <div 
                            className="absolute -top-3 -left-3 w-8 h-8 bg-white rounded-full shadow-md border border-gray-200 flex items-center justify-center cursor-pointer hover:bg-orange-50 text-orange-500 z-50 pointer-events-auto transition-transform hover:scale-110"
                            onClick={(e) => {
                                e.stopPropagation();
                                if(onCrop) onCrop(sticker.id);
                            }}
                            title="Crop Image"
                        >
                             <Icons.Scissors size={14} />
                        </div>
                    )}
                </>
            )}
        </div>
    );
}


     function BookmarkTabs({ bookmarks, flippedIndex, totalSheets, onJump, onDelete, onUpdate }) {
        // çŠ¶æ€ç®¡ç†
        const [deleteModeId, setDeleteModeId] = useState(null);
        const [editingId, setEditingId] = useState(null);
        const longPressTimer = useRef(null);

        // æ’åºï¼šæŒ‰é¡µç ä»å°åˆ°å¤§
        const sortedBookmarks = [...bookmarks].sort((a, b) => a.pageIndex - b.pageIndex);

        // 1. è®¡ç®—å †å é€»è¾‘
        const leftStack = sortedBookmarks
            .filter(b => (Math.floor(b.pageIndex / 2) + 1) < flippedIndex)
            .sort((a, b) => b.pageIndex - a.pageIndex);

        const rightStack = sortedBookmarks
            .filter(b => (Math.floor(b.pageIndex / 2) + 1) >= flippedIndex)
            .sort((a, b) => a.pageIndex - b.pageIndex);

        // å¤„ç†é•¿æŒ‰
        const handlePointerDown = (id) => {
            if (editingId === id) return; 
            longPressTimer.current = setTimeout(() => {
                setDeleteModeId(id); 
                longPressTimer.current = null;
            }, 600); 
        };

        const handlePointerUp = (e, id, targetFlip) => {
            if (longPressTimer.current) {
                clearTimeout(longPressTimer.current);
                longPressTimer.current = null;
                if (deleteModeId !== id && editingId !== id) {
                    onJump(targetFlip);
                }
            }
        };

        useEffect(() => {
            const clearStates = () => { setDeleteModeId(null); if(!editingId) setDeleteModeId(null); };
            window.addEventListener('click', clearStates);
            return () => window.removeEventListener('click', clearStates);
        }, [editingId]);

        return (
            <>
                {sortedBookmarks.map((bm, visualIndex) => {
                    const sheetOfBookmark = Math.floor(bm.pageIndex / 2) + 1;
                    const isLeft = sheetOfBookmark < flippedIndex;

                    // 2. è®¡ç®— Z-Index
                    let depthLevel = 0;
                    if (isLeft) {
                        depthLevel = leftStack.findIndex(b => b.id === bm.id);
                    } else {
                        depthLevel = rightStack.findIndex(b => b.id === bm.id);
                    }
                    if (depthLevel === -1) depthLevel = 0;

                    const dynamicColor = BOOKMARK_COLORS[visualIndex % BOOKMARK_COLORS.length];
                    const jumpTarget = (bm.pageIndex % 2 === 0) ? sheetOfBookmark : sheetOfBookmark + 1;

                    // 3. å‚ç›´ä½ç½® (å› ä¸ºæœ‰17ä¸ªï¼Œç¨å¾®å†æŒ¤å‹ä¸€ç‚¹ç‚¹ç©ºé—´ï¼Œç”¨ 30px é—´è·)
                    const topPos = 40 + (visualIndex * 30); 

                    const isDeleting = deleteModeId === bm.id;
                    const isEditing = editingId === bm.id;

                    return (
                        <div
                            key={bm.id}
                            className={`absolute flex items-center group transition-all duration-600 ease-[cubic-bezier(0.4,0,0.2,1)] ${isEditing ? 'z-[100]' : ''}`}
                            style={{
                                top: `${topPos}px`,
                                left: isLeft ? '0px' : 'auto', 
        right: isLeft ? 'auto' : '0px',
        
        transform: isLeft ? 'translateX(-100%)' : 'translateX(100%)', 
        zIndex: isEditing ? 100 : (50 - depthLevel)
    }}
                            onPointerDown={() => handlePointerDown(bm.id)}
                            onPointerUp={(e) => handlePointerUp(e, bm.id, jumpTarget)}
                            onPointerLeave={() => { if(longPressTimer.current) clearTimeout(longPressTimer.current); }}
                            onDoubleClick={(e) => {
                                e.stopPropagation();
                                setDeleteModeId(null);
                                setEditingId(bm.id);
                            }}
                            onClick={(e) => e.stopPropagation()} 
                        >
                            <div 
                                className={`h-9 min-w-[60px] max-w-[120px] flex items-center justify-center transition-all duration-300 relative 
                                ${isLeft ? 'rounded-l-xl rounded-r-none' : 'rounded-r-xl rounded-l-none'}
                                ${isDeleting ? 'animate-pulse scale-105' : 'hover:scale-105'}
                                `}
                                style={{ 
                                    // ğŸŸ¢ æè´¨æ ¸å¿ƒä¿®æ”¹ï¼šç å…‰åŠé€æ˜æ•ˆæœ
                                    
                                    // 1. èƒŒæ™¯è‰²ï¼šä½¿ç”¨Hexé¢œè‰² + CC (80%ä¸é€æ˜åº¦)ï¼Œè®©å®ƒé€å…‰
                                    backgroundColor: `${dynamicColor}CC`, 

                                    // 2. ç å…‰å…‰æ³½ï¼šå åŠ ä¸€ä¸ªåŠé€æ˜ç™½è‰²çš„çº¿æ€§æ¸å˜
                                    backgroundImage: 'linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%)',
                                    
                                    // 3. æ¯›ç»ç’ƒæ•ˆæœï¼šæ¨¡ç³ŠèƒŒæ™¯
                                    backdropFilter: 'blur(4px)',
                                    WebkitBackdropFilter: 'blur(4px)',
                                    
                                    // 4. è¾¹æ¡†ï¼šæ·¡æ·¡çš„ç™½è‰²è¾¹æ¡†ï¼Œå¢åŠ ç»ç’ƒè´¨æ„Ÿ
                                    border: '1px solid rgba(255,255,255,0.4)',
                                    borderRight: isLeft ? 'none' : '1px solid rgba(255,255,255,0.4)',
                                    borderLeft: isLeft ? '1px solid rgba(255,255,255,0.4)' : 'none',

                                    paddingLeft: isLeft ? '12px' : '8px',
                                    paddingRight: isLeft ? '8px' : '12px',
                                    
                                    // 5. æŠ•å½±ï¼šä¿ç•™ä½ å–œæ¬¢çš„æ–¹å‘æ€§é˜´å½± + å¢åŠ ä¸€å±‚ç™½è‰²å†…å‘å…‰(inset highlight)
                                    boxShadow: isLeft 
                                        ? '0 -3px 4px -1px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3)' 
                                        : '0 3px 4px -1px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3)',
                                }}
                            >
                                {isEditing ? (
                                    <input 
                                        autoFocus
                                        onPointerDown={(e) => e.stopPropagation()}
                                        onClick={(e) => e.stopPropagation()}
                                        className="bg-transparent border-b border-white/50 outline-none text-center font-cute text-white drop-shadow-md w-16 text-xl p-0 leading-none placeholder-white/50"
                                        defaultValue={bm.name || `Page ${bm.pageIndex + 1}`}
                                        onBlur={(e) => {
                                            onUpdate(bm.id, { name: e.target.value });
                                            setEditingId(null);
                                        }}
                                        onKeyDown={(e) => {
                                            if(e.key === 'Enter') {
                                                onUpdate(bm.id, { name: e.target.currentTarget.value });
                                                setEditingId(null);
                                            }
                                        }}
                                    />
                                ) : (
                                    // æ–‡å­—å¢åŠ ä¸€ç‚¹æŠ•å½±ï¼Œç¡®ä¿åœ¨åŠé€æ˜èƒŒæ™¯ä¸Šæ¸…æ™°
                                    <span className="font-cute text-xl text-white drop-shadow-md truncate pointer-events-none select-none opacity-90">
                                        {bm.name || (bm.pageIndex + 1)}
                                    </span>
                                )}

                                {isDeleting && (
                                    <button 
                                        onClick={(e) => { 
                                            e.stopPropagation(); 
                                            onDelete(bm.id); 
                                            setDeleteModeId(null); 
                                        }}
                                        className={`absolute ${isLeft ? '-top-3' : '-bottom-3'} bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-md animate-pop z-50 border-2 border-white`}
                                        style={{ [isLeft ? 'left' : 'right']: '-6px' }}
                                    >
                                        <Icons.X size={12} strokeWidth={4} />
                                    </button>
                                )}
                            </div>
                        </div>
                    );
                })}
            </>
        );
    }


// ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šæ›´æ–° DraggableToolbar ç»„ä»¶ (å‡å°æ‹–æ‹½æ‰‹æŸ„é«˜åº¦)
function DraggableToolbar({ children, initialX, initialY, initialBottom, centerX = false, externalPosition, className }) {
    const [position, setPosition] = useState(externalPosition || (initialBottom !== undefined ? { x: centerX ? window.innerWidth / 2 - 150 : 20, y: window.innerHeight - initialBottom } : { x: 20, y: 100 }));
    const [isDragging, setIsDragging] = useState(false); 
    const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 }); 
    const ref = useRef(null);
    
    useEffect(() => { if (externalPosition) setPosition(externalPosition); }, [externalPosition]);
    
    const handlePointerDown = (e) => { 
        e.preventDefault(); 
        const rect = ref.current.getBoundingClientRect(); 
        setDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top }); 
        setIsDragging(true); 
        e.target.setPointerCapture(e.pointerId); 
    };
    
    const handlePointerMove = (e) => { 
        if(!isDragging) return; 
        e.preventDefault(); 
        setPosition({ 
            x: Math.max(0, Math.min(e.clientX - dragOffset.x, window.innerWidth - 50)), 
            y: Math.max(0, Math.min(e.clientY - dragOffset.y, window.innerHeight - 50)) 
        }); 
    };
    
    const handlePointerUp = (e) => { 
        setIsDragging(false); 
        e.target.releasePointerCapture(e.pointerId); 
    };
    
    return (
        <div ref={ref} 
             onPointerMove={handlePointerMove} 
             onPointerUp={handlePointerUp} 
             className={`fixed z-[100] cursor-default touch-none flex flex-col ${isDragging ? 'transition-none' : 'transition-all duration-300'} ${className || 'bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 p-6 gap-3'}`} 
             style={{ left: position.x, top: position.y }}>
            
            {/* ğŸ‘‡ ä¿®æ”¹ç‚¹ï¼špy-2 æ”¹ä¸º py-1ï¼Œå‡å°‘é«˜åº¦å ç”¨ */}
            <div 
                onPointerDown={handlePointerDown}
                className="w-full flex justify-center py-1 cursor-move hover:bg-gray-100/50 rounded-t-xl transition-colors shrink-0 -mt-2 mb-1"
                title="Drag handle"
            >
                <div className="w-10 h-1 bg-gray-300 rounded-full opacity-50 pointer-events-none"></div>
            </div>
            
            {children}
        </div>
    );
}



   function PhotoEditor({ pageIndex, currentDoodle, pageContent, onSave, onCancel }) {
        const canvasRef = useRef(null);
        const tempCanvasRef = useRef(null);
        // æ–°å¢ï¼šç”¨äºæµ‹é‡å¯ç”¨ç©ºé—´çš„å®¹å™¨å¼•ç”¨
        const wrapperRef = useRef(null);
        // æ–°å¢ï¼šè®¡ç®—å‡ºçš„ç¼©æ”¾æ¯”ä¾‹ (é»˜è®¤ç»™ä¸€ä¸ªé0å€¼ï¼Œé¿å…åˆå§‹é—ªçƒ)
        const [editorScale, setEditorScale] = useState(0.5);
        
        const [isDrawing, setIsDrawing] = useState(false);
        const [color, setColor] = useState('#000000');
        const [lineWidth, setLineWidth] = useState(5);
        const [tool, setTool] = useState('pen'); 
        const lastPos = useRef({ x: 0, y: 0 });

        // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ ResizeObserver å®æ—¶ç›‘å¬å®¹å™¨å¤§å°å˜åŒ–
        // è¿™è§£å†³äº† "width=0" å¯¼è‡´é¢„è§ˆæ¶ˆå¤±çš„é—®é¢˜
        useEffect(() => {
            if (!wrapperRef.current) return;

            const updateScale = () => {
                const el = wrapperRef.current;
                if (!el) return;
                
                const { clientWidth, clientHeight } = el;
                // å¦‚æœå®¹å™¨è¿˜æ²¡å‡†å¤‡å¥½ï¼Œæš‚æ—¶ä¸è®¡ç®—ï¼Œé˜²æ­¢ scale=0
                if (clientWidth === 0 || clientHeight === 0) return;

                // ç›®æ ‡æ ‡å‡†å°ºå¯¸ï¼šå•é¡µå®½åº¦ 480ï¼Œé«˜åº¦ 600 (ä¸ BookView ä¿æŒ 1:1 ä¸€è‡´)
                const targetW = 480;
                const targetH = 600;
                
                // è®¡ç®—åŒ…å«è¾¹è·(0.85)çš„ç¼©æ”¾æ¯”ï¼Œç•™å‡ºä¸€ç‚¹å‘¼å¸ç©ºé—´
                const scale = Math.min(clientWidth / targetW, clientHeight / targetH) * 0.85;
                setEditorScale(scale);
            };

            // åˆ›å»ºè§‚å¯Ÿè€…
            const observer = new ResizeObserver(() => {
                // ä½¿ç”¨ requestAnimationFrame é¿å… "ResizeObserver loop limit exceeded" æŠ¥é”™
                window.requestAnimationFrame(updateScale);
            });
            
            observer.observe(wrapperRef.current);
            
            // ç«‹å³å°è¯•è®¡ç®—ä¸€æ¬¡
            updateScale();

            return () => observer.disconnect();
        }, []);

        // (Init Canvas é€»è¾‘ä¿æŒä¸å˜)
        useEffect(() => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            const width = 480 * 2; // å†…éƒ¨æ¸²æŸ“åˆ†è¾¨ç‡ä¿æŒé«˜æ¸…
            const height = 600 * 2;
            canvas.width = width;
            canvas.height = height;

            const tempCanvas = tempCanvasRef.current;
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            if (currentDoodle) {
                const img = new Image();
                img.src = currentDoodle;
                img.onload = () => { ctx.drawImage(img, 0, 0, width, height); };
            }
        }, []);

        const getCoordinates = (e) => {
            const rect = canvasRef.current.getBoundingClientRect();
            const scaleX = canvasRef.current.width / rect.width;
            const scaleY = canvasRef.current.height / rect.height;
            let cx = e.clientX, cy = e.clientY;
            if(e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
            return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        };

        const startDrawing = (e) => {
            if(e.cancelable) e.preventDefault();
            const { x, y } = getCoordinates(e);
            lastPos.current = { x, y };
            setIsDrawing(true);
            const targetCanvas = tool === 'eraser' ? canvasRef.current : tempCanvasRef.current;
            const ctx = targetCanvas.getContext('2d');
            ctx.beginPath();
            if (tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = lineWidth * 4;
                ctx.lineCap = 'round';
                ctx.globalAlpha = 1.0;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = color;
                ctx.lineWidth = tool === 'marker' ? lineWidth * 3 : lineWidth;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalAlpha = 1.0; 
            }
        };

        const draw = (e) => {
            if (!isDrawing) return;
            if(e.cancelable) e.preventDefault();
            const { x, y } = getCoordinates(e);
            const targetCanvas = tool === 'eraser' ? canvasRef.current : tempCanvasRef.current;
            const ctx = targetCanvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(lastPos.current.x, lastPos.current.y);
            ctx.lineTo(x, y);
            ctx.stroke();
            lastPos.current = { x, y };
        };

        const stopDrawing = (e) => {
            if(e && e.cancelable) e.preventDefault();
            setIsDrawing(false);
            if (tool !== 'eraser') {
                const mainCanvas = canvasRef.current;
                const mainCtx = mainCanvas.getContext('2d');
                const tempCanvas = tempCanvasRef.current;
                mainCtx.globalAlpha = tool === 'marker' ? 0.5 : 1.0;
                mainCtx.globalCompositeOperation = 'source-over';
                mainCtx.drawImage(tempCanvas, 0, 0);
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                mainCtx.globalAlpha = 1.0;
            }
            canvasRef.current.getContext('2d').closePath();
            tempCanvasRef.current.getContext('2d').closePath();
        };

        const handleSave = () => { onSave(canvasRef.current.toDataURL('image/png')); };
        const handleClear = () => { const ctx = canvasRef.current.getContext('2d'); ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height); };

        return (
            <div className="fixed inset-0 z-[120] bg-[#fdf6ec] flex flex-col md:flex-row touch-none animate-in fade-in duration-300">
                
                {/* ä¾§è¾¹æ  */}
                <div className="w-full md:w-40 bg-white h-auto md:h-full shadow-2xl z-20 flex flex-col border-r border-[#f2e6d9] shrink-0">
                    <div className="flex justify-between items-center p-3 border-b border-gray-100">
                        <h3 className="text-[#5d5550] font-bold text-sm flex items-center gap-1">
                            <Icons.Pen size={16} className="text-[#e07a5f]"/> 
                            <span className="font-serif italic">Studio</span>
                        </h3>
                        <button onClick={onCancel} className="p-1 rounded-full hover:bg-gray-100 text-[#5d5550] transition-colors"><Icons.X size={16}/></button>
                    </div>

                    <div className="flex-1 p-3 flex flex-col gap-4 overflow-y-auto">
                        <div>
                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">Brushes</span>
                            <div className="flex gap-1">
                                {['pen', 'marker', 'eraser'].map(t => (
                                    <button key={t} onClick={() => setTool(t)} className={`flex-1 aspect-square rounded-lg border flex flex-col items-center justify-center gap-0.5 transition-all ${tool === t ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-100 text-gray-400 hover:border-gray-300'}`}>
                                        {t==='pen'?<Icons.Pen size={16}/>:t==='marker'?<Icons.Highlighter size={16}/>:<Icons.Eraser size={16}/>}
                                        <span className="text-[9px] font-bold capitalize">{t}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {tool !== 'eraser' && (
                            <div className="animate-in fade-in slide-in-from-left-4">
                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">Ink Color</span>
                                <div className="grid grid-cols-5 gap-1.5">
                                    {DOODLE_COLORS.map(c => (
                                        <button 
                                            key={c} 
                                            onClick={() => setColor(c)} 
                                            className={`w-full aspect-square rounded-full border transition-transform ${color === c ? 'scale-110 ring-1 ring-gray-300 border-gray-400' : 'border-transparent hover:scale-105'}`}
                                            style={{ backgroundColor: c, boxShadow: '0 1px 2px rgba(0,0,0,0.1)' }}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        <div>
                            <div className="flex justify-between mb-1">
                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Size</span>
                                <span className="text-[10px] font-bold text-gray-600">{lineWidth}px</span>
                            </div>
                            <input type="range" min="1" max="30" value={lineWidth} onChange={(e) => setLineWidth(parseInt(e.target.value))} className="w-full accent-[#5d5550]" />
                        </div>
                        
                        <button onClick={handleClear} className="py-1.5 text-[10px] font-bold text-red-400 border border-red-100 rounded-lg hover:bg-red-50 transition-colors">Clear All</button>
                    </div>

                    <div className="p-3 border-t border-gray-100 bg-gray-50/50">
                        <button onClick={handleSave} className="w-full py-2.5 bg-[#2d3436] text-white rounded-lg font-bold text-sm active:scale-95 transition-all shadow-md flex items-center justify-center gap-1.5 hover:bg-black">
                            <Icons.Check size={16} /> Save
                        </button>
                    </div>
                </div>

                {/* ğŸŸ¢ å³ä¾§å–æ™¯å™¨åŒºåŸŸ */}
                <div 
                    ref={wrapperRef}
                    className="flex-1 flex items-center justify-center bg-[#f2e6d9] relative overflow-hidden p-0"
                >
                    <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#a8a29e 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>

                    {/* è¿™é‡Œå¼ºåˆ¶è®¾å®š width: 480px, height: 600pxã€‚
                       è¿™ä¿è¯äº†æ— è®ºåœ¨ä»€ä¹ˆå±å¹•ä¸Šï¼Œ"çº¸å¼ "çš„æ¯”ä¾‹å’Œ BookView æ˜¯ 1:1 çš„ã€‚
                       ç„¶åé€šè¿‡ transform: scale(...) æ•´ä½“ç¼©æ”¾æ¥é€‚åº”æ‰‹æœºå±å¹•ã€‚
                    */}
                    <div className="relative shadow-2xl overflow-hidden bg-[#fffdf9]" 
                         style={{ 
                             width: '480px',
                             height: '600px',
                             transform: `scale(${editorScale})`,
                             transformOrigin: 'center center',
                             boxShadow: '0 20px 50px -12px rgba(0,0,0,0.25)',
                         }}>
                        
                        {/* Layer 1: èƒŒæ™¯å‚è€ƒå±‚ */}
                        <div className="absolute inset-0 pointer-events-none select-none z-0">
                            
                            {/* ç…§ç‰‡å®¹å™¨ - ä»…åœ¨é Full æ¨¡å¼ä¸‹åº”ç”¨ Padding */}
                            <div className={`absolute inset-0 w-full h-full flex flex-col ${pageContent.layout.isFull ? 'p-0' : 'p-6 pb-2'}`}>
                                {pageContent.img ? (
                                    <div className="w-full h-full relative overflow-hidden">
                                   <AsyncImage 
    src={pageContent.img} 
    className={`absolute top-1/2 left-1/2 w-full h-full object-contain`}
    style={{ 
        transform: `translate(-50%, -50%) translate(${pageContent.layout.x||0}%, ${pageContent.layout.y||0}%) rotate(${pageContent.layout.rotate||0}deg) scale(${pageContent.layout.scale||1})`,
        filter: pageContent.layout.isFull ? 'none' : 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))'
    }} 
/>

                                    </div>
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-gray-300 font-serif italic">Empty Page</div>
                                )}
                            </div>

                            {/* è´´çº¸å®¹å™¨ - æ°¸è¿œå…¨å±ï¼Œæ—  Paddingï¼Œç¡®ä¿ä¸ BookView çš„åæ ‡ç³»ä¸€è‡´ */}
                            <div className="absolute inset-0 w-full h-full">
                                {pageContent.stickers.map(s => (
                                    <DraggableSticker key={s.id} sticker={s} isSelected={false} onSelect={()=>{}} onUpdate={()=>{}} onDelete={()=>{}} isEditable={false} />
                                ))}
                            </div>
                        </div>

                        {/* Layer 2: æ¶‚é¸¦ç”»å¸ƒå±‚ (å§‹ç»ˆè¦†ç›–å…¨å±) */}
                        <canvas ref={canvasRef} className="absolute inset-0 z-10 w-full h-full pointer-events-none" />
                        <canvas 
                            ref={tempCanvasRef}
                            onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing}
                            onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing}
                            className="absolute inset-0 z-20 w-full h-full cursor-crosshair touch-none"
                            style={{ opacity: (isDrawing && tool === 'marker') ? 0.5 : 1.0 }}
                        />
                    </div>
                </div>
            </div>
        );
    }



    function ImageTransformEditor({ imageSrc, initialSettings, onSave, onCancel, onUpdateImage, hasOriginal, onRestore, initialMode = 'layout', enableModeSwitch = true }) {
        // --- çŠ¶æ€ç®¡ç† ---
        const [mode, setMode] = useState(initialMode); 
        const [cropTool, setCropTool] = useState('rect');
        
        const [settings, setSettings] = useState(initialSettings || { x: 0, y: 0, scale: 1, rotate: 0, isFull: false }); 
        const [cropPoints, setCropPoints] = useState([]); 
        const [isCropping, setIsCropping] = useState(false);

        // ğŸŸ¢ æ–°å¢ï¼šæ§åˆ¶è¿˜åŸç¡®è®¤å¼¹çª—çš„çŠ¶æ€
        const [restoreModalOpen, setRestoreModalOpen] = useState(false);

        // äº¤äº’å¼•ç”¨
        const containerRef = useRef(null);
        const dragStart = useRef({ x: 0, y: 0 }); 
        const [isDraggingLayout, setIsDraggingLayout] = useState(false); 

        // æ ¸å¿ƒå‡½æ•°ï¼šè®¡ç®—å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„çœŸå®æ¸²æŸ“ä½ç½®
        const getImageLayout = () => {
            const container = containerRef.current;
            const img = container ? container.querySelector('img') : null;
            if (!container || !img) return null;

            const rect = container.getBoundingClientRect();
            if (img.naturalWidth === 0 || img.naturalHeight === 0 || rect.height === 0) return null;

            const imgRatio = img.naturalWidth / img.naturalHeight;
            const containerRatio = rect.width / rect.height;

            let renderW, renderH, offsetX, offsetY;

            if (imgRatio > containerRatio) {
                renderW = rect.width;
                renderH = rect.width / imgRatio;
                offsetX = 0;
                offsetY = (rect.height - renderH) / 2;
            } else {
                renderH = rect.height;
                renderW = rect.height * imgRatio;
                offsetX = (rect.width - renderW) / 2;
                offsetY = 0;
            }

            return { rect, renderW, renderH, offsetX, offsetY };
        };

        const handleLayoutDown = (e) => { 
            e.preventDefault(); setIsDraggingLayout(true); 
            dragStart.current = { x: e.clientX, y: e.clientY, initX: settings.x, initY: settings.y }; 
            e.target.setPointerCapture(e.pointerId); 
        };
        const handleLayoutMove = (e) => { 
            if (!isDraggingLayout) return; e.preventDefault(); 
            const sens = 80 / (containerRef.current.offsetWidth * settings.scale); 
            setSettings(p => ({ ...p, x: dragStart.current.initX + (e.clientX - dragStart.current.x) * sens * p.scale, y: dragStart.current.initY + (e.clientY - dragStart.current.y) * sens * p.scale })); 
        };
        const handleLayoutUp = (e) => { setIsDraggingLayout(false); e.target.releasePointerCapture(e.pointerId); };

        const getNormCoord = (e) => {
            const layout = getImageLayout();
            if (!layout) return { x: 0, y: 0 };
            const { rect, renderW, renderH, offsetX, offsetY } = layout;
            const clientX = e.clientX - rect.left;
            const clientY = e.clientY - rect.top;
            let x = (clientX - offsetX) / renderW;
            let y = (clientY - offsetY) / renderH;
            return { x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) };
        };

        const handleCropDown = (e) => {
            e.preventDefault(); setIsCropping(true); const p = getNormCoord(e);
            if (cropTool === 'rect') setCropPoints([p, p]); else setCropPoints([p]);
            e.target.setPointerCapture(e.pointerId);
        };
        const handleCropMove = (e) => { 
            if (!isCropping) return; e.preventDefault(); const p = getNormCoord(e);
            if (cropTool === 'rect') setCropPoints(prev => [prev[0], p]); else setCropPoints(prev => [...prev, p]);
        };
        const handleCropUp = (e) => { setIsCropping(false); e.target.releasePointerCapture(e.pointerId); };

        const applyCrop = async () => {
            if (cropPoints.length < 2) return;
            const imgEl = containerRef.current.querySelector('img');
            if (!imgEl) return;
            try {
                const blob = await performCrop(imgEl.src, { type: cropTool, points: cropPoints });
                if (blob) {
                    const newId = await dbUtils.saveImage(blob);
                    onUpdateImage(newId); 
                    setSettings({ x: 0, y: 0, scale: 1, rotate: 0, isFull: false });
                    if(enableModeSwitch) setMode('layout'); 
                    setCropPoints([]);
                }
            } catch (err) { console.error("Crop failed", err); alert("Failed to crop image."); }
        };

        // ğŸŸ¢ å¤„ç†ç¡®è®¤è¿˜åŸçš„é€»è¾‘
        const handleConfirmRestore = () => {
            onRestore(); // æ‰§è¡Œçˆ¶ç»„ä»¶ä¼ è¿›æ¥çš„è¿˜åŸé€»è¾‘
            setCropPoints([]); // æ¸…ç©ºå¯èƒ½å­˜åœ¨çš„é€‰åŒº
            setRestoreModalOpen(false); // å…³é—­å¼¹çª—
        };

        const renderCropPath = () => {
            if (cropPoints.length === 0) return null;
            const layout = getImageLayout(); if (!layout) return null; const { renderW, renderH, offsetX, offsetY, rect } = layout;
            const toSvg = (p) => ({ x: ((p.x * renderW + offsetX) / rect.width) * 100, y: ((p.y * renderH + offsetY) / rect.height) * 100 });
            if (cropTool === 'rect') {
                const start = toSvg(cropPoints[0]); const end = toSvg(cropPoints[cropPoints.length - 1]);
                const x = Math.min(start.x, end.x); const y = Math.min(start.y, end.y); const w = Math.abs(end.x - start.x); const h = Math.abs(end.y - start.y);
                return <rect x={x} y={y} width={w} height={h} fill="rgba(255,255,255,0.3)" stroke="#e07a5f" strokeWidth="1" vectorEffect="non-scaling-stroke" strokeDasharray="4"/>;
            } else {
                const pts = cropPoints.map(p => { const s = toSvg(p); return `${s.x},${s.y}`; }).join(' ');
                return <polygon points={pts} fill="rgba(255,255,255,0.3)" stroke="#e07a5f" strokeWidth="1" vectorEffect="non-scaling-stroke" strokeDasharray="4" />;
            }
        };

        return (
            <div className="fixed inset-0 z-[110] bg-[#fdf6ec] flex flex-col md:flex-row touch-none animate-in fade-in duration-300">
                <div className="w-full md:w-44 bg-white h-auto md:h-full shadow-2xl z-20 flex flex-col border-r border-[#f2e6d9] shrink-0">
                    <div className="flex justify-between items-center p-3 border-b border-gray-100">
                        <h3 className="text-[#5d5550] font-bold text-sm flex items-center gap-1">
                            {mode === 'layout' ? <Icons.Move size={16} className="text-[#e07a5f]"/> : <Icons.Scissors size={16} className="text-[#e07a5f]"/>}
                            <span className="font-serif italic">{mode === 'layout' ? 'Layout' : 'Crop Studio'}</span>
                        </h3>
                        <div className="flex gap-1">
                            <button onClick={onCancel} className="p-1 rounded-full hover:bg-gray-100 text-[#5d5550] transition-colors" title="Close"><Icons.X size={16}/></button>
                        </div>
                    </div>

                    {enableModeSwitch && (
                        <div className="px-3 pt-3">
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setMode('layout')} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-1 transition-all ${mode==='layout' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}><Icons.Move size={12}/> Move</button>
                                <button onClick={() => { setMode('crop'); setCropPoints([]); }} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-1 transition-all ${mode==='crop' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}><Icons.Scissors size={12}/> Crop</button>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 p-3 flex flex-col gap-4 overflow-y-auto">
                        {/* Layout Mode */}
                        {mode === 'layout' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-left-4">
                                {hasOriginal && (
                                    // ğŸŸ¢ æ›¿æ¢ï¼šä½¿ç”¨ setRestoreModalOpen
                                    <button 
                                        onClick={() => setRestoreModalOpen(true)} 
                                        className="w-full py-2 bg-gray-50 text-gray-600 border border-gray-200 rounded-lg font-bold text-[10px] uppercase tracking-wider flex items-center justify-center gap-1 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-colors"
                                    >
                                        <Icons.Undo size={14} /> Restore Original
                                    </button>
                                )}
                                <div><span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">View Mode</span><div className="flex items-center justify-between bg-gray-100 p-0.5 rounded-lg border border-gray-200"><button onClick={() => setSettings(s => ({...s, isFull: false}))} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider transition-all ${!settings.isFull ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}><Icons.Minimize size={12} /> Fit</button><button onClick={() => setSettings(s => ({...s, isFull: true}))} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider transition-all ${settings.isFull ? 'bg-black text-white shadow' : 'text-gray-400'}`}><Icons.Maximize size={12} /> Full</button></div></div>
                                <div className="space-y-4"><div className="flex flex-col gap-1"><div className="flex justify-between"><span className="text-[#5d5550] text-[10px] font-bold uppercase tracking-wider">Zoom</span><span className="text-[#e07a5f] text-[10px] font-bold font-serif">{Math.round(settings.scale * 100)}%</span></div><input type="range" min="0.2" max="3" step="0.05" value={settings.scale} onChange={e => setSettings(p => ({...p, scale: parseFloat(e.target.value)}))} className="w-full accent-[#e07a5f]"/></div><div className="flex flex-col gap-1"><div className="flex justify-between"><span className="text-[#5d5550] text-[10px] font-bold uppercase tracking-wider">Rotation</span><span className="text-[#e07a5f] text-[10px] font-bold font-serif">{settings.rotate}Â°</span></div><input type="range" min="-180" max="180" step="1" value={settings.rotate} onChange={e => setSettings(p => ({...p, rotate: parseInt(e.target.value)}))} className="w-full accent-[#e07a5f]"/></div></div>
                                <div className="bg-orange-50 p-2 rounded-lg border border-orange-100 text-orange-800 text-[10px] leading-relaxed font-bold opacity-80"><Icons.Focus size={12} className="inline mr-1 mb-0.5"/> Drag photo to move.</div>
                            </div>
                        )}

                        {/* Crop Mode */}
                        {mode === 'crop' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
                                
                                {hasOriginal && (
                                    // ğŸŸ¢ æ›¿æ¢ï¼šä½¿ç”¨ setRestoreModalOpen
                                    <button 
                                        onClick={() => setRestoreModalOpen(true)} 
                                        className="w-full py-2 bg-gray-50 text-gray-600 border border-gray-200 rounded-lg font-bold text-[10px] uppercase tracking-wider flex items-center justify-center gap-1 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-colors"
                                    >
                                        <Icons.Undo size={14} /> Restore Original
                                    </button>
                                )}

                                <div>
                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">Crop Tool</span>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => { setCropTool('rect'); setCropPoints([]); }} className={`py-2 rounded-lg border flex flex-col items-center justify-center gap-1 transition-all ${cropTool === 'rect' ? 'border-[#e07a5f] bg-orange-50 text-[#e07a5f]' : 'border-gray-100 text-gray-400'}`}><Icons.SquareDashed size={18}/> <span className="text-[9px] font-bold">Box</span></button>
                                        <button onClick={() => { setCropTool('lasso'); setCropPoints([]); }} className={`py-2 rounded-lg border flex flex-col items-center justify-center gap-1 transition-all ${cropTool === 'lasso' ? 'border-[#e07a5f] bg-orange-50 text-[#e07a5f]' : 'border-gray-100 text-gray-400'}`}><Icons.Lasso size={18}/> <span className="text-[9px] font-bold">Freehand</span></button>
                                    </div>
                                </div>
                                <div className="bg-blue-50 p-2 rounded-lg border border-blue-100 text-blue-800 text-[10px] leading-relaxed font-bold opacity-80"><Icons.Scissors size={12} className="inline mr-1 mb-0.5"/> {cropTool === 'rect' ? 'Drag to create a box.' : 'Draw freely to outline.'} <br/> Click "Cut" to confirm.</div>
                                <button onClick={applyCrop} disabled={cropPoints.length < 2} className="w-full py-2 bg-[#e07a5f] disabled:bg-gray-300 text-white rounded-lg font-bold text-xs shadow-md active:scale-95 transition-all flex items-center justify-center gap-1"><Icons.Scissors size={14} /> Cut & Apply</button>
                            </div>
                        )}
                    </div>

                    <div className="p-3 border-t border-gray-100 bg-gray-50/50">
                        {mode === 'layout' ? (
                            <button onClick={() => onSave(settings)} className="w-full py-2.5 bg-[#2d3436] text-white rounded-lg font-bold text-sm active:scale-95 transition-all shadow-md flex items-center justify-center gap-1.5 hover:bg-black"><Icons.Check size={16} /> Save Layout</button>
                        ) : (
                             enableModeSwitch ? (
                                <button onClick={() => setMode('layout')} className="w-full py-2.5 bg-white border border-gray-300 text-gray-600 rounded-lg font-bold text-sm active:scale-95 transition-all shadow-sm flex items-center justify-center gap-1.5"><Icons.ArrowLeft size={16} /> Back to Layout</button>
                             ) : (
                                <button onClick={onCancel} className="w-full py-2.5 bg-white border border-gray-300 text-gray-600 rounded-lg font-bold text-sm active:scale-95 transition-all shadow-sm flex items-center justify-center gap-1.5"><Icons.X size={16} /> Cancel</button>
                             )
                        )}
                    </div>
                </div>

                <div className="flex-1 flex items-center justify-center p-8 overflow-hidden relative bg-[#f2e6d9] md:h-full">
                    <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#a8a29e 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                    <div className={`relative shadow-2xl overflow-hidden ring-1 ring-black/5 rounded-r-3xl rounded-l-md bg-[#fffdf9] transition-all duration-300 ${settings.isFull ? 'border-0' : 'border-[8px] border-white'}`} style={{ aspectRatio: '4 / 5', height: '90%', maxHeight: '800px', maxWidth: '100%', transform: mode === 'crop' ? 'scale(1)' : 'scale(1.0)' }}>
                        <div className="absolute left-0 top-0 bottom-0 w-6 bg-gradient-to-r from-black/10 to-transparent z-20 pointer-events-none"></div>
                        <div className={`w-full h-full relative transition-all duration-300 ${settings.isFull ? 'p-0' : 'p-8'}`}>
                            <div ref={containerRef} className={`w-full h-full relative touch-none select-none ${settings.isFull ? '' : 'border border-dashed border-gray-300 rounded-sm'} ${mode === 'crop' ? 'cursor-crosshair' : 'cursor-move'}`} onPointerDown={mode === 'layout' ? handleLayoutDown : handleCropDown} onPointerMove={mode === 'layout' ? handleLayoutMove : handleCropMove} onPointerUp={mode === 'layout' ? handleLayoutUp : handleCropUp}>
                                <AsyncImage src={imageSrc} className={`absolute top-1/2 left-1/2 w-full h-full select-none pointer-events-none transition-all duration-100 will-change-transform object-contain`} style={{ transform: mode === 'layout' ? `translate(-50%, -50%) translate(${settings.x}%, ${settings.y}%) rotate(${settings.rotate}deg) scale(${settings.scale})` : `translate(-50%, -50%) scale(1) rotate(0deg)` }} />
                                {mode === 'crop' && (<svg className="absolute inset-0 w-full h-full pointer-events-none z-30" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 H100 V100 H0 Z" fill="rgba(0,0,0,0.4)" /><mask id="crop-mask"><rect x="0" y="0" width="100" height="100" fill="white" />{renderCropPath() && React.cloneElement(renderCropPath(), { fill: 'black', stroke: 'none' })}</mask>{renderCropPath()}</svg>)}
                            </div>
                        </div>
                        <div className={`absolute bottom-3 w-full text-center text-xs font-serif font-bold pointer-events-none z-20 ${settings.isFull ? 'text-white/50' : 'text-[#c5a059]'}`}>- {mode === 'layout' ? 'Preview' : 'Crop Mode'} -</div>
                    </div>
                </div>

                {/* ğŸŸ¢ ğŸŸ¢ ğŸŸ¢ æ¸²æŸ“å¯çˆ±çš„è¿˜åŸç¡®è®¤å¼¹çª— ğŸŸ¢ ğŸŸ¢ ğŸŸ¢ */}
                <ConfirmationModal 
                    isOpen={restoreModalOpen} 
                    title="Restore Original?" 
                    message="Are you sure you want to revert to the original photo? Your current crop will be lost." 
                    confirmText="Restore" 
                    cancelText="Keep"
                    onConfirm={handleConfirmRestore} 
                    onCancel={() => setRestoreModalOpen(false)} 
                />
            </div>
        );
    }


    function BookView({ album, onBack, onUpdateAlbum }) {
        const [flippedIndex, setFlippedIndex] = useState(0); const [isFlipping, setIsFlipping] = useState(false); const [scale, setScale] = useState(0.5);
        const [isPageJumpOpen, setIsPageJumpOpen] = useState(false);
        const [isDraggingSlider, setIsDraggingSlider] = useState(false);
        
            // --- ğŸŸ¢ (1/2) åœ¨è¿™é‡Œæ’å…¥æ–°ä»£ç  ---
    const [sliderValue, setSliderValue] = useState(0); 

    useEffect(() => {
        if (!isDraggingSlider) {
            setSliderValue(flippedIndex);
        }
    }, [flippedIndex, isDraggingSlider]);
    // -------------------------------

        
        const [isDeleteMode, setIsDeleteMode] = useState(false); const [isDrawMode, setIsDrawMode] = useState(false); const [isStickerMode, setIsStickerMode] = useState(false); const [isPlacingSticker, setIsPlacingSticker] = useState(false); const [isLayoutMode, setIsLayoutMode] = useState(false); 
        const [editingPhotoIndex, setEditingPhotoIndex] = useState(null); const [editingLayoutIndex, setEditingLayoutIndex] = useState(null); const [movingPageIndex, setMovingPageIndex] = useState(null);
        const [isImmersive, setIsImmersive] = useState(false); const [isVisible, setIsVisible] = useState(false); const [closingBookContent, setClosingBookContent] = useState(null);
        const [selectedStickerId, setSelectedStickerId] = useState(null); const [isTextEditModalOpen, setIsTextEditModalOpen] = useState(false); const [tempTextValue, setTempTextValue] = useState("");
        const [confirmModal, setConfirmModal] = useState({ isOpen: false });
        // ğŸŸ¢ æ–°å¢ï¼šå½“å‰æ­£åœ¨è£åˆ‡çš„è´´çº¸ ID
const [editingStickerId, setEditingStickerId] = useState(null);
       // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢ã€‘å·¥å…·æ çŠ¶æ€æ§åˆ¶ ğŸ‘‡ğŸ‘‡ğŸ‘‡
const [toolbarTab, setToolbarTab] = useState('items'); // é€‰é¡¹: 'items' | 'style' | 'text'
const [isToolbarCollapsed, setIsToolbarCollapsed] = useState(false); // æ§åˆ¶æœ€å°åŒ–
// ğŸ‘†ğŸ‘†ğŸ‘†ã€æ–°å¢ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†
         // ğŸŸ¢ æ–°å¢ï¼šä¹¦ç­¾ç›¸å…³çŠ¶æ€
    const [bookmarks, setBookmarks] = useState(album.bookmarks || []);
    const [isBookmarkMode, setIsBookmarkMode] = useState(false); // æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºâ€œæ·»åŠ ä¹¦ç­¾â€çš„UI
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ åœ¨è¿™é‡Œæ’å…¥è¿™ä¸€è¡Œæ–°ä»£ç  ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const [placingStamp, setPlacingStamp] = useState(null); 
    // ğŸ‘†ğŸ‘†ğŸ‘† å®ƒçš„ä½œç”¨æ˜¯ï¼šè®°å½•å½“å‰ä½ é€‰ä¸­äº†å“ªä¸ªå°ç« æ¨¡æ¿
    const [pendingPhotos, setPendingPhotos] = useState([]); 
        // æ·»åŠ  texture: 'plain'
// ğŸŸ¢ ä¿®æ”¹ 1ï¼šåœ¨åˆå§‹çŠ¶æ€ä¸­å¢åŠ  fontFamily
    const [stickerSettings, setStickerSettings] = useState({ 
        color: '#4a403a', 
        bgColor: '#ffecb3', 
        shape: 'rect', 
        pattern: 'none', 
        texture: 'plain', 
        fontSize: 24, 
        isGlow: false,
        // ğŸ‘‡ æ–°å¢è¿™ä¸€è¡Œï¼šé»˜è®¤ä½¿ç”¨æ‰‹å†™ä½“
        fontFamily: "'Caveat', 'ZCOOL KuaiLe', cursive" 
    });
        const [toolbarPosition, setToolbarPosition] = useState(null);
        const containerRef = useRef(null);
        const images = album.images || []; const stickers = album.stickers || []; const layoutData = album.layout || {}; 
        
          // ğŸŸ¢ ã€è¯·åœ¨è¿™é‡Œæ’å…¥æ–°ä»£ç ã€‘ ğŸŸ¢
    const doodles = album.doodles || {}; 

 
        const coverStyle = COVER_STYLES.find(s => s.id === album.style) || COVER_STYLES[0];
        const bookPoem = useMemo(() => { if (album.poem) return album.poem; return BACK_COVER_POEMS[album.id % BACK_COVER_POEMS.length]; }, [album]);
        const sheets = useMemo(() => { const l = [{ id: 'cover', type: 'cover' }]; for (let i = 0; i < images.length; i += 2) { l.push({ id: `sheet-${i}`, type: 'content', frontIdx: i, backIdx: i + 1, front: images[i], back: images[i + 1] || null }); } l.push({ id: 'back-cover', type: 'back-cover' }); return l; }, [images]);
const currentSpreadLabel = useMemo(() => {
    // 0. ã€æ–°å¢ã€‘ç©ºç›¸å†Œç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ²¡å›¾ï¼Œç›´æ¥æ˜¾ç¤º 0 Page
    if (images.length === 0) return "0 Page";

    // 1. å°é¢å’Œå°åº•
    if (flippedIndex === 0) return "Cover";
    if (flippedIndex === sheets.length) return "Back Cover";

    // 2. ç¬¬ä¸€é¡µï¼ˆç‰¹æ®Šå¤„ç†ï¼šå·¦ä¾§æ˜¯My Collectionï¼Œå³ä¾§æ˜¯Page 1ï¼‰
    if (flippedIndex === 1) return "Page 1";

    // 3. è®¡ç®—ä¸­é—´é¡µç 
    const leftPageNum = (flippedIndex - 1) * 2;
    const rightPageNum = leftPageNum + 1;

    // 4. åˆ¤æ–­å³ä¾§æ˜¯ä¸æ˜¯å°åº•é¡µ
    if (flippedIndex === sheets.length - 1) {
        return `Page ${leftPageNum}`;
    }

    // 5. æ­£å¸¸åŒé¡µæ˜¾ç¤º
    return `Page ${leftPageNum}-${rightPageNum}`;
    
    // æ³¨æ„ï¼šæˆ‘åœ¨ä¾èµ–æ•°ç»„é‡Œè¡¥ä¸Šäº† images.lengthï¼Œç¡®ä¿ç›¸å†Œå˜åŠ¨æ—¶èƒ½åŠæ—¶æ›´æ–°
}, [flippedIndex, sheets.length, images.length]);

  // ğŸŸ¢ è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ»‘å—æ•°å€¼ï¼Œå®æ—¶è®¡ç®—é¡µç æ–‡å­— (ä¸ç”¨è¯»æ•°æ®åº“)
    const getSliderLabel = (idx) => {
        if (images.length === 0) return "";
        if (idx === 0) return "Cover";
        if (idx === sheets.length) return "Back Cover";
        if (idx === 1) return "Page 1";
        
        const leftPageNum = (idx - 1) * 2;
        const rightPageNum = leftPageNum + 1;
        
        if (idx === sheets.length - 1) {
             return `Page ${leftPageNum}`;
        }
        return `Page ${leftPageNum}-${rightPageNum}`;
    };
    // ğŸ‘†ğŸ‘†ğŸ‘† ã€æ’å…¥ç»“æŸã€‘ ğŸ‘†ğŸ‘†ğŸ‘†

        useEffect(() => { const timer = setTimeout(() => { setIsVisible(true); }, 10); return () => clearTimeout(timer); }, []);
        useEffect(() => { 
        if (selectedStickerId) { 
            const s = stickers.find(st => st.id === selectedStickerId); 
            if (s) { 
                setStickerSettings({ 
                    color: s.color, 
                    bgColor: s.bgColor, 
                    shape: s.shape, 
                    pattern: s.pattern, 
                    texture: s.texture || 'plain', 
                    fontSize: s.fontSize || 24, 
                    isGlow: s.isGlow,
                    
                    // ğŸŸ¢ ä¿®æ”¹ 2ï¼šåŒæ­¥è¯»å–é€‰ä¸­è´´çº¸çš„å­—ä½“
                    // é€»è¾‘è§£é‡Šï¼šå¦‚æœè´´çº¸é‡Œå­˜äº† fontFamily å°±ç”¨å­˜çš„ï¼›
                    // å¦‚æœæ˜¯æ—§è´´çº¸æ²¡æœ‰å­˜è¿™ä¸ªå­—æ®µï¼Œå°±å›é€€åˆ°é»˜è®¤å­—ä½“ã€‚
                    fontFamily: s.fontFamily || "'Caveat', 'ZCOOL KuaiLe', cursive"
                }); 
                
                 
            } 
        } 
    }, [selectedStickerId]);
        useEffect(() => { 
            const handleResize = () => { 
                const screenW = window.innerWidth; 
                const screenH = window.innerHeight; 
                
                // ä¹¦æœ¬åŸå§‹å°ºå¯¸ (8:5 æ¯”ä¾‹, å•é¡µ 4:5)
                const BOOK_W = 960; 
                const BOOK_H = 600; 
                
                // ğŸŸ¢ ä¿®å¤ 1ï¼šé’ˆå¯¹æ‰‹æœºç«¯ä¼˜åŒ– UI é¢„ç•™é«˜åº¦
                // ç”µè„‘ç«¯ä¿ç•™ 200px ç»™å·¥å…·æ ï¼Œæ‰‹æœºç«¯åªéœ€è¦ä¿ç•™ 120px (ç»™é¡¶éƒ¨å’Œåº•éƒ¨ä¸€ç‚¹ç©ºé—´å³å¯)
                const isMobile = screenW < 768;
                const UI_H = isImmersive ? 0 : (isMobile ? 120 : 200); 
                
                // ğŸŸ¢ ä¿®å¤ 2ï¼šå¢åŠ å®‰å…¨è¾¹è· (wF)
                // ç”µè„‘ç«¯ 0.95ï¼Œæ‰‹æœºç«¯ 0.92 (ç•™å‡ºæ›´å¤šè¾¹ç¼˜ï¼Œé˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨æ”¾å¤§)
                const wF = isImmersive ? 1.0 : (isMobile ? 0.92 : 0.95); 
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šå– å®½åº¦é€‚é… å’Œ é«˜åº¦é€‚é… ä¸­çš„è¾ƒå°å€¼ï¼Œç¡®ä¿å®Œå…¨æ”¾å…¥å±å¹•
                let s = Math.min(
                    (screenW * wF) / BOOK_W, 
                    (screenH - UI_H) / BOOK_H
                ); 
                
                // é™åˆ¶æœ€å¤§æœ€å°ç¼©æ”¾
                if (s > 1.25) s = 1.25; 
                if (s < 0.2) s = 0.2; // å…è®¸ç¼©å°åˆ°æ›´å°ï¼Œé˜²æ­¢æ‰‹æœºå±å¤ªçª„æ”¾ä¸ä¸‹
                
                setScale(s); 
            }; 
            
            window.addEventListener('resize', handleResize); 
            handleResize(); 
            return () => window.removeEventListener('resize', handleResize); 
        }, [isImmersive]);


        const handleExit = () => { if (flippedIndex === 0 || flippedIndex === sheets.length) startFadeOut(); else { if (flippedIndex > 1) { const cl = sheets[flippedIndex - 1]; if (cl) setClosingBookContent({ img: cl.back, index: cl.backIdx, isEmpty: !cl.back }); } setFlippedIndex(0); setTimeout(startFadeOut, 600); } };
        const startFadeOut = () => { setIsVisible(false); setTimeout(onBack, 300); };
        
        
        
                // --- ğŸŸ¢ æ–°ä»£ç  (å­˜å…¥æ•°æ®åº“ï¼Œåªå­˜ ID) ---
// --- ğŸŸ¢ ä¿®æ”¹åçš„ handleFileUpload (å¸¦ 30 é¡µä¸Šé™æ£€æŸ¥) ---
const handleFileUpload = async (e) => { 
    const f = Array.from(e.target.files); 
    if (f.length === 0) return; 

    // âœ¨âœ¨âœ¨ æ–°å¢ï¼š30é¡µä¸Šé™æ£€æŸ¥é€»è¾‘ âœ¨âœ¨âœ¨
    const MAX_PAGES = 30;
    
    // å¦‚æœå½“å‰ç…§ç‰‡æ•° + æ–°é€‰ç…§ç‰‡æ•° > 30ï¼Œåˆ™æ‹¦æˆª
    if (images.length + f.length > MAX_PAGES) {
        setConfirmModal({
            isOpen: true,
            title: "Journal Full", // æç¤ºæ ‡é¢˜
            // æç¤ºä¿¡æ¯ï¼šå‘Šè¯‰ç”¨æˆ·è¿˜èƒ½åŠ å‡ å¼ 
            message: `This journal is limited to ${MAX_PAGES} pages.\n\nYou currently have ${images.length} pages, so you can only add ${MAX_PAGES - images.length} more.`,
            confirmText: "Okay",
            isAlert: true, // è®¾ç½®ä¸º Alert æ¨¡å¼ï¼ˆåªæœ‰ç¡®è®¤æŒ‰é’®ï¼‰
            onConfirm: closeConfirm,
            onCancel: closeConfirm
        });
        e.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©æ¡†ï¼Œé˜²æ­¢é‡å¤è§¦å‘
        return; // â›”ï¸ åœæ­¢åç»­ä¸Šä¼ æ“ä½œ
    }
    // âœ¨âœ¨âœ¨ æ£€æŸ¥ç»“æŸ âœ¨âœ¨âœ¨

    
    // --- ä¸‹é¢æ˜¯ä¹‹å‰çš„å‹ç¼©å’Œä¿å­˜é€»è¾‘ (ä¿æŒä¸å˜) ---
    const newImageIds = [];

    for (const file of f) {
        // å…ˆå‹ç¼©
        const compressedBlob = await compressImage(file, 0.8, 1280);
        // å†ä¿å­˜
        const id = await dbUtils.saveImage(compressedBlob);
        newImageIds.push(id);
    }
    
    onUpdateAlbum(album.id, [...images, ...newImageIds], stickers, layoutData); 
    resetModes(); 
    e.target.value = ''; // åˆ«å¿˜äº†æœ€åä¹Ÿè¦æ¸…ç©º input
};


        const closeConfirm = () => setConfirmModal({ ...confirmModal, isOpen: false });

                // ğŸŸ¢ [ä¿®æ­£ç‰ˆ] handleDeleteAction
        // ä¿®å¤äº†å¿½ç•¥æ¶‚é¸¦çš„é—®é¢˜ï¼Œç°åœ¨æ¶‚é¸¦ä¹Ÿä¼šè§¦å‘ "Delete Whole Page" é€‰é¡¹
        const handleDeleteAction = (e, idx) => {
            e.stopPropagation();
            
            // 1. æ£€æŸ¥å„è¦ç´ æ˜¯å¦å­˜åœ¨
            const stickersOnPage = stickers.filter(s => s.pageIndex === idx);
            const hasStickers = stickersOnPage.length > 0;
            const hasPhoto = !!images[idx];
            // âœ¨ æ–°å¢ï¼šæ£€æŸ¥å½“å‰é¡µæ˜¯å¦æœ‰æ¶‚é¸¦
            const hasDoodle = !!doodles[idx]; 

            // 2. å®šä¹‰ä»€ä¹ˆæ˜¯"è£…é¥°" (Decorations)
            // åªè¦æœ‰è´´çº¸ æˆ–è€… æœ‰æ¶‚é¸¦ï¼Œéƒ½ç®—ä½œæœ‰è£…é¥°
            const hasDecorations = hasStickers || hasDoodle;

            if (hasDecorations) {
                // === æƒ…å†µ 1ï¼šæœ‰è£…é¥° (è´´çº¸æˆ–æ¶‚é¸¦) ===
                if (!hasPhoto) {
                    // æƒ…å†µ 1-Aï¼šåªæœ‰è£…é¥°ï¼Œæ²¡æœ‰ç…§ç‰‡ (Empty Page) -> è¯¢é—®æ˜¯å¦æ¸…ç©ºé¡µé¢
                    setConfirmModal({
                        isOpen: true,
                        title: "Clear Page",
                        message: "Delete all stickers and doodles on this empty page?",
                        confirmText: "Clear All",
                        onConfirm: () => { performDelete(idx, true); closeConfirm(); },
                        onCancel: closeConfirm
                    });
                } else {
                    // æƒ…å†µ 1-Bï¼šæœ‰ç…§ç‰‡ + æœ‰è£…é¥° -> è¯¢é—®åˆ å…¨éƒ¨è¿˜æ˜¯åªåˆ ç…§ç‰‡
                    // âœ¨ è¿™é‡Œå°±æ˜¯ä½ æƒ³è¦çš„æ•ˆæœ
                    setConfirmModal({
                        isOpen: true,
                        title: "Page Content",
                        // æç¤ºè¯­å˜å¾—æ›´å‡†ç¡®
                        message: `This page has stickers or doodles. Delete all?`,
                        confirmText: "Delete All",      // åˆ ç…§ç‰‡ + åˆ è£…é¥°
                        secondaryText: "Photo Only",    // åˆ ç…§ç‰‡ + ä¿ç•™è£…é¥° (performDelete ä¼  false)
                        onConfirm: () => { performDelete(idx, true); closeConfirm(); },
                        onSecondary: () => { performDelete(idx, false); closeConfirm(); },
                        onCancel: closeConfirm
                    });
                }
            } else if (hasPhoto) {
                // === æƒ…å†µ 2ï¼šåªæœ‰ç…§ç‰‡ï¼Œæ²¡æœ‰ä»»ä½•è£…é¥° ===
                setConfirmModal({
                    isOpen: true,
                    title: "Delete Photo",
                    message: "Remove this photo?",
                    confirmText: "Delete",
                    onConfirm: () => { performDelete(idx, true); closeConfirm(); },
                    onCancel: closeConfirm
                });
            }
        };

                // ğŸŸ¢ [é‡å†™ç‰ˆ] performDeleteï¼šä¿®å¤å¸ƒå±€é”™ä½é—®é¢˜ï¼Œå®ç°â€œå¸ƒå±€éšç…§ç‰‡ç§»åŠ¨â€
        const performDelete = (idx, delStickers) => {
            // ============================================================
            // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨â€œæ‰“åŒ…ç»‘å®š (Zipping)â€ç­–ç•¥ï¼Œè€Œä¸æ˜¯â€œç´¢å¼•ä½ç§»â€
            // ============================================================
            
            // 1. æ‰“åŒ…ï¼šå…ˆæŠŠæ¯ä¸€é¡µçš„ [ç…§ç‰‡] å’Œ [å®ƒçš„å¸ƒå±€] ç»‘æ­»åœ¨ä¸€èµ·
            const contentPackets = images.map((imgId, i) => ({
                image: imgId,
                layout: layoutData[i] || null // æŠŠå¸ƒå±€æŠ“å–å‡ºæ¥ï¼Œå’Œç…§ç‰‡å­˜åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œ
            }));

            // 2. åˆ é™¤ï¼šç›´æ¥ä»æ•°ç»„ä¸­ç§»é™¤è¿™ä¸€åŒ…æ•°æ®
            // æ­¤æ—¶ï¼Œåé¢çš„æ•°æ®åŒ…ä¼šè‡ªåŠ¨å‰ç§»ï¼Œä¸”å®ƒä»¬å†…éƒ¨çš„ç…§ç‰‡å’Œå¸ƒå±€ä¾ç„¶æ˜¯é”æ­»çš„
            contentPackets.splice(idx, 1);

            // 3. è§£åŒ…ï¼šæŠŠå‰©ä¸‹çš„æ•°æ®é‡æ–°æ‹†åˆ†å› updatedImages å’Œ shiftedLayout
            const updatedImages = contentPackets.map(p => p.image);
            
            // é‡å»ºå¸ƒå±€å¯¹è±¡ (Key éœ€è¦é‡æ–°ç”Ÿæˆä¸º 0, 1, 2...)
            const shiftedLayout = {};
            contentPackets.forEach((packet, newIndex) => {
                if (packet.layout) {
                    shiftedLayout[newIndex] = packet.layout;
                }
            });

            // ============================================================
            // ä¸‹é¢æ˜¯è£…é¥°å“ï¼ˆè´´çº¸/æ¶‚é¸¦/ä¹¦ç­¾ï¼‰çš„å¤„ç†ï¼Œè¿™éƒ¨åˆ†é€»è¾‘ä¿æŒåŸæ ·
            // å› ä¸ºè£…é¥°å“æ˜¯å±äºâ€œé¡µé¢â€çš„ï¼Œä¸æ˜¯å±äºâ€œç…§ç‰‡â€çš„
            // ============================================================

            // 1. å¤„ç†è´´çº¸ (Stickers)
            let finalStickers = delStickers ? stickers.filter(s => s.pageIndex !== idx) : [...stickers];
            finalStickers = finalStickers.map(s => { 
                if (s.pageIndex > idx) return { ...s, pageIndex: s.pageIndex - 1 }; 
                return s; 
            });

            // 2. å¤„ç†æ¶‚é¸¦ (Doodles)
            const currentDoodles = album.doodles || {};
            const newDoodles = {};
            Object.keys(currentDoodles).forEach(key => {
                const pageNum = parseInt(key);
                // é€»è¾‘ï¼šå¦‚æœä¿ç•™è£…é¥°(delStickers=false)ï¼Œåˆ™å½“å‰é¡µçš„æ¶‚é¸¦ä¿ç•™ï¼Œå¹¶å°†å åŠ åˆ°æ–°æ›¿è¡¥ä¸Šæ¥çš„ç…§ç‰‡ä¸Š
                if (pageNum < idx) {
                    newDoodles[pageNum] = currentDoodles[pageNum];
                } else if (pageNum === idx) {
                    if (!delStickers) newDoodles[pageNum] = currentDoodles[pageNum];
                } else if (pageNum > idx) {
                    newDoodles[pageNum - 1] = currentDoodles[pageNum];
                }
            });

            // 3. å¤„ç†ä¹¦ç­¾ (Bookmarks)
            const finalBookmarks = bookmarks.filter(b => b.pageIndex !== idx).map(b => {
                if (b.pageIndex > idx) return { ...b, pageIndex: b.pageIndex - 1 };
                return b;
            });
            
            // 4. åŒæ­¥çŠ¶æ€å’Œæ•°æ®åº“
            setBookmarks(finalBookmarks); 
            
            // å°†é‡å»ºå¥½çš„ shiftedLayout ä¼ è¿›å»
            onUpdateAlbum(album.id, updatedImages, finalStickers, shiftedLayout, finalBookmarks, newDoodles);
            
            // 5. ç¿»é¡µé€»è¾‘ä¿®æ­£
            const newSheetCount = Math.ceil(updatedImages.length / 2) + 2; 
            if (flippedIndex >= newSheetCount) setFlippedIndex(newSheetCount - 1);
            
            if (updatedImages.length === 0) { resetModes(); }
        };



        // ğŸŸ¢ [ä¿®æ”¹] 1. æ›´æ–° handlePhotoClick
        // ç°åœ¨çš„é€»è¾‘æ˜¯ï¼šå¦‚æœæ˜¯ Draw æ¨¡å¼ï¼Œç‚¹å‡»ç…§ç‰‡ä¹Ÿç®—è§¦å‘å…¨é¡µæ¶‚é¸¦
        const handlePhotoClick = (e, idx) => { 
            if (isDrawMode) { 
                e.stopPropagation(); 
                setEditingPhotoIndex(idx); // è§¦å‘æ‰“å¼€å…¨é¡µæ¶‚é¸¦ç¼–è¾‘å™¨
            } else if (isLayoutMode) { 
                e.stopPropagation(); 
                setEditingLayoutIndex(idx); 
            } else if (isStickerMode) {
                setSelectedStickerId(null); 
            }
        };

        // ğŸŸ¢ [æ–°å¢] 2. è·å–é¡µé¢å®Œæ•´å†…å®¹çš„è¾…åŠ©å‡½æ•° (ç”¨äºä¼ ç»™ç¼–è¾‘å™¨åšèƒŒæ™¯)
        const getPageContent = (idx) => {
            return {
                img: images[idx] || null,
                layout: layoutData[idx] || {},
                stickers: stickers.filter(s => s.pageIndex === idx)
            };
        };

        // ğŸŸ¢ [æ–°å¢/æ›¿æ¢] 3. æ›¿ä»£åŸæ¥çš„ handleSaveDoodle
            const handleSavePageDoodle = (doodleDataUrl) => {
        // ä¿å­˜åˆ° doodles å¯¹è±¡ä¸­ï¼Œkey ä¸º pageIndex
        const newDoodles = { ...doodles, [editingPhotoIndex]: doodleDataUrl };
        
        // ğŸŸ¢ ç¡®ä¿è¿™é‡Œçš„ç¬¬ 5 ä¸ªå‚æ•°æ˜¯ bookmarks (ä½¿ç”¨ç»„ä»¶å†…çš„çŠ¶æ€)ï¼Œè€Œä¸æ˜¯ album.bookmarks
        // è™½ç„¶ç”¨ album.bookmarks æš‚æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä½†ä¸ºäº†æ•°æ®ä¸€è‡´æ€§ï¼Œå»ºè®®ç”¨ bookmarks
        onUpdateAlbum(album.id, images, stickers, layoutData, bookmarks, newDoodles);
        
        setEditingPhotoIndex(null);
        setIsDrawMode(false);
    };

        // ğŸŸ¢ [ä¿®å¤ç‰ˆ] handleSaveLayoutï¼šä¿å­˜ä½ç½®æ—¶ï¼Œå¿…é¡»ä¿ç•™åº•ç‰‡ ID
        const handleSaveLayout = (s) => { 
            // 1. è·å–å½“å‰é¡µé¢æ—§çš„å¸ƒå±€æ•°æ®
            const oldLayout = layoutData[editingLayoutIndex] || {};
            
            // 2. åˆå¹¶æ•°æ®ï¼šæ–°çš„ä½ç½®è®¾ç½®(s) + æ—§çš„ originalId (å¦‚æœæœ‰)
            // å¦‚æœä¸è¿™ä¹ˆåšï¼Œ's' ä¼šè¦†ç›–æ‰æ•´ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´ originalId ä¸¢å¤±
            const finalLayoutEntry = { 
                ...s, 
                originalId: oldLayout.originalId // âœ¨ å…³é”®ä¿®å¤ï¼šæŠŠåº•ç‰‡ä¼ ä¸‹å»
            };
            
            const l = { ...layoutData, [editingLayoutIndex]: finalLayoutEntry }; 
            
            onUpdateAlbum(album.id, images, stickers, l); 
            setEditingLayoutIndex(null); 
        };

    // ğŸŸ¢ [é€»è¾‘å‡çº§] å¤„ç†è£åˆ‡åçš„å›¾ç‰‡æ›´æ–° (å¸¦â€œåº•ç‰‡â€ä¿å­˜åŠŸèƒ½)
    const handleUpdateCroppedImage = (newId) => {
        const idx = editingLayoutIndex;
        if (idx === null) return;

        const currentLayout = layoutData[idx] || {};
        const currentImageId = images[idx];

        // âœ¨ æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»å­˜è¿‡â€œåº•ç‰‡â€ (originalId)
        // å¦‚æœ layout é‡Œå·²ç»æœ‰ originalIdï¼Œè¯´æ˜å½“å‰è¿™å¼ å·²ç»æ˜¯è£åˆ‡è¿‡çš„ï¼Œæˆ‘ä»¬ä¿ç•™è€çš„ originalId (æœ€åˆçš„åŸå›¾)
        // å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜å½“å‰è¿™å¼ å°±æ˜¯åŸå›¾ï¼ŒæŠŠå®ƒå­˜ä¸º originalId
        const originalId = currentLayout.originalId || currentImageId;

        const newImages = [...images];
        newImages[idx] = newId;

        const newLayout = { 
            ...layoutData, 
            [idx]: { 
                x: 0, y: 0, scale: 1, rotate: 0, isFull: false, // é‡ç½®ä½ç½®
                originalId: originalId // âœ¨ ä¿å­˜åº•ç‰‡ ID
            } 
        };

        onUpdateAlbum(album.id, newImages, stickers, newLayout);
        // æ³¨æ„ï¼šè£åˆ‡å®Œä¸å…³é—­ç¼–è¾‘å™¨ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹æ•ˆæœ
    };

    // ğŸŸ¢ [æ–°å¢] è¿˜åŸåŸå›¾é€»è¾‘
    const handleRestoreOriginalImage = () => {
        const idx = editingLayoutIndex;
        if (idx === null) return;

        const currentLayout = layoutData[idx] || {};
        
        // å¦‚æœæ²¡æœ‰åº•ç‰‡è®°å½•ï¼Œè¯´æ˜å·²ç»æ˜¯åŸå›¾ï¼Œæ— éœ€è¿˜åŸ
        if (!currentLayout.originalId) return;

        const newImages = [...images];
        newImages[idx] = currentLayout.originalId; // æ¢å¤ä¸ºåº•ç‰‡ ID

        // æ¸…é™¤ originalId æ ‡è®°ï¼Œå› ä¸ºç°åœ¨å®ƒå°±æ˜¯åŸå›¾äº†
        const { originalId, ...resetLayout } = currentLayout;
        
        // åŒæ—¶é‡ç½®ä¸€ä¸‹ä½ç½®ï¼Œé˜²æ­¢ä¹‹å‰çš„è£åˆ‡åç§»å¯¼è‡´åŸå›¾æ˜¾ç¤ºä½ç½®å¥‡æ€ª
        const finalLayout = { 
            ...layoutData, 
            [idx]: { ...resetLayout, x: 0, y: 0, scale: 1, rotate: 0 } 
        };

        onUpdateAlbum(album.id, newImages, stickers, finalLayout);
    };


        const handleInitAddSticker = () => setIsPlacingSticker(!isPlacingSticker);
        const resetModes = (keep=false) => { if(!keep) { setIsPlacingSticker(false); setIsStickerMode(false); setPlacingStamp(null); setIsBookmarkMode(false);} setIsDeleteMode(false); setIsDrawMode(false); setIsLayoutMode(false); };
        
        // ğŸŸ¢ å¼€å¯è´´çº¸è£åˆ‡
        const handleCropSticker = (id) => {
            setEditingStickerId(id);
        };

    // ğŸŸ¢ [ä¿®å¤ç‰ˆ] ä¿å­˜è´´çº¸è£åˆ‡ç»“æœ (å¢åŠ â€œåº•ç‰‡â€ä¿å­˜é€»è¾‘)
    const handleSaveStickerCrop = (newImageId) => {
        if (!editingStickerId) return;
        
        // 1. å…ˆæ‰¾åˆ°å½“å‰æ­£åœ¨ç¼–è¾‘çš„è´´çº¸å¯¹è±¡
        const currentSticker = stickers.find(s => s.id === editingStickerId);
        if (!currentSticker) return;

        // 2. å…³é”®é€»è¾‘ï¼šç¡®å®šè°æ˜¯â€œåº•ç‰‡â€
        // å¦‚æœå®ƒå·²ç»æœ‰ originalSrcï¼Œè¯´æ˜ä¹‹å‰åˆ‡è¿‡ï¼Œåº•ç‰‡è¿˜æ˜¯é‚£ä¸ªè€çš„ originalSrc
        // å¦‚æœå®ƒæ²¡æœ‰ originalSrcï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡åˆ‡ï¼Œå½“å‰çš„ src å°±æ˜¯åº•ç‰‡
        const originalSrc = currentSticker.originalSrc || currentSticker.src;

        // 3. æ›´æ–°è´´çº¸æ•°æ®
        const updatedStickers = stickers.map(s => 
            s.id === editingStickerId ? { 
                ...s, 
                src: newImageId,        // å˜æˆè£åˆ‡åçš„æ–°å›¾
                originalSrc: originalSrc // âœ¨ æ°¸ä¹…ä¿å­˜åŸå›¾ ID
            } : s
        );
        
        onUpdateAlbum(album.id, images, updatedStickers, layoutData);
        setEditingStickerId(null); 
    };
    // ğŸŸ¢ [æ–°å¢] è¿˜åŸè´´çº¸åŸå›¾
    const handleRestoreSticker = () => {
        if (!editingStickerId) return;

        const updatedStickers = stickers.map(s => {
            // åªæœ‰å½“ ID åŒ¹é…ä¸”ç¡®å®æœ‰åº•ç‰‡è®°å½•æ—¶æ‰è¿˜åŸ
            if (s.id === editingStickerId && s.originalSrc) {
                return {
                    ...s,
                    src: s.originalSrc,  // 1. æ¢å¤å›¾ç‰‡ä¸ºåŸå›¾
                    // originalSrc: null // 2. (å¯é€‰) æ˜¯å¦æ¸…é™¤åº•ç‰‡è®°å½•ï¼Ÿ
                    // å»ºè®®ä¿ç•™ originalSrc: null è¿™ä¸€è¡Œï¼Œ
                    // è¿™æ ·è¿˜åŸåï¼Œç³»ç»Ÿå°±çŸ¥é“å®ƒç°åœ¨æ˜¯åŸå›¾çŠ¶æ€äº†ï¼Œ"è¿˜åŸ"æŒ‰é’®ä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚
                    originalSrc: null 
                };
            }
            return s;
        });

        onUpdateAlbum(album.id, images, updatedStickers, layoutData);
        // è¿˜åŸåä¸å…³é—­ç¼–è¾‘å™¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å˜å›å»äº†
    };

        
    // --- âœ‚ï¸ è¯·ç”¨è¿™æ®µä»£ç æ›¿æ¢åŸæœ‰çš„é”™è¯¯åµŒå¥—ä»£ç  âœ‚ï¸ ---

    // 1. ç‹¬ç«‹çš„ addStampToPage å‡½æ•°
    const addStampToPage = (idx, tmpl) => {
        const newStamp = {
            id: Date.now(),
            pageIndex: idx, 
            type: 'stamp',
            text: typeof tmpl.text === 'function' ? tmpl.text() : tmpl.text,
            subText: tmpl.sub,
            icon: tmpl.icon,
            stampShape: tmpl.shape,
            color: tmpl.color,
            bgColor: 'transparent', 
            x: 50 + (Math.random() * 10 - 5),
            y: 50 + (Math.random() * 10 - 5),
            width: 130,
            height: 130,
            rotation: (Math.random() - 0.5) * 20,
            scale: 1,
            fontSize: 24,
            texture: 'plain' 
        };
        onUpdateAlbum(album.id, images, [...stickers, newStamp], layoutData);
        setSelectedStickerId(newStamp.id);
        setPlacingStamp(null); 
    }; // â¬…ï¸ æ³¨æ„è¿™é‡Œç»“æŸäº†

    // 2. ç‹¬ç«‹çš„ handleAddBookmark å‡½æ•° (å·²ä¿®æ­£ä¸Šé™ä¸º12ï¼Œå¹¶ç¡®ä¿æ— CancelæŒ‰é’®)
        // 2. ç‹¬ç«‹çš„ handleAddBookmark å‡½æ•° (å·²ä¿®æ­£ä¸Šé™ä¸º17)
    const handleAddBookmark = (pageIndex) => {
        // [ä¿®æ”¹] ä¸Šé™æ”¹ä¸º 17
        if (bookmarks.length >= 17) {
            setConfirmModal({
                isOpen: true,
                title: "Journal Full",
                message: "You can only add up to 17 bookmarks.",
                confirmText: "Okay",
                onConfirm: closeConfirm,
                isAlert: true 
            });
            return;
        }
        if (bookmarks.some(b => b.pageIndex === pageIndex)) {
            return;
        }

        // 17è‰²æŒ‰é¡ºåºå¾ªç¯å–è‰²
        const nextColor = BOOKMARK_COLORS[bookmarks.length % BOOKMARK_COLORS.length];

        const newBookmark = {
            id: Date.now(),
            pageIndex: pageIndex,
            color: nextColor,
            name: ""
        };

        const newBookmarks = [...bookmarks, newBookmark];
        setBookmarks(newBookmarks);
        onUpdateAlbum(album.id, images, stickers, layoutData, newBookmarks); 
        setIsBookmarkMode(false); 
    };


    // --- âœ‚ï¸ è¡¥å……ä¸¢å¤±çš„åˆ é™¤ä¹¦ç­¾å‡½æ•° (è¯·æ’å…¥åˆ° jumpToPage å‡½æ•°ä¸Šæ–¹æˆ–ä¸‹æ–¹) âœ‚ï¸ ---
    const handleDeleteBookmark = (id) => {
        const newBookmarks = bookmarks.filter(b => b.id !== id);
        setBookmarks(newBookmarks);
        // åŒæ­¥æ›´æ–°åˆ°æ•°æ®åº“
        onUpdateAlbum(album.id, images, stickers, layoutData, newBookmarks);
    };
    // --- âœ‚ï¸ ç»“æŸ âœ‚ï¸ ---

    // æ–°å¢ï¼šæ›´æ–°ä¹¦ç­¾å±æ€§ (ç”¨äºé‡å‘½å)
    const handleUpdateBookmark = (id, updates) => {
        const newBookmarks = bookmarks.map(b => b.id === id ? { ...b, ...updates } : b);
        setBookmarks(newBookmarks);
        onUpdateAlbum(album.id, images, stickers, layoutData, newBookmarks);
    };


    // 4. ç‹¬ç«‹çš„ jumpToPage å‡½æ•°
    // --- ğŸŸ¢ ä¿®æ”¹åçš„ jumpToPage (ç¬é—´è·³è½¬ï¼Œæ— åŠ¨ç”») ---
const jumpToPage = (sheetIndex) => {
    // 1. å€Ÿç”¨ isDraggingSlider çŠ¶æ€è®¾ç½®ä¸º trueã€‚
    // åœ¨ JSX æ¸²æŸ“é€»è¾‘é‡Œï¼Œåªè¦è¿™ä¸ªæ˜¯ trueï¼Œå°±ä¼šç§»é™¤ 'smooth-flip' ç±»ï¼Œä»è€Œç¦ç”¨åŠ¨ç”»ã€‚
    setIsDraggingSlider(true);
    
    // 2. ç«‹å³æ›´æ–°é¡µç 
    setFlippedIndex(sheetIndex);

    // 3. è®¾ç½®ä¸€ä¸ªå°å»¶è¿Ÿï¼ˆ50æ¯«ç§’ï¼‰ï¼Œç­‰é¡µé¢æ¸²æŸ“åˆ°æ–°ä½ç½®åï¼Œå†æŠŠåŠ¨ç”»èƒ½åŠ›æ¢å¤ã€‚
    // è¿™æ ·ä¸‹æ¬¡æ‰‹åŠ¨ç¿»ä¸€é¡µæ—¶ï¼Œä¾ç„¶æœ‰åŠ¨ç”»ï¼Œä½†è¿™æ¬¡è·³è½¬æ˜¯ç¬é—´çš„ã€‚
    setTimeout(() => {
        setIsDraggingSlider(false);
    }, 50);
};


    // --- âœ‚ï¸ æ›¿æ¢ç»“æŸ âœ‚ï¸ ---

        const addStickerToPage = (idx) => { 
    // ç¡®ä¿æŠŠ ...stickerSettings ä¼ è¿›å»ï¼Œè¿™æ ·æ–°å»ºçš„è´´çº¸å°±ä¼šå¸¦æœ‰å½“å‰çš„ texture
    const s = { 
        id: Date.now(), 
        pageIndex: idx, 
        text: "Note", 
        x: 50, y: 50, width: 140, height: 140, 
        rotation: 0, scale: 1, 
        ...stickerSettings // è¿™é‡Œä¼šè‡ªåŠ¨åŒ…å« texture
    }; onUpdateAlbum(album.id, images, [...stickers, s], layoutData); setSelectedStickerId(s.id); setIsPlacingSticker(false); };
        const updateSticker = (id, p) => { if (p.isEditing) { const s = stickers.find(st => st.id === id); if(s) { setTempTextValue(s.text); setSelectedStickerId(id); setIsTextEditModalOpen(true); } return; } onUpdateAlbum(album.id, images, stickers.map(s => s.id === id ? { ...s, ...p } : s), layoutData); };
        const handleToolbarChange = (c) => { setStickerSettings(p => ({...p, ...c})); if (selectedStickerId) updateSticker(selectedStickerId, c); };
        const deleteSticker = (id) => { onUpdateAlbum(album.id, images, stickers.filter(s => s.id !== id), layoutData); setSelectedStickerId(null); };
        const saveStickerText = () => { if (selectedStickerId) updateSticker(selectedStickerId, { text: tempTextValue }); setIsTextEditModalOpen(false); };
    // âœ‚ï¸ æ–°é€»è¾‘ï¼šå¤„ç†è‡ªå®šä¹‰è´´çº¸ä¸Šä¼  (ä¸å†è‡ªåŠ¨è´´ï¼Œè€Œæ˜¯å­˜å…¥ pendingPhotos ç­‰å¾…ç‚¹å‡»)
        // --- ğŸŸ¢ ä¿®æ”¹åçš„è´´çº¸ä¸Šä¼ é€»è¾‘ (å­˜å…¥æ•°æ®åº“ï¼Œåªæ‹¿ ID) ---
    const handleCustomStickerUpload = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        // 1. è¿™é‡Œçš„å˜åŒ–ï¼šä¸å†è°ƒç”¨ convertFileToBase64
        // è€Œæ˜¯ç›´æ¥è°ƒç”¨ dbUtils.saveImage è·å– ID
        const imageIds = await Promise.all(files.map(async (file) => {
            return await dbUtils.saveImage(file);
        }));

        // 2. å­˜å…¥æš‚å­˜åŒº (pendingPhotos é‡Œçš„å†…å®¹å˜æˆäº† ID)
        setPendingPhotos(imageIds);

        resetModes(true); 
        e.target.value = ''; 
    };


    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°çš„ç‚¹å‡»å“åº”å‡½æ•° (å¢åŠ äº†å¯¹â€œè´´ç…§ç‰‡â€çš„æ”¯æŒ) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const handlePageAreaClick = (e, idx) => { 
        // ğŸŸ¢ ä¼˜å…ˆçº§ 0 (æ–°å¢): æ¶‚é¸¦æ¨¡å¼ (Draw Mode)
        // åªè¦æ˜¯æ¶‚é¸¦æ¨¡å¼ï¼Œç‚¹å“ªé‡Œï¼ˆåŒ…æ‹¬ç©ºç™½å¤„ï¼‰éƒ½æ‰“å¼€ç¼–è¾‘å™¨
        if (isDrawMode) {
            e.stopPropagation();
            setEditingPhotoIndex(idx); // æ‰“å¼€å…¨é¡µç¼–è¾‘å™¨
            return;
        }

        // ğŸŸ¢ ä¼˜å…ˆçº§ 1: è´´ç…§ç‰‡ (Photo Mode)
        if (pendingPhotos.length > 0) {
            e.stopPropagation(); 
            // ... (åŸæœ‰çš„è´´ç…§ç‰‡é€»è¾‘) ...
            const newStickers = pendingPhotos.map((src, i) => ({
                id: Date.now() + i,
                pageIndex: idx, 
                src: src, 
                x: 50 + (i * 5), 
                y: 50 + (i * 5),
                width: 150,
                height: 150,
                rotation: (Math.random() - 0.5) * 10,
                scale: 1
            }));
            onUpdateAlbum(album.id, images, [...stickers, ...newStickers], layoutData);
            if(newStickers.length > 0) setSelectedStickerId(newStickers[0].id);
            setPendingPhotos([]); 
            return; 
        }

        // ğŸŸ¢ ä¼˜å…ˆçº§ 2: ç›–ç« æ¨¡å¼
        if (placingStamp) {
            e.stopPropagation(); 
            addStampToPage(idx, placingStamp); 
            return; 
        }

        // ğŸŸ¢ ä¼˜å…ˆçº§ 3: ä¾¿åˆ©è´´æ¨¡å¼
        if (isPlacingSticker) { 
            e.stopPropagation(); 
            addStickerToPage(idx); 
        } 
    };

        const handleBookClick = (e) => { 
            if (isDeleteMode || isDrawMode || isLayoutMode || isFlipping || isPlacingSticker || isStickerMode || !containerRef.current) return; 
            const rect = containerRef.current.getBoundingClientRect(); 
            if (e.clientX < (rect.left + rect.width / 2)) { if (flippedIndex > 0) { setIsFlipping(true); setMovingPageIndex(flippedIndex - 1); setFlippedIndex(p => p - 1); setTimeout(() => { setIsFlipping(false); setMovingPageIndex(null); }, 600); } } 
            else { if (flippedIndex < sheets.length) { setIsFlipping(true); setMovingPageIndex(flippedIndex); setFlippedIndex(p => p + 1); setTimeout(() => { setIsFlipping(false); setMovingPageIndex(null); }, 600); } } 
        };
        
    // ğŸŸ¢ æ‰¾åˆ° BookView ç»„ä»¶å†…éƒ¨çš„ renderPhoto å‡½æ•°
    const renderPhoto = (imgSrc, idx, isFull) => { 
    const l = layoutData[idx] || { x: 0, y: 0, scale: 1, rotate: 0 }; 
    return ( 
        <div className={`w-full h-full relative overflow-hidden`}>
            {/* ğŸ‘‡ å¿…é¡»æ˜¯ AsyncImageï¼Œå®ƒæ‰èƒ½æŠŠ ID å˜æˆå›¾ç‰‡ */}
            <AsyncImage 
                src={imgSrc} 
                className={`absolute top-1/2 left-1/2 w-full h-full transition-transform origin-center pointer-events-none select-none object-contain`} 
                style={{ 
                    transform: `translate(-50%, -50%) translate(${l.x}%, ${l.y}%) rotate(${l.rotate}deg) scale(${l.scale})`, 
                    filter: isFull ? 'none' : 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))' 
                }} 
            />
        </div> 
    ); 
};





        const shouldShowToolbar = isStickerMode;
        const bookTranslateX = flippedIndex === 0 ? '-25%' : (flippedIndex === sheets.length ? '25%' : '0%');
        const topBarText = pendingPhotos.length > 0 ? "Tap any page to place photos" : (isBookmarkMode ? "Tap page edge to add bookmark" : isDeleteMode ? "Delete photos" : isDrawMode ? "Tap photo to doodle" : isLayoutMode ? "Tap photo to adjust layout" : isPlacingSticker ? "Tap a page to place your note" : isStickerMode ? "Manage sticky notes" : album.title);
        const renderEditOverlay = (icon, colorClass, onClick) => (<div className="absolute inset-0 z-[100] flex items-center justify-center bg-white/20 backdrop-blur-[1px] cursor-pointer" onClick={onClick}><div className={`bg-white ${colorClass} p-4 rounded-full shadow-lg border-2 border-white/50 animate-bounce`}>{icon}</div></div>);

        return (
            <div className={`fixed inset-0 z-50 flex flex-col h-full w-full select-none cute-pattern-bg overflow-hidden transition-opacity duration-300 ${isVisible ? 'opacity-100' : 'opacity-0'}`}>
                {/* é¡¶éƒ¨å¯¼èˆªæ  (ä¿æŒå¾®å‹åŒ–) */}
                <div className={`h-10 w-full flex items-center justify-between px-3 z-50 shrink-0 transition-all duration-500 absolute top-0 left-0 ${isImmersive ? '-translate-y-full opacity-0 pointer-events-none' : 'translate-y-0 opacity-100'}`}>
                    <button onClick={handleExit} className="bg-white/90 hover:bg-white text-gray-500 hover:text-[#e07a5f] px-2.5 py-1 rounded-full backdrop-blur-sm shadow-sm flex items-center gap-1 transition-all active:scale-95 border border-[#f2e6d9]">
                        <Icons.ArrowLeft size={14} strokeWidth={2.5} /> 
                        <span className="font-bold text-[10px] uppercase tracking-wider hidden sm:inline">Library</span>
                    </button>

                    <div
                        onClick={() => {
                            if (!isDeleteMode && !isDrawMode && !isStickerMode && !isPlacingSticker && !isLayoutMode) {
                                setIsPageJumpOpen(!isPageJumpOpen);
                            }
                        }}
                        className={`flex items-center gap-1.5 backdrop-blur-md px-3 py-1 rounded-full border shadow-sm transition-all duration-300 absolute left-1/2 -translate-x-1/2 select-none z-[60] cursor-pointer
                        ${isDeleteMode ? 'bg-red-50 border-red-200 text-red-500' :
                          isDrawMode ? 'bg-blue-50 border-blue-200 text-blue-500' :
                          isLayoutMode ? 'bg-green-50 border-green-200 text-green-600' :
                          (isStickerMode || isPlacingSticker) ? 'bg-yellow-50 border-yellow-200 text-yellow-600' :
                          isBookmarkMode ? 'bg-pink-50 border-pink-200 text-pink-600' :
                          'bg-white/80 border-white/60 text-gray-600 hover:bg-white hover:scale-105 active:scale-95'}`}
                    >
                        {!isDeleteMode && !isDrawMode && !isStickerMode && !isPlacingSticker && !isLayoutMode && (
                            <div className={`w-1.5 h-1.5 rounded-full ${coverStyle.bgClass}`}></div>
                        )}
                        <span className="font-bold tracking-wide text-[10px] truncate max-w-[140px] sm:max-w-[200px]">
                                                    {/* é€»è¾‘ï¼šå¦‚æœæ­£åœ¨æ‹–åŠ¨(isDraggingSlider)ï¼Œæ˜¾ç¤ºå®æ—¶é¡µç ï¼›å¦åˆ™æ˜¾ç¤ºæ­£å¸¸æ ‡é¢˜ */}
                        {isDraggingSlider 
                            ? getSliderLabel(sliderValue) 
                            : topBarText
                        }

                        {/* ä¸‹é¢è¿™æ®µä¿æŒä¸å˜ï¼Œåªåœ¨è¿™ä¸ªæ‹¬å·é‡Œåšé€»è¾‘åˆ¤æ–­ */}
                        {!isDeleteMode && !isDrawMode && !isStickerMode && !isPlacingSticker && !isLayoutMode && !isDraggingSlider && (
                            <span className="ml-1 opacity-60 font-serif italic font-normal">
                                {currentSpreadLabel}
                            </span>
                        )}
                        
                        {/* ğŸ‘†ğŸ‘†ğŸ‘† ã€ä¿®æ”¹ç»“æŸã€‘ ğŸ‘†ğŸ‘†ğŸ‘† */}
                        </span>
                    </div>

                    <button onClick={() => setIsImmersive(true)} className="bg-white/90 hover:bg-white text-gray-400 hover:text-[#5d5550] w-7 h-7 rounded-full backdrop-blur-sm shadow-sm flex items-center justify-center transition-all active:scale-95 border border-[#f2e6d9]" title="Focus Mode">
                        <Icons.Maximize size={14} />
                    </button>
                </div>

{/* ğŸŸ¢ è¶…è¿·ä½ ç‰ˆé¡µé¢è·³è½¬æ¡ (ç¼©å°50%) */}
{isPageJumpOpen && (
    <div className="absolute top-14 left-1/2 -translate-x-1/2 z-[59] bg-white/80 backdrop-blur-xl border border-white/50 shadow-xl rounded-xl p-2 w-36 animate-in slide-in-from-top-4 fade-in duration-200 flex flex-col gap-1.5">
        <div className="flex justify-between items-center text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">
            <span>Cover</span>
            <span className="text-gray-600 font-serif italic text-[10px]">{currentSpreadLabel}</span>
            <span>End</span>
        </div>
        
        <div className="relative h-4 flex items-center">
            {/* è½¨é“èƒŒæ™¯ï¼šè¿™é‡Œè¦æŠŠ width çš„è®¡ç®—åŸºå‡†æ”¹æˆ sliderValueï¼Œè®©å®ƒè·Ÿç€æ‰‹æ»‘ */}
            <div className="absolute w-full h-1 bg-gray-200 rounded-full overflow-hidden">
                <div className="h-full bg-gradient-to-r from-pink-200 to-yellow-200 transition-all duration-300" 
                     style={{ width: `${(sliderValue / sheets.length) * 100}%` }}></div>
            </div>
            
            {/* ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šInput æ»‘åŠ¨æ¡ */}
            <input 
                type="range" 
                min="0" 
                max={sheets.length} 
                step="1" 
                
                // 1. ç»‘å®šè§†è§‰å˜é‡ï¼Œè€Œä¸æ˜¯ç‰©ç†é¡µç 
                value={sliderValue} 
                
                onPointerDown={() => setIsDraggingSlider(true)} 
                
                // 2. æ‹–åŠ¨æ—¶ï¼šåªæ›´æ–°è§†è§‰å˜é‡ (ä¸è¯»æ•°æ®åº“ï¼Œä¸å¡é¡¿)
                onChange={(e) => setSliderValue(parseInt(e.target.value))}
                
                // 3. æ¾æ‰‹æ—¶ï¼šæ‰çœŸæ­£è§¦å‘ç¿»é¡µ (è¿™æ—¶å€™æ‰å»ç¡¬ç›˜è¯»å›¾)
onPointerUp={(e) => {
    // 1. å…ˆæ”¹é¡µç ï¼æ­¤æ—¶å› ä¸ºä½ æ‰‹è¿˜æ²¡æ¾å¼€ï¼ˆé€»è¾‘ä¸Šï¼‰ï¼ŒisDraggingSlider è¿˜æ˜¯ trueï¼Œæ‰€ä»¥æ²¡æœ‰åŠ¨ç”»ï¼Œæ˜¯ç¬é—´è·³å˜çš„ã€‚
    setFlippedIndex(parseInt(e.target.value));
    
    // 2. å»¶è¿Ÿ 50ms å†å‘Šè¯‰ç³»ç»Ÿâ€œæˆ‘æ‹–å®Œäº†â€ã€‚
    // è¿™èƒ½ç¡®ä¿é¡µé¢å·²ç»â€œç¬ç§»â€åˆ°ä½äº†ï¼Œå†æ¢å¤å¹³æ»‘ç¿»é¡µåŠŸèƒ½ã€‚
    setTimeout(() => {
        setIsDraggingSlider(false);
    }, 50);
}}

                
                className="absolute w-full h-full opacity-0 cursor-pointer z-10"
            />
            
            {/* ğŸŸ¢ å°åœ†ç‚¹æŒ‡ç¤ºå™¨ï¼šleft ä¹Ÿæ”¹æˆæ ¹æ® sliderValue è®¡ç®— */}
            <div className="absolute h-3 w-3 bg-white border border-orange-200 rounded-full shadow-md pointer-events-none transition-all duration-75 flex items-center justify-center" 
                 style={{ left: `calc(${(sliderValue / sheets.length) * 100}% - 6px)` }}>
                <div className="w-1 h-1 bg-orange-300 rounded-full"></div>
            </div>
        </div>
    </div>
)}


                {/* ğŸŸ¢ ä¿®å¤ä¸€ï¼šSticker Tools å·¥å…·æ ï¼ˆæ•´ä½“ç¼©å°20%ï¼‰ */}
                {/* å˜åŒ–ï¼šw-[240px]->w-[190px], p-3->p-2, gap-3->gap-2, text-[10px]->text-[9px] */}
                {shouldShowToolbar && (
                    <DraggableToolbar 
                        externalPosition={toolbarPosition} 
                        initialX={window.innerWidth - 220} 
                        initialY={150} 
                        centerX={false} 
                        className="shadow-2xl backdrop-blur-xl bg-white/95 border border-white/50 rounded-xl w-[190px] max-w-[190px] p-2 gap-2 max-h-[280px]"
                    >
                        <div className="flex items-center justify-between select-none px-1 shrink-0">
                            <div className="flex items-center gap-1.5 text-gray-500">
                                <Icons.StickyNote size={12} />
                                <span className="text-[9px] font-bold uppercase tracking-widest">Tools</span>
                            </div>
                        </div>

                        <div className="flex p-0.5 bg-gray-100/60 rounded-lg shrink-0">
                            {['items', 'style', 'text'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setToolbarTab(tab)}
                                    className={`flex-1 py-1 rounded-md text-[9px] font-bold uppercase tracking-wider transition-all ${
                                        toolbarTab === tab 
                                        ? 'bg-white text-gray-800 shadow-sm' 
                                        : 'text-gray-400 hover:text-gray-600'
                                    }`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar min-h-0 pr-1">
                            {toolbarTab === 'items' && (
                                <div className="flex flex-col gap-2 animate-in fade-in zoom-in-95 duration-200">
                                    <div className="bg-pink-50/50 p-1.5 rounded-lg border border-pink-100/50 flex items-center gap-2 shrink-0">
                                        <label className="cursor-pointer flex flex-col items-center justify-center w-8 h-8 bg-white rounded-lg shadow-sm border border-pink-200 hover:scale-105 transition-transform shrink-0">
                                            <Icons.ImagePlus size={16} className="text-pink-400" />
                                            <input type="file" accept="image/*" className="hidden" onChange={handleCustomStickerUpload} multiple />
                                        </label>
                                        <div className="text-[9px] text-pink-400 font-bold leading-tight">Add Photo<br/><span className="opacity-60 font-normal">From Device</span></div>
                                    </div>

                                    <div className="flex flex-col gap-1">
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider pl-1">Stamps</span>
                                        <div className="grid grid-cols-4 gap-1.5">
                                            {STAMP_TEMPLATES.map(tmpl => (
                                                <button 
                                                    key={tmpl.id}
                                                    onClick={() => {
                                                        if (placingStamp?.id === tmpl.id) setPlacingStamp(null); 
                                                        else { resetModes(true); setPlacingStamp(tmpl); }
                                                    }}
                                                    className={`aspect-square rounded-md flex items-center justify-center transition-all active:scale-90 shadow-sm border ${placingStamp?.id === tmpl.id ? 'bg-gray-800 border-gray-800 text-white' : 'bg-white border-gray-200 hover:border-gray-300'}`}
                                                >
                                                    {tmpl.icon && Icons[tmpl.icon] ? React.createElement(Icons[tmpl.icon], {size: 14, color: placingStamp?.id === tmpl.id ? 'white' : tmpl.color}) : <span className="font-serif font-bold text-[10px]" style={{color: placingStamp?.id === tmpl.id ? 'white' : tmpl.color}}>{tmpl.name.slice(0,1)}</span>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {toolbarTab === 'style' && (
                                <div className="flex flex-col gap-3 animate-in fade-in zoom-in-95 duration-200 pb-1">
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Shape</span>
                                        <div className="grid grid-cols-4 gap-1.5">
                                            {SHAPE_OPTIONS.map(o => (
                                                <button key={o.id} onClick={() => handleToolbarChange({ shape: o.id })} className={`aspect-square flex items-center justify-center text-[9px] font-bold rounded-lg border transition-all ${stickerSettings.shape === o.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`} title={o.name}>
                                                    {o.name.slice(0, 4)} 
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Pattern</span>
                                        <div className="grid grid-cols-3 gap-1.5">
                                            {PATTERN_OPTIONS.map(o => (
                                                <button key={o.id} onClick={() => handleToolbarChange({ pattern: o.id })} className={`py-1.5 text-[9px] font-bold rounded-lg border transition-all text-center truncate ${stickerSettings.pattern === o.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                                    {o.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Texture</span>
                                        <div className="grid grid-cols-3 gap-1.5">
                                            {TEXTURE_OPTIONS.map(t => (
                                                <button key={t.id} onClick={() => handleToolbarChange({ texture: t.id })} className={`px-1 py-1.5 text-[9px] font-bold rounded-md border transition-all text-center truncate ${stickerSettings.texture === t.id ? 'bg-gray-700 text-white border-gray-700' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>{t.name}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Paper Color</span>
                                        <div className="flex flex-wrap gap-1.5"> 
                                            {STICKER_BG_COLORS.map(c => (
                                                <button key={c} onClick={() => handleToolbarChange({ bgColor: c })} className={`w-5 h-5 rounded-full border shrink-0 transition-transform ${stickerSettings.bgColor === c ? 'border-gray-500 scale-110 shadow-md ring-1 ring-white' : 'border-gray-100 hover:scale-110'}`} style={{backgroundColor: c === 'transparent' ? 'white' : c}}>
                                                    {c === 'transparent' && <Icons.Ban size={8} className="text-gray-300 mx-auto" />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {toolbarTab === 'text' && (
                                <div className="flex flex-col gap-2 animate-in fade-in zoom-in-95 duration-200">
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Font Family</span>
                                        <div className="flex flex-col gap-1">
                                            {FONT_OPTIONS.map(f => (
                                                <button key={f.id} onClick={() => handleToolbarChange({ fontFamily: f.family })} className={`w-full text-left px-2 py-1.5 rounded-md border transition-all text-[10px] flex items-center justify-between ${stickerSettings.fontFamily === f.family ? 'bg-gray-700 text-white border-gray-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`} style={{ fontFamily: f.family }}>
                                                    <span className="truncate">{f.name}</span>
                                                    {stickerSettings.fontFamily === f.family && <Icons.Check size={10} />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-1 block pl-1">Ink Color</span>
                                        <div className="flex flex-wrap gap-1.5">
                                            {TEXT_COLORS.map(c => (
                                                <button key={c} onClick={() => handleToolbarChange({ color: c })} className={`w-5 h-5 rounded-full border shrink-0 transition-all ${stickerSettings.color === c ? 'ring-2 ring-offset-1 ring-gray-300 scale-110' : 'border-transparent ring-1 ring-gray-100'}`} style={{backgroundColor: c}} />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="pt-2 border-t border-gray-100 mt-0.5 flex items-center justify-between gap-1 shrink-0">
                            <div className="flex items-center gap-0.5 bg-gray-50/80 rounded-lg p-0.5 border border-gray-100">
                                <button onClick={() => handleToolbarChange({ fontSize: Math.max(10, stickerSettings.fontSize - 2) })} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-gray-500"><span className="text-[9px] font-bold">A-</span></button>
                                <span className="text-[9px] font-bold w-5 text-center text-gray-700">{stickerSettings.fontSize}</span>
                                <button onClick={() => handleToolbarChange({ fontSize: Math.min(60, stickerSettings.fontSize + 2) })} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-gray-500"><span className="text-[9px] font-bold">A+</span></button>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={() => handleToolbarChange({ isGlow: !stickerSettings.isGlow })} className={`w-7 h-7 rounded-lg border flex items-center justify-center transition-all ${stickerSettings.isGlow ? 'bg-yellow-50 border-yellow-200 text-yellow-600' : 'border-transparent hover:bg-gray-50 text-gray-400'}`} title="Highlighter"><Icons.Highlighter size={12} /></button>
                                {selectedStickerId && (
                                    <button onClick={() => deleteSticker(selectedStickerId)} className="w-7 h-7 bg-red-50 text-red-500 rounded-lg border border-red-100 hover:bg-red-100 flex items-center justify-center"><Icons.Trash2 size={12}/></button>
                                )}
                            </div>
                        </div>
                    </DraggableToolbar>
                )}
                
                {/* BOOK AREA */}
                <div className="flex-1 relative flex items-center justify-center overflow-hidden w-full touch-pan-x touch-pan-y" onClick={() => { if(isStickerMode) setSelectedStickerId(null); }}>{isImmersive && ( <button onClick={() => setIsImmersive(false)} className="absolute top-6 right-6 z-[60] bg-white/30 hover:bg-white/50 text-gray-600 p-4 rounded-full backdrop-blur-md transition-all animate-float-gentle border border-white/20 shadow-lg" title="Exit Focus Mode"><Icons.Minimize size={24} /></button> )}
                
 <div 
    className="relative transition-transform duration-700 origin-center" 
    style={{ 
        width: '960px', 
        height: '600px', 
        // ğŸŸ¢ ä¿®å¤ 3ï¼šå¼ºåˆ¶é”å®š CSS çºµæ¨ªæ¯”ï¼Œé˜²æ­¢ä»»ä½•æƒ…å†µä¸‹çš„å˜å½¢
        aspectRatio: '960 / 600',
        transform: `scale(${scale}) translateX(${bookTranslateX})` 
    }}
>
                
                
                <BookmarkTabs bookmarks={bookmarks} flippedIndex={flippedIndex} totalSheets={sheets.length} onJump={jumpToPage} onDelete={handleDeleteBookmark} onUpdate={handleUpdateBookmark} />
                <div ref={containerRef} className="w-full h-full perspective-container relative cursor-pointer book-suspension-shadow" onClick={handleBookClick}>


{sheets.map((sheet, index) => { 
    // 1. è®¡ç®—è·ç¦»
    const distance = Math.abs(index - flippedIndex);
    
    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ 1ï¼šè™šæ‹ŸåŒ– DOM (Virtualization)
    // å¦‚æœé¡µé¢è·ç¦»å½“å‰é¡µè¶…è¿‡ 3 é¡µï¼Œç›´æ¥ä» DOM ä¸­ç§»é™¤ï¼Œä¸è®©æµè§ˆå™¨ GPU æ¸²æŸ“å®ƒã€‚
    // æ‰‹æœºç«¯æ˜¾å­˜æœ‰é™ï¼Œè¿™æ˜¯æ•‘å‘½çš„é€»è¾‘ã€‚
    if (distance > 3) return null;

    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ 2ï¼šæ‡’åŠ è½½å†…å®¹
    // åªæœ‰å½“å‰é¡µå’Œç´§é‚»çš„ä¸€é¡µæ‰åŠ è½½å›¾ç‰‡/è´´çº¸å†…å®¹
    const shouldRenderContent = distance < 3; 

    const frontLayout = layoutData[sheet.frontIdx] || {}; 
    const backLayout = layoutData[sheet.backIdx] || {}; 
    const isFrontFull = frontLayout.isFull || false; 
    const isBackFull = backLayout.isFull || false;
    
    const isFlipped = index < flippedIndex; 
    let zIndex = isFlipped ? index : sheets.length - index; 
    if (index === movingPageIndex) zIndex = 1000; 
    
    const frontStickers = sheet.type === 'content' ? stickers.filter(s => s.pageIndex === sheet.frontIdx) : []; 
    const backStickers = sheet.type === 'content' ? stickers.filter(s => s.pageIndex === sheet.backIdx) : []; 

    return ( 
        <div key={sheet.id} className={`absolute top-0 left-0 w-full h-full transform-style-3d ${isDraggingSlider ? '' : 'smooth-flip'}`} style={{ zIndex: zIndex, transform: isFlipped ? 'rotateY(-180deg)' : 'rotateY(0deg)', pointerEvents: 'none' }}>
            <div className="absolute right-0 top-0 w-[50%] h-full bg-[#fffdf9] rounded-r-3xl shadow-inner backface-hidden overflow-hidden origin-left" style={{ pointerEvents: 'auto' }}> 
                {sheet.type === 'cover' ? ( 
                    <div className={`w-full h-full ${coverStyle.bgClass} flex flex-col items-center justify-center relative border-l-8 ${coverStyle.border}`}><div className="absolute inset-0 cover-texture-bg opacity-30"></div><div className="border-4 border-white/30 p-8 w-[80%] h-[80%] flex flex-col items-center justify-center relative z-10"><Icons.Book className="text-white opacity-90" size={48} /><h1 className="text-5xl font-serif mt-6 mb-2 font-bold tracking-tighter text-white drop-shadow-md text-center">{album.title}</h1><div className="w-12 h-1 bg-white/50 my-4 rounded-full"></div></div></div> 
                ) : sheet.type === 'back-cover' ? ( 
                    <div className="w-full h-full bg-[#fffef9] flex flex-col items-center justify-center relative border-l border-gray-300/20"><div className="p-12 text-center max-w-[80%]"><div className="mb-6 opacity-30 mx-auto w-8 text-[#5d5550]"><Icons.Feather size={32} /></div><p className="poem-text gold-text text-xl whitespace-pre-line">{bookPoem}</p></div></div> 
                ) : ( 
                    <div className={`w-full h-full relative flex flex-col items-center justify-center bg-[#fffdf9] overflow-hidden ${(isPlacingSticker || placingStamp) ? 'cursor-crosshair hover:bg-yellow-50/50 transition-colors' : ''} ${isFrontFull ? 'p-0' : 'p-6 pb-2'}`} style={{ pointerEvents: isFlipped ? 'none' : 'auto' }} onClick={(e) => handlePageAreaClick(e, sheet.frontIdx)}> 
                        {shouldRenderContent ? (
                            <>
                                <div className={`w-full flex-1 relative overflow-hidden transition-all duration-300 ${isDeleteMode ? 'scale-95 ring-4 ring-red-500 rounded-lg' : ''} ${isDrawMode ? 'scale-95 ring-4 ring-blue-300 rounded-lg' : ''} ${isLayoutMode ? 'scale-95 ring-4 ring-green-300 rounded-lg' : ''}`}> {renderPhoto(sheet.front, sheet.frontIdx, isFrontFull)} </div> 
                                <div className="absolute inset-0 pointer-events-none sticker-container overflow-hidden rounded-r-3xl z-10"> {frontStickers.map(s => (<div key={s.id} className={isFlipped ? "pointer-events-none" : "pointer-events-auto"}><DraggableSticker 
    sticker={s} 
    isSelected={selectedStickerId === s.id} 
    onSelect={setSelectedStickerId} 
    onUpdate={updateSticker} 
    onDelete={deleteSticker} 
    onCrop={handleCropSticker} // ğŸŸ¢ ä¼ å…¥å›è°ƒ
    isEditable={isStickerMode} 
/></div>))} </div> 
                                {doodles[sheet.frontIdx] && (<div className="absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-r-3xl"><img src={doodles[sheet.frontIdx]} className="w-full h-full object-contain" alt="doodle" /></div>)}
                                {isBookmarkMode && !bookmarks.some(b => b.pageIndex === sheet.frontIdx) && (<div onClick={(e) => { e.stopPropagation(); handleAddBookmark(sheet.frontIdx); }} className="absolute right-0 top-10 w-12 h-16 border-2 border-dashed border-red-300 bg-red-50/50 rounded-l-lg flex items-center justify-center cursor-pointer hover:bg-red-100 z-[60] animate-pulse"><Icons.Plus className="text-red-400" /></div>)}
                                {isDeleteMode && renderEditOverlay(<Icons.Trash2 size={32} />, "text-red-500", (e) => handleDeleteAction(e, sheet.frontIdx))} 
                                {isDrawMode && renderEditOverlay(<Icons.Pen size={32} />, "text-blue-500", (e) => { e.stopPropagation(); setEditingPhotoIndex(sheet.frontIdx); })} 
                                {isLayoutMode && renderEditOverlay(<Icons.Move size={32} />, "text-green-500", (e) => handlePhotoClick(e, sheet.frontIdx))} 
                            </>
                        ) : (<div className="w-full flex-1 bg-gray-50/10 rounded-lg border-2 border-dashed border-gray-100 flex items-center justify-center"></div>)}
                        <div className={`h-10 flex items-center justify-center w-full mt-2 text-lg z-20 ${isFrontFull ? 'absolute bottom-0 text-white/80 drop-shadow-md font-serif font-bold' : 'gold-text'}`}>- {sheet.frontIdx + 1} -</div> 
                        <div className="absolute left-0 top-0 h-full w-8 bg-gradient-to-r from-black/15 via-black/5 to-transparent pointer-events-none z-20"></div>
                    </div> 
                )} 
            </div> 
            <div className="absolute left-0 top-0 w-[50%] h-full bg-[#fffdf9] rounded-l-3xl shadow-inner backface-hidden overflow-hidden origin-right" style={{ transform: 'rotateY(180deg)', pointerEvents: 'auto' }}> 
                {sheet.type === 'cover' ? ( 
                    closingBookContent ? ( <div className="w-full h-full relative p-6 pb-2 flex flex-col items-center justify-center bg-[#fffdf9]"><div className={`w-full flex-1 relative overflow-hidden`}>{closingBookContent.isEmpty ? (<div className="w-full h-full flex items-center justify-center"><div className="text-gray-300 font-serif italic text-xl">Empty</div></div>) : (renderPhoto(closingBookContent.img, closingBookContent.index, false))}</div><div className="h-10 flex items-center justify-center w-full mt-2 gold-text text-lg">- {closingBookContent.index + 1} -</div></div>) : (<div className="w-full h-full flex items-center justify-center bg-[#fffbf5]"><div className="p-10 border border-gray-300 bg-white shadow-sm w-[70%] aspect-square flex flex-col items-center justify-center text-center"><p className="font-serif italic text-gray-400 mb-4 text-xl">My Collection</p><div className="w-full h-px bg-gray-200 mb-4"></div><p className="text-sm text-gray-500 uppercase tracking-widest">{Math.ceil(images.length / 2) * 2} PAGES</p></div></div>) 
                ) : sheet.type === 'back-cover' ? ( 
                    <div className={`w-full h-full ${coverStyle.bgClass} flex items-center justify-center border-r-8 ${coverStyle.border}`}><div className="absolute inset-0 cover-texture-bg opacity-30"></div><div className="w-16 h-16 rounded-full border-2 border-white/20 flex items-center justify-center relative z-10"><Icons.Library className="text-white/30" /></div></div> 
                ) : ( 
                    <div className={`w-full h-full relative flex flex-col items-center justify-center bg-[#fffdf9] overflow-hidden ${(isPlacingSticker || placingStamp) ? 'cursor-crosshair hover:bg-yellow-50/50 transition-colors' : ''} ${isBackFull ? 'p-0' : 'p-6 pb-2'}`} style={{ pointerEvents: isFlipped ? 'auto' : 'none' }} onClick={(e) => handlePageAreaClick(e, sheet.backIdx)}> 
                        {shouldRenderContent ? (
                            <>
                                <div className={`w-full flex-1 relative overflow-hidden flex items-center justify-center transition-all duration-300 ${isDeleteMode ? 'scale-95 ring-4 ring-red-500 rounded-lg' : ''} ${isDrawMode ? 'scale-95 ring-4 ring-blue-300 rounded-lg' : ''} ${isLayoutMode ? 'scale-95 ring-4 ring-green-300 rounded-lg' : ''}`}> {sheet.back ? (renderPhoto(sheet.back, sheet.backIdx, isBackFull)) : (<div className="text-gray-300 font-serif italic text-xl">Empty</div>)} </div> 
                                <div className="absolute inset-0 pointer-events-none sticker-container overflow-hidden rounded-l-3xl z-10"> {backStickers.map(s => (<div key={s.id} className={isFlipped ? "pointer-events-auto" : "pointer-events-none"}><DraggableSticker 
    sticker={s} 
    isSelected={selectedStickerId === s.id} 
    onSelect={setSelectedStickerId} 
    onUpdate={updateSticker} 
    onDelete={deleteSticker} 
    onCrop={handleCropSticker} // ğŸŸ¢ ä¼ å…¥å›è°ƒ
    isEditable={isStickerMode} 
/></div>))} </div> 
                                {doodles[sheet.backIdx] && (<div className="absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-l-3xl"><img src={doodles[sheet.backIdx]} className="w-full h-full object-contain" alt="doodle" /></div>)}
                                {isBookmarkMode && sheet.back && !bookmarks.some(b => b.pageIndex === sheet.backIdx) && (<div onClick={(e) => { e.stopPropagation(); handleAddBookmark(sheet.backIdx); }} className="absolute left-0 top-10 w-12 h-16 border-2 border-dashed border-red-300 bg-red-50/50 rounded-r-lg flex items-center justify-center cursor-pointer hover:bg-red-100 z-[60] animate-pulse"><Icons.Plus className="text-red-400" /></div>)}
                                {isDeleteMode && renderEditOverlay(<Icons.Trash2 size={32} />, "text-red-500", (e) => handleDeleteAction(e, sheet.backIdx))} 
                                {isDrawMode && renderEditOverlay(<Icons.Pen size={32} />, "text-blue-500", (e) => { e.stopPropagation(); setEditingPhotoIndex(sheet.backIdx); })} 
                                {sheet.back && isLayoutMode && renderEditOverlay(<Icons.Move size={32} />, "text-green-500", (e) => handlePhotoClick(e, sheet.backIdx))} 
                            </>
                        ) : (<div className="w-full flex-1 bg-gray-50/10 rounded-lg border-2 border-dashed border-gray-100 flex items-center justify-center"></div>)}
                        <div className={`h-10 flex items-center justify-center w-full mt-2 text-lg z-20 ${isBackFull ? 'absolute bottom-0 text-white/80 drop-shadow-md font-serif font-bold' : 'gold-text'}`}>- {sheet.backIdx + 1} -</div> 
                        <div className="absolute right-0 top-0 h-full w-8 bg-gradient-to-l from-black/15 via-black/5 to-transparent pointer-events-none z-20"></div>
                    </div> 
                )} 
            </div> 
        </div> 
    );
})}



                </div></div></div>
                
                {/* ğŸŸ¢ ä¿®å¤äºŒï¼šä¾§è¾¹ä¸»å·¥å…·æ  (ç˜¦èº«ç‰ˆï¼šå®½åº¦ä»68pxé™è‡³52pxï¼Œä¸»æŒ‰é’®w-9ï¼Œå­æŒ‰é’®w-7) */}
                <DraggableToolbar 
                    initialX={20} 
                    initialY={window.innerHeight * 0.25}
                    className="fixed z-[100] cursor-move touch-none flex flex-col bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl border border-white/60 p-2 gap-2 w-[52px]"
                >
                    <div className="flex flex-col items-center gap-2">
                        {/* ä¸»æŒ‰é’®: w-11 -> w-9 (36px) */}
                        <div className="relative">
                            {isStickerMode ? (
                                <button onClick={handleInitAddSticker} className={`w-9 h-9 rounded-full flex items-center justify-center shadow-lg border-2 border-white transform transition-transform hover:scale-110 ${isPlacingSticker ? 'bg-yellow-100 text-yellow-600 shadow-yellow-200 rotate-45' : 'bg-gradient-to-tr from-[#fddb92] to-[#d1fdff] text-yellow-700 shadow-yellow-100 animate-pulse'}`}>
                                    <Icons.Plus size={16} />
                                </button>
                            ) : isDeleteMode ? (
                                <div className="w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center border-2 border-white text-gray-300">
                                    <Icons.Trash2 size={16} />
                                </div>
                            ) : (
                                <label className={`cursor-pointer transition-all duration-300 transform hover:scale-110 hover:-translate-y-1 ${isDeleteMode || isDrawMode || isLayoutMode ? 'opacity-50 grayscale pointer-events-none' : ''}`}>
                                    <div className="w-9 h-9 bg-gradient-to-tr from-[#ffb7b2] to-[#ffcfd2] rounded-full flex items-center justify-center shadow-lg shadow-pink-200 border-2 border-white text-white">
                                        <Icons.Plus size={16} />
                                    </div>
                                    <input type="file" multiple accept="image/*" className="hidden-input" onChange={handleFileUpload} />
                                </label>
                            )}
                        </div>

                        <div className="w-4 h-px bg-gray-200"></div>

                        {/* å­æŒ‰é’®: w-9 -> w-7 (28px), icons -> 14 */}
                        <button 
                            onClick={() => { if(images.length === 0) return; const newState = !isBookmarkMode; resetModes(); if(newState) setIsBookmarkMode(true); }} 
                            className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-300 ${isBookmarkMode ? 'bg-pink-100 text-pink-600 scale-110 shadow-inner' : 'hover:bg-pink-50 text-gray-400 hover:text-pink-400'} ${images.length === 0 ? 'opacity-30 cursor-not-allowed' : ''}`} 
                            title="Bookmarks" disabled={images.length === 0}
                        >
                            {isBookmarkMode ? <Icons.Check size={14} strokeWidth={3} /> : <Icons.Bookmark size={14} />}
                        </button>

                        <button 
                            onClick={() => { if(images.length === 0) return; if(isStickerMode) { setIsStickerMode(false); return; } resetModes(); setIsStickerMode(true); }} 
                            className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-300 ${isStickerMode ? 'bg-yellow-100 text-green-600 scale-110 shadow-inner' : 'hover:bg-yellow-50 text-gray-400 hover:text-yellow-400'} ${images.length === 0 ? 'opacity-30 cursor-not-allowed' : ''}`} 
                            title="Stickers" disabled={images.length === 0}
                        >
                            {isStickerMode ? <Icons.Check size={14} strokeWidth={3} /> : <Icons.StickyNote size={14} />}
                        </button>

                        <button 
                            onClick={() => { if(isStickerMode && images.length === 0) return; const newState = !isLayoutMode; resetModes(); if(newState) setIsLayoutMode(true); }} 
                            className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-300 ${isLayoutMode ? 'bg-green-100 text-green-600 scale-110 shadow-inner' : 'hover:bg-green-50 text-gray-400 hover:text-green-400'} ${isStickerMode ? 'opacity-30 cursor-not-allowed' : ''} ${images.length === 0 && !isLayoutMode ? 'opacity-30 cursor-not-allowed' : ''}`} 
                            title="Layout" disabled={(images.length === 0 && !isLayoutMode) || isStickerMode}
                        >
                            {isLayoutMode ? <Icons.Check size={14} /> : <Icons.Move size={14} />}
                        </button>

                        <button 
                            onClick={() => { if(isStickerMode && images.length === 0) return; const newState = !isDrawMode; resetModes(); if(newState) setIsDrawMode(true); }} 
                            className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-300 ${isDrawMode ? 'bg-blue-100 text-blue-500 scale-110 shadow-inner' : 'hover:bg-blue-50 text-gray-400 hover:text-blue-400'} ${isStickerMode ? 'opacity-30 cursor-not-allowed' : ''} ${images.length === 0 && !isDrawMode ? 'opacity-30 cursor-not-allowed' : ''}`} 
                            title="Draw" disabled={(images.length === 0 && !isDrawMode) || isStickerMode}
                        >
                            {isDrawMode ? <Icons.Check size={14} /> : <Icons.Pen size={14} />}
                        </button>

                        <div className="w-4 h-px bg-gray-200"></div>

                        <button 
                            onClick={() => { if(isStickerMode && images.length === 0) return; const newState = !isDeleteMode; resetModes(); if(newState) setIsDeleteMode(true); }} 
                            className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-300 ${isDeleteMode ? 'bg-red-100 text-red-500 rotate-12 scale-110 shadow-inner' : 'hover:bg-red-50 text-gray-400 hover:text-red-400'} ${isStickerMode ? 'opacity-30 cursor-not-allowed' : ''} ${images.length === 0 && !isDeleteMode ? 'opacity-30 cursor-not-allowed' : ''}`} 
                            title="Delete" disabled={(images.length === 0 && !isDeleteMode) || isStickerMode}
                        >
                            {isDeleteMode ? <Icons.Check size={14} /> : <Icons.Trash2 size={14} />}
                        </button>
                    </div>
                </DraggableToolbar>

                {isTextEditModalOpen && (<div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-float-gentle"><h3 className="text-lg font-bold mb-4 text-gray-700">Edit Note</h3><textarea value={tempTextValue} onChange={(e) => setTempTextValue(e.target.value)} className="w-full h-32 p-3 border-2 border-gray-100 rounded-xl focus:border-blue-300 outline-none resize-none font-cute text-2xl bg-yellow-50 text-gray-700" autoFocus></textarea><div className="flex gap-3 mt-4"><button onClick={() => setIsTextEditModalOpen(false)} className="flex-1 py-2 rounded-lg text-gray-500 font-bold hover:bg-gray-100">Cancel</button><button onClick={saveStickerText} className="flex-1 py-2 rounded-lg bg-blue-500 text-white font-bold hover:bg-blue-600 shadow-lg shadow-blue-200">Save</button></div></div></div>)}

                {editingPhotoIndex !== null && (
                    <PhotoEditor 
                        pageIndex={editingPhotoIndex}
                        currentDoodle={doodles[editingPhotoIndex]} 
                        pageContent={getPageContent(editingPhotoIndex)} 
                        onSave={handleSavePageDoodle} 
                        onCancel={() => setEditingPhotoIndex(null)} 
                    />
                )}


{editingLayoutIndex !== null && (
    <ImageTransformEditor 
        imageSrc={images[editingLayoutIndex]} 
        initialSettings={layoutData[editingLayoutIndex]} 
        onSave={handleSaveLayout} 
        onCancel={() => setEditingLayoutIndex(null)} 
        onUpdateImage={handleUpdateCroppedImage} 
        
        // âœ¨ æ–°å¢å‚æ•°
        // æ£€æŸ¥å½“å‰ layoutData æ˜¯å¦æœ‰ originalId å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œè¯´æ˜å¯ä»¥è¿˜åŸ
        hasOriginal={!!(layoutData[editingLayoutIndex] && layoutData[editingLayoutIndex].originalId)}
        onRestore={handleRestoreOriginalImage}
    />
)}

    {/* ğŸŸ¢ è´´çº¸è£åˆ‡ç¼–è¾‘å™¨ */}
    {editingStickerId !== null && (() => {
        const targetSticker = stickers.find(s => s.id === editingStickerId);
        if (!targetSticker) return null;
        
        return (
            <ImageTransformEditor 
                imageSrc={targetSticker.src} 
                initialSettings={{ x: 0, y: 0, scale: 1, rotate: 0, isFull: true }} 
                onSave={() => setEditingStickerId(null)} 
                onCancel={() => setEditingStickerId(null)} 
                onUpdateImage={handleSaveStickerCrop} 
                
                // âœ¨ ä¿®æ”¹ 1ï¼šåˆ¤æ–­æ˜¯å¦æœ‰åº•ç‰‡ (originalSrc)
                hasOriginal={!!targetSticker.originalSrc}
                
                // âœ¨ ä¿®æ”¹ 2ï¼šä¼ å…¥è¿˜åŸå‡½æ•°
                onRestore={handleRestoreSticker}
                
                initialMode="crop"
                enableModeSwitch={false}
            />
        );
    })()}


                
                <ConfirmationModal 
                    isOpen={confirmModal.isOpen} 
                    title={confirmModal.title} 
                    message={confirmModal.message} 
                    confirmText={confirmModal.confirmText} 
                    secondaryText={confirmModal.secondaryText} 
                    cancelText="Cancel" 
                    onConfirm={confirmModal.onConfirm} 
                    onSecondary={confirmModal.onSecondary} 
                    onCancel={confirmModal.onCancel}
                    isAlert={confirmModal.isAlert}
                />
            </div>
        );
    }


    function LibraryView({ albums, onOpenAlbum, onCreateAlbum, onDeleteAlbum, onSaveBackup, onEditAlbum, onRestoreBackup }) {
        const [isCreating, setIsCreating] = useState(false); const [isEditing, setIsEditing] = useState(false); const [editingAlbum, setEditingAlbum] = useState(null); 
        const [newTitle, setNewTitle] = useState('My Journal'); const [selectedStyle, setSelectedStyle] = useState('c-blush'); const [isManageMode, setIsManageMode] = useState(false); const [isAboutOpen, setIsAboutOpen] = useState(false);
        
        // ä¿®å¤ Issue 1: å¼•å…¥è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—çŠ¶æ€
        const [deleteConfirmState, setDeleteConfirmState] = useState({ isOpen: false, albumId: null, albumTitle: '' });

        const openCreateModal = () => { setIsCreating(true); setNewTitle('My Journal'); setSelectedStyle('c-blush'); };
        const openEditModal = (album) => { setEditingAlbum(album); setNewTitle(album.title); setSelectedStyle(album.style); setIsEditing(true); };
        const handleCreate = () => { if (!newTitle.trim()) return; onCreateAlbum(newTitle, selectedStyle); setIsCreating(false); };
        const handleEditSave = () => { if (!newTitle.trim() || !editingAlbum) return; onEditAlbum(editingAlbum.id, newTitle, selectedStyle); setIsEditing(false); setEditingAlbum(null); };
        
        // ä¿®å¤ Issue 1: å¤„ç†æ‰“å¼€è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤æ¡†
        const openDeleteConfirm = (e, album) => {
            e.stopPropagation();
            setDeleteConfirmState({ isOpen: true, albumId: album.id, albumTitle: album.title });
        };

        // ä¿®å¤ Issue 1: å¤„ç†å…³é—­è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤æ¡†
        const closeDeleteConfirm = () => {
            setDeleteConfirmState({ isOpen: false, albumId: null, albumTitle: '' });
        };

        // ä¿®å¤ Issue 1: æ‰§è¡Œå®é™…åˆ é™¤æ“ä½œ
        const handleActualDelete = () => {
            if (deleteConfirmState.albumId) {
                onDeleteAlbum(deleteConfirmState.albumId);
            }
            closeDeleteConfirm();
        };

        const renderAlbumCard = (album, index) => {
            const style = COVER_STYLES.find(s => s.id === album.style) || COVER_STYLES[0];
            return (
                <div key={album.id} className="relative w-full sm:w-1/2 md:w-1/3 lg:w-1/4 px-6 mb-16 pt-8 shelf-row flex justify-center items-end h-[320px] select-none">
                    <div onClick={() => { if(isManageMode) openEditModal(album); else onOpenAlbum(album); }} className={`group relative w-[160px] h-[240px] ${style.bgClass} rounded-r-2xl rounded-l-md shadow-xl cursor-pointer transform transition-all duration-300 z-20 border-l-8 ${style.border} hover:-translate-y-2 hover:-rotate-1 hover:shadow-2xl`}>
                        <div className="absolute inset-0 cover-texture-bg opacity-30"></div>
                        <div className="relative z-10 h-full flex flex-col items-center justify-center p-4 text-center"><div className="w-12 h-12 border-2 border-white/40 rounded-full flex items-center justify-center mb-4 shadow-sm"><Icons.Book className="text-white/90" /></div><h3 className="text-xl font-serif font-bold text-white drop-shadow-sm leading-tight break-words w-full">{album.title}</h3><div className="w-8 h-1 bg-white/40 my-3 rounded-full"></div><p className="text-[10px] text-white/70 uppercase tracking-widest">{Math.ceil(album.images.length / 2) * 2} Pages</p></div>
                        {isManageMode && (<div className="absolute top-2 right-2 bg-white/20 p-1.5 rounded-full backdrop-blur-sm"><Icons.Settings size={14} className="text-white" /></div>)}
                        
                        {/* ä¿®å¤ Issue 1: å°†åŸæ¥çš„ window.confirm æ›¿æ¢ä¸ºè°ƒç”¨è‡ªå®šä¹‰å¼¹çª—å‡½æ•° */}
                        {(isManageMode) && (
                            <button onClick={(e) => openDeleteConfirm(e, album)} className="absolute -top-3 -right-3 bg-white text-red-400 p-2 rounded-full shadow-lg hover:scale-110 hover:bg-red-50 transition-all z-50 border border-gray-100">
                                <Icons.Trash2 size={16} />
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        return (
            <div className="absolute inset-0 h-full w-full bg-[#fdf6ec] flex flex-col font-sans overflow-hidden touch-none">
                {/* ğŸŸ¢ LibraryView é¡¶éƒ¨å¯¼èˆªæ  (ç²¾è‡´ç˜¦èº«ç‰ˆï¼šé«˜åº¦ h-14ï¼Œå›¾æ ‡ size-16) */}
                <div className="h-14 pt-2 flex items-center justify-between px-4 sm:px-6 z-20 shrink-0">
                    
                    {/* å·¦ä¾§æ ‡é¢˜æ ï¼šå˜å° */}
                    <div className="bg-white/60 backdrop-blur-md px-3 py-1.5 rounded-full shadow-sm border border-white flex items-center gap-2">
                        <div className="bg-[#ffe4e1] p-1 rounded-full text-[#e5989b]">
                            <Icons.Library className="fill-current" size={16}/> 
                        </div>
                        <h1 className="text-sm font-bold text-gray-600 tracking-wide">My Library</h1> 
                    </div>

                    {/* å³ä¾§æŒ‰é’®ç»„ï¼šé—´è·ç¼©å°ï¼ŒæŒ‰é’®å˜è–„ */}
                    <div className="flex gap-2">
                         {/* About æŒ‰é’® */}
                         <button 
                            onClick={() => setIsAboutOpen(true)} 
                            className="bg-white/60 hover:bg-white text-gray-500 hover:text-orange-500 px-2.5 py-1.5 rounded-full font-bold shadow-sm transition-all active:scale-95 border border-white" 
                            title="About"
                        >
                            <Icons.Coffee size={16} /> 
                        </button>
                         
                         {/* Manage æŒ‰é’® */}
                         <button 
                            onClick={() => setIsManageMode(!isManageMode)} 
                            className={`px-3 py-1.5 rounded-full font-bold shadow-sm transition-all active:scale-95 flex items-center gap-1.5 border border-white text-xs ${isManageMode ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-white/60 text-gray-500 hover:text-blue-600 hover:bg-white'}`}
                        >
                            <Icons.Settings size={16} /> 
                            <span className="hidden sm:inline">{isManageMode ? 'Done' : 'Manage'}</span>
                        </button>
                         
                         {/* Backup æŒ‰é’® */}
                         <button 
                            onClick={onSaveBackup} 
                            className="bg-white/60 hover:bg-white text-gray-500 hover:text-teal-600 px-3 py-1.5 rounded-full font-bold shadow-sm transition-all active:scale-95 flex items-center gap-1.5 border border-white text-xs"
                        >
                            <Icons.Save size={16} /> 
                            <span className="hidden sm:inline">Backup</span>
                        </button>

                        {/* Import æŒ‰é’® */}
                        <label className="bg-white/60 hover:bg-white text-gray-500 hover:text-blue-600 px-3 py-1.5 rounded-full font-bold shadow-sm transition-all active:scale-95 flex items-center gap-1.5 border border-white text-xs cursor-pointer">
                            <Icons.Refresh size={16} /> 
                            <span className="hidden sm:inline">Import</span>
                            <input type="file" accept=".json" onChange={onRestoreBackup} className="hidden" />
                        </label>

                        {/* New æŒ‰é’® (åŠ å·) */}
                        <button 
                            onClick={openCreateModal} 
                            className="bg-gradient-to-r from-[#ffcfd2] to-[#f4acb7] text-white px-3 py-1.5 rounded-full font-bold shadow-lg shadow-pink-100 transition-transform active:scale-95 flex items-center gap-1.5 hover:brightness-105 text-xs"
                        >
                            <Icons.Plus size={16} /> 
                            New
                        </button>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto overflow-x-hidden pb-32 no-scrollbar"><div className="max-w-6xl mx-auto px-8 py-10"><div className="flex flex-wrap -mx-4 relative">{albums.map((album, idx) => (<React.Fragment key={album.id}>{renderAlbumCard(album, idx)}</React.Fragment>))}{Array.from({ length: Math.max(0, 4 - (albums.length % 4)) }).map((_, i) => (<div key={`empty-${i}`} className="w-full sm:w-1/2 md:w-1/3 lg:w-1/4 px-6 mb-16 shelf-row flex justify-center items-end h-[320px]"></div>))}</div></div></div>
{/* ğŸŸ¢ ç˜¦èº«ç‰ˆåˆ›å»º/ç¼–è¾‘å¼¹çª— (è¿›ä¸€æ­¥ç¼©å°20%) */}
{(isCreating || isEditing) && (
    <div className="absolute inset-0 bg-white/60 backdrop-blur-md z-50 flex items-center justify-center p-4 transition-all">
        {/* ä¿®æ”¹ï¼šmax-w-[260px] -> max-w-[200px], p-5 -> p-3, border-4 -> border-2 */}
        <div className="bg-white w-full max-w-[200px] rounded-[20px] p-3 shadow-2xl border-2 border-[#fff1f2] animate-float-gentle relative overflow-hidden">
            <div className="absolute -top-10 -right-10 w-20 h-20 bg-[#fff0f3] rounded-full blur-xl opacity-50"></div>
            <div className="absolute -bottom-10 -left-10 w-20 h-20 bg-[#e0f2fe] rounded-full blur-xl opacity-50"></div>
            
            {/* æ ‡é¢˜: text-lg -> text-base */}
            <h2 className="text-base font-extrabold mb-3 text-gray-700 text-center">{isEditing ? 'Edit Album' : 'New Journal'}</h2>
            
            <div className="mb-3">
                <label className="block text-gray-400 text-[9px] font-bold uppercase tracking-wider mb-1 ml-1">Title</label>
                {/* è¾“å…¥æ¡†: py-2 -> py-1.5, text-sm -> text-xs */}
                <input type="text" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} className="w-full bg-[#fafafa] border border-gray-100 rounded-lg px-2 py-1.5 text-gray-700 text-xs font-bold focus:outline-none focus:border-[#ffb7b2] focus:bg-white transition-colors" placeholder="Enter title..." maxLength={20} autoFocus/>
            </div>
            
            <div className="mb-4">
                <label className="block text-gray-400 text-[9px] font-bold uppercase tracking-wider mb-1.5 ml-1">Pick a Style</label>
                {/* é¢œè‰²çƒ: w-8 -> w-6 */}
                <div className="flex gap-1.5 justify-center flex-wrap max-h-24 overflow-y-auto p-1 no-scrollbar">
                    {COVER_STYLES.map(style => (
                        <button key={style.id} onClick={() => setSelectedStyle(style.id)} className={`w-6 h-6 rounded-full ${style.bgClass} transition-transform hover:scale-110 flex items-center justify-center relative overflow-hidden border ${style.border} ${selectedStyle === style.id ? 'scale-110 ring-2 ring-gray-100 shadow-md' : 'opacity-70 hover:opacity-100'}`}>
                            {selectedStyle === style.id && <Icons.Check size={10} className="text-white drop-shadow-md z-10"/>}
                            <div className="absolute inset-0 cover-texture-bg opacity-30"></div>
                        </button>
                    ))}
                </div>
            </div>
            
            <div className="flex gap-2">
                {/* æŒ‰é’®: py-2.5 -> py-1.5, text-xs -> text-[10px] */}
                <button onClick={() => { setIsCreating(false); setIsEditing(false); setEditingAlbum(null); }} className="flex-1 py-1.5 rounded-lg border border-gray-100 text-gray-400 font-bold hover:bg-gray-50 transition-colors text-[10px]">Cancel</button>
                <button onClick={isEditing ? handleEditSave : handleCreate} className="flex-1 py-1.5 rounded-lg bg-gradient-to-r from-[#ffcfd2] to-[#ffb7b2] text-white font-bold hover:shadow-lg hover:shadow-pink-100 transition-all active:scale-95 text-[10px]">{isEditing ? 'Save' : 'Create'}</button>
            </div>
        </div>
    </div>
)}


                <AboutModal isOpen={isAboutOpen} onClose={() => setIsAboutOpen(false)} />
                
                {/* ä¿®å¤ Issue 1: åœ¨ LibraryView æœ«å°¾æ¸²æŸ“è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤å¼¹çª— */}
                <ConfirmationModal 
                    isOpen={deleteConfirmState.isOpen} 
                    title="Delete Journal" 
                    message={`Are you sure you want to delete "${deleteConfirmState.albumTitle}"? This action cannot be undone.`}
                    confirmText="Delete"
                    onConfirm={handleActualDelete}
                    onCancel={closeDeleteConfirm}
                />
            </div>
        );
    }

        function App() {
        const [albums, setAlbums] = useState(() => window.APP_DATA || []);
        const [currentAlbum, setCurrentAlbum] = useState(null);
        const [dbLoaded, setDbLoaded] = useState(false);

        // ğŸŸ¢ æ–°å¢ï¼šä¸“é—¨æ§åˆ¶å¯¼å…¥å¼¹çª—çš„çŠ¶æ€
        const [importModal, setImportModal] = useState({ 
            isOpen: false, 
            title: "", 
            message: "", 
            isAlert: false, // true=åªæ˜¾ç¤ºç¡®å®š(ç”¨äºç»“æœæç¤º), false=æ˜¾ç¤ºç¡®å®š/å–æ¶ˆ(ç”¨äºè¯¢é—®)
            onConfirm: null 
        });

        useEffect(() => {
            const initLoad = async () => {
                try {
                    const savedData = await dbUtils.get('main-data');
                    if (savedData && Array.isArray(savedData) && savedData.length > 0) { setAlbums(savedData); }
                    setDbLoaded(true);
                } catch (e) { console.error("IDB Access Error:", e); setDbLoaded(true); }
            };
            initLoad();
        }, []);

        useEffect(() => {
            if (dbLoaded) {
                const saveData = async () => { try { await dbUtils.set('main-data', albums); } catch (e) { console.error("Auto-save failed:", e); } };
                saveData();
            }
        }, [albums, dbLoaded]);

        useEffect(() => {
            const handleBeforeUnload = (e) => { e.preventDefault(); e.returnValue = "Unsaved changes"; return "Unsaved changes"; };
            window.addEventListener('beforeunload', handleBeforeUnload);
            return () => { window.removeEventListener('beforeunload', handleBeforeUnload); };
        }, []);

        const handleOpenAlbum = (album) => { setCurrentAlbum(album); };
        const handleCreateAlbum = (title, style) => { const poem = BACK_COVER_POEMS[Math.floor(Math.random() * BACK_COVER_POEMS.length)]; const newAlbum = { id: Date.now(), title: title || 'Untitled', style: style, date: new Date().getFullYear().toString(), images: [], stickers: [], layout: {}, poem: poem }; setAlbums([...albums, newAlbum]); };

 // ä¿®æ”¹ handleUpdateAlbum å‚æ•°ç­¾å
const handleUpdateAlbum = (id, newImages, newStickers, newLayout, newBookmarks, newDoodles) => { 
    const updatedBookmarks = newBookmarks || currentAlbum.bookmarks || [];
    // ğŸŸ¢ å¤„ç† Doodles
    const updatedDoodles = newDoodles || currentAlbum.doodles || {};
    
    const updatedAlbum = { 
        ...currentAlbum, 
        images: newImages, 
        stickers: newStickers || [], 
        layout: newLayout || {},
        bookmarks: updatedBookmarks,
        doodles: updatedDoodles // ä¿å­˜æ¶‚é¸¦
    }; 
    setCurrentAlbum(updatedAlbum); 
    setAlbums(prev => prev.map(a => a.id === id ? updatedAlbum : a)); 
};


        const handleEditAlbum = (id, newTitle, newStyle) => { setAlbums(prev => prev.map(a => a.id === id ? { ...a, title: newTitle, style: newStyle } : a)); };
        const handleDeleteAlbum = (id) => { setAlbums(prev => prev.filter(a => a.id !== id)); };
        
        const handleSaveBackup = async () => {
    // 1. æ˜¾ç¤ºâ€œæ­£åœ¨æ‰“åŒ…â€æç¤ºï¼ˆå¯é€‰ï¼Œå› ä¸ºå¤§æ–‡ä»¶å¯èƒ½éœ€è¦å‡ ç§’ï¼‰
    // alert("Backing up... might take a few seconds.");

    // 2. ä½¿ç”¨æ–°å·¥å…·ç”ŸæˆåŒ…å«å®Œæ•´å›¾ç‰‡çš„ JSON
    const fullAlbums = await dbUtils.createBackupData();
    
    const backupData = { 
        version: "2.0", // å‡çº§ç‰ˆæœ¬å·
        date: new Date().toISOString(), 
        albums: fullAlbums // è¿™é‡Œé¢æ˜¯å¸¦ Base64 çš„å®Œæ•´æ•°æ®
    };
    
    const dataStr = JSON.stringify(backupData);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const date = new Date().toISOString().slice(0, 10);
    link.download = `PureJournal_Backup_${date}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};


        // --- ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šé€»è¾‘é‡æ„çš„å¯¼å…¥åŠŸèƒ½ ---

        // 1. è§¦å‘å™¨ï¼šå½“ç”¨æˆ·é€‰å¥½æ–‡ä»¶åè°ƒç”¨ï¼ˆä¸å¼¹çª—ï¼Œåªå­˜æ–‡ä»¶å¼•ç”¨å¹¶æ‰“å¼€ç¡®è®¤æ¡†ï¼‰
        const handleRestoreBackup = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // æ‰“å¼€è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— (UI 1: è¯¢é—®)
            setImportModal({
                isOpen: true,
                title: "Overwrite Data?",
                message: "Importing will PERMANENTLY REPLACE all your current journals and photos.\n\nAre you sure you want to continue?",
                isAlert: false, // æ˜¾ç¤º Confirm/Cancel æŒ‰é’®
                onConfirm: () => executeImport(file) // ç‚¹å‡» Confirm åæ‰§è¡ŒçœŸæ­£çš„å¯¼å…¥
            });
            
            e.target.value = ''; // é‡ç½® input ä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰åŒä¸€ä¸ªæ–‡ä»¶
        };

        // 2. æ‰§è¡Œå™¨ï¼šçœŸæ­£çš„è¯»å–å’Œè§£æé€»è¾‘
        const executeImport = (file) => {
    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const json = JSON.parse(event.target.result);
            if (json.albums && Array.isArray(json.albums)) {
                
                // âœ¨ ä½¿ç”¨æ–°å·¥å…·ï¼šå¯¼å…¥æ—¶è‡ªåŠ¨â€œç˜¦èº«â€ï¼Œå›¾ç‰‡å­˜åº“ï¼ŒStateåªç•™ID
                // è¿™æ­¥å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œæœ€å¥½åŠ ä¸ª Loading çŠ¶æ€
                const slimAlbums = await dbUtils.restoreBackupData(json.albums);
                
                setAlbums(slimAlbums);
                // è¿™é‡Œä¸éœ€è¦å†æ‰‹åŠ¨ set('main-data')ï¼Œå› ä¸º restoreBackupData é‡Œå·²ç»å­˜åº“äº†
                // ä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ–è€…è§¦å‘æ›´æ–°ï¼Œå¯ä»¥ä¿æŒ setAlbums
                
                setImportModal({
                    isOpen: true,
                    title: "Import Successful",
                    message: "Your memories have been restored and optimized! âœ¨",
                    isAlert: true,
                    confirmText: "Awesome!",
                    onConfirm: () => setImportModal({ ...importModal, isOpen: false })
                });
            } else {
                throw new Error("Format Invalid");
            }
        } catch (err) {
            console.error(err);
            setImportModal({
                isOpen: true,
                title: "Import Failed",
                message: "Invalid backup file.",
                isAlert: true,
                confirmText: "Okay",
                onConfirm: () => setImportModal({ ...importModal, isOpen: false })
            });
        }
    };
    reader.readAsText(file);
};


        return (
            <div className="relative w-full h-full overflow-hidden">
                <svg style={{ position: 'absolute', width: 0, height: 0, pointerEvents: 'none', zIndex: -9999 }}>
                    <defs>
                        <filter id="ink-grunge" x="-20%" y="-20%" width="140%" height="140%">
                            <feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="3" result="noise" />
                            <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 15 -7" in="noise" result="coloredNoise" />
                            <feComposite operator="in" in="SourceGraphic" in2="coloredNoise" result="composite" />
                        </filter>
                    </defs>
                </svg>
                
                <LibraryView 
                    albums={albums} 
                    onOpenAlbum={handleOpenAlbum} 
                    onCreateAlbum={handleCreateAlbum} 
                    onDeleteAlbum={handleDeleteAlbum} 
                    onSaveBackup={handleSaveBackup} 
                    onEditAlbum={handleEditAlbum} 
                    onRestoreBackup={handleRestoreBackup} 
                />
                
                {currentAlbum && (<BookView album={currentAlbum} onBack={() => setCurrentAlbum(null)} onUpdateAlbum={handleUpdateAlbum} />)}

                {/* ğŸŸ¢ æ–°å¢ï¼šå…¨å±€å¯¼å…¥ç¡®è®¤å¼¹çª— (æ¸²æŸ“åœ¨ App æ ¹èŠ‚ç‚¹ï¼Œè¦†ç›–ä¸€åˆ‡) */}
                <ConfirmationModal 
                    isOpen={importModal.isOpen}
                    title={importModal.title}
                    message={importModal.message}
                    confirmText={importModal.confirmText || "Confirm"}
                    isAlert={importModal.isAlert}
                    onConfirm={importModal.onConfirm}
                    onCancel={() => setImportModal({ ...importModal, isOpen: false })}
                />
            </div>
        );
    }


    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>
